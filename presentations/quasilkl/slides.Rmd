---
title: "QUASI-LIKELIHOOD FUNCTIONS"
subtitle: By Peter McCullagh, 1983
author: Henrique Laureano ([.github.io](https://henriquelaureano.github.io))
date: July 23, 2021
institute: LEG @ UFPR
classoption: [aspectratio=169]
output:
  beamer_presentation:
    includes:
      in_header: beamerheader.txt
---

###

\begin{columns}
 \column{3cm}
  \includegraphics[height=3cm]{logo/mccullagh_old.jpg}
 \column{12cm}
  \includegraphics[height=4.5cm]{
   logo/quasi_likelihood_functions-cover.png}
\end{columns}

\bigskip
\begin{columns}
 \column{3cm}
  \includegraphics[height=3cm]{logo/mccullagh_now.jpg}
 \column{12cm}
  \begin{enumerate}
   \item Distinguished Professor\\
         in the Department of Statistics @ University of Chicago;
   \vspace{0.15cm}
   \item Completed his PhD at Imperial College London,\\
         supervised by David Cox and Anthony Atkinson;
   \vspace{0.15cm}
   \item Also at Imperial College London,\\
         was the PhD supervisor of Gauss Cordeiro.
  \end{enumerate}
\end{columns}

# Introduction

### Introduction

\vspace{-0.1cm}
1. Likelihood fucntion with \textbf{exponential family form}\newline
   \hspace*{0.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
   MLE through \textbf{weighted least squares}

   - \textbf{variance (assumed) constant}:
     we minimize a sum of squared residuals;
   
   - \textbf{variance not constant}:\newline
     estimating equations can be thought as a generalization of the
     scoring method.

2. Likelihood function \textcolor{AlertOrange}{without} exponential
   family form\newline
   \hspace*{0.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
   In some cases: weighted least squares\newline
   \hspace*{1cm}\rotatebox[origin=c]{180}{$\Lsh$}
   Jorgensen, B. (1983). Maximum likelihood estimation and large sample
                         \newline
                         \hspace*{5.05cm}
                         inference for generalized linear and non-linear
                         \newline
                         \hspace*{5.05cm}
                         regression models. \textit{Biometrika} 70

\vspace{-0.1cm}
\begin{minipage}{14cm}
\begin{block}{Paper purposes}
 \begin{enumerate}
  \item Maximize the likelihood function through weighted least squares
        \newline
        \hspace*{.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
        In which class of problems;
  \item Weighted least squares under 2nd moment assumptions
        (\textbf{quasi-likelihood}).
 \end{enumerate}
\end{block}
\end{minipage}

# A class of likelihood functions

### A class of likelihood functions

\[
 \text{Log likelihood written in the form}: \qquad
 \sigma^{-2}\{\mathbf{y}^{\top}\bm{\theta} -
              \mathbf{b}(\bm{\theta}) - \mathbf{c}(\mathbf{y}, \sigma)\}
\]

\begin{center}
 \begin{minipage}{12.25cm}
  \begin{block}{The first two cumulants}
   By differentiating it and assuming that the support does not depend
   on \(\bm{\theta}\)\newline
   \hspace*{.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
   \(E(\mathbf{Y}) = \bm{\mu} = \mathbf{b}^{'}(\bm{\theta})\) and
   \(\text{Cov}(\mathbf{Y}) = \sigma^{2}\mathbf{b}^{''}(\bm{\theta})
                            = \sigma^{2}\mathbf{V}(\bm{\mu})\).
  \end{block}
 \end{minipage}
\end{center}

\bigskip
\begin{description}
 \item[In fact,] the \(r\)th order cumulants of \(\mathbf{Y}\) are given
                by \(\kappa_{r} = \sigma^{2r-2}
                                  \mathbf{b}^{(r)}(\bm{\theta})\).
\end{description}

\bigskip
\begin{enumerate}
 \item The first two cumulants describe the random component of the
       model;
 \item However, in applications it is usually the systematic or
       nonrandom variation that is of primary importance\newline
       \hspace*{0.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
       \(E(\mathbf{Y}) = \bm{\mu} = \bm{\mu}(\bm{\beta})\) or
       \(E\{(\mathbf{h}(\mathbf{Y}))\} = \bm{\psi}(\bm{\beta})\)
       (implicitly involving \(\sigma^{2}\)).
\end{enumerate}

### A class of likelihood functions

\begin{description}
 \item[If \(\sigma^{2}\) is known,] log-likelihood is an exponential
                                    family\newline
  \hspace*{0.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
  variance and all higher order cumulants of \(\mathbf{Y}\) are\newline
  \hspace*{0.82cm}functions of the mean vector alone\newline
  \hspace*{1cm}\rotatebox[origin=c]{180}{$\Lsh$}
  exponential, Poisson, multinomial, noncentral hypergeometric\newline
  \hspace*{1.31cm}and partial likelihoods (survival analysis)\newline
  \hspace*{1.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
  MLE of \(\bm{\beta}\) through weighted least squares\newline
  \hspace*{2cm}\rotatebox[origin=c]{180}{$\Lsh$}
  \(\bm{\mu}\) and \(\sigma^{2}\) are orthogonal\newline
  \hspace*{2.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
  \(\bm{\beta}\) and \(\sigma^{2}\) also orthogonal;
 \item[If \(\sigma^{2}\) is unknown,] log-likelihood is
\end{description}

Frailty-based models for (\textcolor{UniBlue}{multiple}) survival
experiences turn out in challengeable likelihood functions with
inference routines mostly done via

\begin{columns}
 \column{8cm}
  \begin{itemize}
   \item Elaborated and slow expectationâ€“maximization (EM)
         algorithms;
  \end{itemize}
 \column{6cm}
  \begin{itemize}
   \item Inefficient Markov chain Monte Carlo (MCMC) schemes.
  \end{itemize}
\end{columns}

### Probability scale \(\rightarrow\) Cause-specific CIF

\begin{block}{}
\[
 \text{i.e.},\quad
 \text{CIF} =
 \mathbb{P}[~\text{failure time} \leq t,
            ~\text{a given cause} \mid \text{features \& latent effects}
            ~].
\]
\end{block}

Common applications: \textit{\textcolor{UniBlue}{family studies}}.
\newline
\hspace*{.5cm}\rotatebox[origin=c]{180}{$\color{UniBlue}{\Lsh}$}
Keywords:
*within-family/cluster dependence*;
*age at disease onset*;
*populations*.

### Formally,

for a cause-specific of failure \(k\),\newline
the cumulative incidence function (CIF) is defined as
\begin{block}{}
\vspace{-0.5cm}
\begin{align*}
 F_{k}(t \mid \bm{x})
 &= \mathbb{P}[T \leq t,~K = k \mid \bm{x}]\\
 &= \int_{0}^{t} f_{k}(z \mid \bm{x})~\text{d}z\quad
 (f_{k}(t \mid \bm{x})
 ~\text{is the (sub)density for the time to a type}~k~\text{failure})\\
 &= \int_{0}^{t}
 \underbrace{\lambda_{k}(z \mid \bm{x})}_{\substack{
                                           \text{cause-specific}\\
                                           \text{hazard function}}}
 \underbrace{S(z \mid \bm{x})}_{\substack{\text{overall}\\
                                          \text{survival}\\
                                          \text{function}}}
 \text{d}z, \quad t > 0, \quad k = 1,~\dots,~K.
\end{align*}
\end{block}

\includegraphics[height=0.5cm]{logo/book.png}
Again, a comprehensive reference is @kalb&prentice's book.

\includegraphics[height=0.5cm]{logo/lightbulb.jpg}
\textit{Here}, we use the same CIF specification of @SCHEIKE.

### SCHEIKE's CIF specification

For two competing causes of failure,\newline
the cause-specific CIFs are specified in the following manner
\begin{block}{}
\vspace{-0.5cm}
\begin{equation}
 F_{k} (t \mid \bm{x},~u_{1},~u_{2},~\eta_{k}) =
 \underbrace{\pi_{k}(\bm{x},~u_{1},~u_{2})}_{
 \substack{\text{cluster-specific}\\\text{risk level}}}\times
  \underbrace{\Phi[w_{k} g(t) - \bm{x}\bm{\gamma}_{k} - \eta_{k}]}_{
   \substack{\text{cluster-specific}\\\text{failure time trajectory}}
  }, \quad t > 0, \quad k = 1,~2,
  \label{eq:cif}
\end{equation}
\end{block}

with

1. \(\pi_{k}(\bm{x}, \bm{u}) =
     \exp\{\bm{x}\bm{\beta}_{k} + u_{k}\} \Big/
     \left(1 + \sum_{m=1}^{K-1} \exp\{\bm{x}\bm{\beta}_{m} + u_{m}\}
     \right),
     \quad k = 1,~2, \quad K = 3;\)

2. \(\Phi(\cdot)\) is the cumulative distribution function of a standard
   Gaussian distribution;

3. \(g(t) = \text{arctanh}(2t/\delta - 1),
     \quad t\in(0,~\delta), \quad g(t)\in(-\infty,~\infty).\)

\includegraphics[height=0.5cm]{logo/book.png}
In @SCHEIKE, this CIF specification is modeled under a
*challengeable* pairwise composite likelihood approach
[@lindsay88; @varin11].

### Our contribution: a full likelihood analysis

\vspace{-0.3cm}
For two competing causes of failure, a subject \(i\), in the cluster
\(j\), in time \(t\), we have
\begin{block}{}
\vspace{-0.5cm}
\begin{equation}
 \begin{aligned}
  y_{ijt} \mid
  \underbrace{\{u_{1j}, u_{2j}, \eta_{1j}, \eta_{2j}\}}_{
  \substack{\text{\color{UniBlue}{latent effects}}}
  } & \sim
  \text{Multinomial}(p_{1ijt}, p_{2ijt}, p_{3ijt})\\
  \begin{bmatrix} u_{1}\\ u_{2}\\ \eta_{1}\\ \eta_{2} \end{bmatrix}
  & \sim
  \parbox{2cm}{\centering Multivariate Normal}
  \left(
   \begin{bmatrix} 0\\ 0\\ 0\\ 0 \end{bmatrix},
   \begin{bmatrix}
    \sigma_{u_{1}}^{2}&
    \text{cov}(u_{1}, u_{2})&
    \text{cov}(u_{1}, \eta_{1})&\text{cov}(u_{1}, \eta_{2})\\
    &\sigma_{u_{2}}^{2}&
    \text{cov}(u_{2}, \eta_{1})&\text{cov}(u_{2}, \eta_{2})\\
    &&\sigma_{\eta_{1}}^{2}&\text{cov}(\eta_{1}, \eta_{2})\\
    &&&\sigma_{\eta_{2}}^{2}
   \end{bmatrix}
  \right)\\  
  p_{ {\color{UniBlue}{k}} ijt} &=
  \frac{\partial}{\partial t}
  F_{\color{UniBlue}{k}}
  (t \mid \bm{x}, \bm{u}, \eta_{\color{UniBlue}{k}})\label{eq:model}\\
  &= \frac{\exp\{\bm{x}_{ {\color{UniBlue}{k}} ij}
                 \bm{\beta}_{\color{UniBlue}{k}} +
                 u_{ {\color{UniBlue}{k}} j}\}}{
  1 + \sum_{ {\color{UniBlue}{m}}=1}^{K-1}
      \exp\{\bm{x}_{ {\color{UniBlue}{m}} ij}
            \bm{\beta}_{\color{UniBlue}{m}} +
            u_{ {\color{UniBlue}{m}} j}\}}\\
  &\times w_{\color{UniBlue}{k}}\frac{\delta}{2\delta t - 2t^{2}}~
  \phi\left(
   w_{\color{UniBlue}{k}}
   \text{arctanh}\left(\frac{t-\delta/2}{\delta/2}\right)
   - \bm{x}_{ {\color{UniBlue}{k}} ij}
     \bm{\gamma}_{\color{UniBlue}{k}} -
     \eta_{ {\color{UniBlue}{k}} j}
  \right), \quad {\color{UniBlue}{k}} = 1,~2.
 \end{aligned}
\end{equation}
\end{block}

### Simulating from the model

### Marginal likelihood function for two competing causes

\vspace{-0.75cm}
\begin{align}
 L(\bm{\theta}; y)
 &= \prod_{j=1}^{J}~\int_{\Re^{4}}
    \pi(y_{j} \mid \bm{r}_{j})\times\pi(\bm{r}_{j})~\text{d}\bm{r}_{j}
    \nonumber\\
 &= \prod_{j=1}^{J}~\int_{\Re^{4}}
    \Bigg\{
    \underbrace{\prod_{i=1}^{n_{j}}~\prod_{t=1}^{n_{ij}}
    \Bigg(
    \frac{(\sum_{k=1}^{K}y_{kijt})!}{y_{1ijt}!~y_{2ijt}!~y_{3ijt}!}~
    \prod_{k=1}^{K} p_{kijt}^{y_{kijt}}
    \Bigg)}_{\substack{\text{\color{UniBlue}{fixed effect component}}}}
  \Bigg\}\times\nonumber\\
 &\hspace{2cm}\underbrace{
   (2\pi)^{-2} |\Sigma|^{-1/2} \exp
   \left\{-\frac{1}{2}\bm{r}_{j}^{\top} \Sigma^{-1} \bm{r}_{j}\right\}
   }_{\substack{\text{\color{UniBlue}{latent effect component}}}}
   \text{d}\bm{r}_{j}\nonumber\\
 &= \prod_{j=1}^{J}~\int_{\Re^{4}}
    \Bigg\{
    \underbrace{\prod_{i=1}^{n_{j}}~\prod_{t=1}^{n_{ij}}
    \prod_{k=1}^{K} p_{kijt}^{y_{kijt}}
    }_{\substack{\color{UniBlue}{\text{fixed effect}}}}
   \Bigg\}\underbrace{
   (2\pi)^{-2} |\Sigma|^{-1/2} \exp
   \left\{-\frac{1}{2}\bm{r}_{j}^{\top} \Sigma^{-1} \bm{r}_{j}\right\}
   }_{\substack{\color{UniBlue}{\text{latent effect component}}}}
   \text{d}\bm{r}_{j}\label{eq:loglik},
\end{align}
with \(p_{kijt}\) from Equation \ref{eq:model} and where \(\bm{\theta} =
[\bm{\beta}~\bm{\gamma}~\bm{w}~\bm{\sigma^{2}}~ \bm{\rho}]^{\top}\) is
the parameters vector.

# Quasi-likelihood functions

### TMB: Automatic Differentiation and Laplace Approximation

\includegraphics[height=0.5cm]{logo/book.png}
@TMB.

\bigskip
> An R [@R21] package for the quickly implementation of complex random
> effect models through simple C++ templates.

\begin{block}{Workflow}
 \begin{enumerate}
  \item Write your objective function in a \texttt{.cpp} through a
        \texttt{\#include <TMB.hpp>};

  \vspace{0.15cm}
  \item Compile and load it in R via \texttt{TMB::compile()} and
        \texttt{base::dyn.load(TMB::dynlib())};

  \vspace{0.15cm}
  \item Compute your objective function derivatives with
        \texttt{obj <- TMB::MakeADFun()};

  \vspace{0.15cm}
  \item Perform the model fitting,
        \texttt{opt <- base::nlminb(obj\$par, obj\$fn, obj\$gr)};

  \vspace{0.15cm}
  \item Compute the parameters standard deviations,
        \texttt{TMB::sdreport(obj)}.
 \end{enumerate}
\end{block}

\includegraphics[height=0.5cm]{logo/book.png}
For details about TMB, AD, and Laplace approximation: @laurence.

# Properties of quasi-likelihood functions

### Simulation study model designs

\begin{columns}
 \column{5.75cm}
  \begin{block}{Risk model}
   Latent effects only on the risk level i.e.,
   \[
    \Sigma = \begin{bmatrix}
              \sigma_{u_{1}}^{2} & \text{cov}_{u_{1}, u_{2}}\\
                                 & \sigma_{u_{2}}^{2}
             \end{bmatrix}.
   \]
  \end{block}
 \column{5.75cm}
  \begin{block}{Time model}
   Latent effects only on the failure time trajectory level i.e.,
   \[
    \Sigma = \begin{bmatrix}
              \sigma_{\eta_{1}}^{2} & \text{cov}_{\eta_{1}, \eta_{2}}\\
                                    & \sigma_{\eta_{2}}^{2}
              \end{bmatrix}.
   \]
  \end{block}
\end{columns}

\begin{columns}
 \column{7cm}
  \begin{block}{Block-diag model}
   Latent effects on the risk and time levels without cross-correlations
   i.e.,
   \[
    \Sigma = \begin{bmatrix}
              \sigma_{u_{1}}^{2} & \text{cov}_{u_{1}, u_{2}} & 0 & 0\\
              & \sigma_{u_{2}}^{2} & 0 & 0\\
              & & \sigma_{\eta_{1}}^{2} & \text{cov}_{\eta_{1}, \eta_{2}}\\
              & & & \sigma_{\eta_{2}}^{2}
             \end{bmatrix}.
   \]
  \end{block}
 \column{7cm}
  \begin{block}{Complete model}
   A \textit{complete} latent effects structure\newline
   i.e.,
   \[
    \Sigma = \begin{bmatrix}
              \sigma_{u_{1}}^{2} &
              \text{cov}_{u_{1}, u_{2}} &
              \text{cov}_{u_{1}, \eta_{1}} & \text{cov}_{u_{1}, \eta_{2}}\\
              & \sigma_{u_{2}}^{2} &
              \text{cov}_{u_{2}, \eta_{1}} & \text{cov}_{u_{2}, \eta_{2}}\\
              & & \sigma_{\eta_{1}}^{2} & \text{cov}_{\eta_{1}, \eta_{2}}\\
              & & & \sigma_{\eta_{2}}^{2}
              \end{bmatrix}.
   \]
  \end{block}
\end{columns}

### Simulation study setup

\vspace{-0.3cm}
\begin{description}
 \item[Four] latent effects structures:
  \begin{multicols}{4}
   \begin{enumerate}
    \item Risk model;
    \item Time model;
    \item Block-diag model;
    \item Complete model.
   \end{enumerate}
  \end{multicols}
 \vspace{-0.6cm}
 \item[Two] CIF configurations:
  \begin{multicols}{2}
   \begin{description}
    \item[Low] max incidence \(\approx 0.15\);
    \item[High] max incidence \(\approx 0.60\).
   \end{description}
  \end{multicols}
\end{description}

\vspace{-0.3cm}
For each of those \({\color{UniBlue}{\bm{4}}} \times
{\color{UniBlue}{\bm{2}}} = {\color{UniBlue}{\bm{8}}}\) scenarios, we
vary the sample and cluster sizes:

\vspace{-0.2cm}
\begin{columns}
 \column{5cm}
  \begin{align*}
   &\textbf{\textit{\color{UniBlue}{5000 data points}}}\\
   \bullet~&\text{2500 clusters of}~\textbf{\color{UniBlue}{size 2}};\\
   \bullet~&\text{1000 clusters of}~\textbf{\color{UniBlue}{size 5}};\\
   \bullet~&\text{500 clusters of}~\textbf{\color{UniBlue}{size 10}}.
  \end{align*}
 \column{5cm}
  \begin{align*}
   &\textbf{\textit{\color{UniBlue}{30000 data points}}}\\
   \bullet~&\text{15000 clusters of}~\textbf{\color{UniBlue}{size 2}};\\
   \bullet~&\text{6000 clusters of}~\textbf{\color{UniBlue}{size 5}};\\
   \bullet~&\text{3000 clusters of}~\textbf{\color{UniBlue}{size 10}}.
  \end{align*}
 \column{5cm}
  \begin{align*}
   &\textbf{\textit{\color{UniBlue}{60000 data points}}}\\
   \bullet~&\text{30000 clusters of}~\textbf{\color{UniBlue}{size 2}};\\
   \bullet~&\text{12000 clusters of}~\textbf{\color{UniBlue}{size 5}};\\
   \bullet~&\text{6000 clusters of}~\textbf{\color{UniBlue}{size 10}}.
  \end{align*}
\end{columns}

\vspace{-0.1cm}
\begin{block}{}
Totalizing, \({\color{UniBlue}{\bm{8}}} \times {\color{UniBlue}{\bm{3}}}
\times {\color{UniBlue}{\bm{3}}} = {\color{UniBlue}{\bm{72}}}\)
scenarios.\newline
For each scenario, we simulate \(\color{UniBlue}{\bm{500}}\) samples,
totalizing \({\color{UniBlue}{\bm{72}}} \times
{\color{UniBlue}{\bm{500}}} = {\color{UniBlue}{\bm{36000}}}\) model
fittings.
\end{block}

### Simulation study results

First of all, the **time**.

+ The *non-complete* models (2D Laplace aprox.) are kind of fast,\newline
  taking always **less than 5 min**.

+ In the most expensive scenarios (30K 4D Laplaces),\newline
  **the complete model takes 30 min**.\newline
  In a **full R** implementation with 10K 4D Laplaces, it **took
  30hrs**. \textcolor{UniBlue}{\textbf{TMB is fast}}.
 
+ We also did a Bayesian analysis via Stan/NUTS-HMC [@RStan].

  - **1 week of parallelized processing** for a 2500 size 2 clusters
    scenario with tuned NUTS. This just reinforces the MCMC
    impracticability for some complex models.

**Parameters estimation**.

+ The *non-complete* models fail to learn the data.\newline
  They appear to be *not structured enough* to capture the data
  characteristics.

# Estimation of \(\sigma^{2}\)

# Examples of quasi-likelihood functions

# A higher order theory

### Take-home message

\vspace{-0.55cm}
\begin{minipage}{13cm}
 \begin{block}{}
  \textbf{The complete model works}. It's not magnificent, but it works.
  \vspace{0.2cm}
  \begin{enumerate}
   \item It works better in the high CIF scenarios;
   \vspace{0.15cm}
   \item As expected, as the sample size increases the results get
         better;
   \vspace{0.15cm}
   \item We do not see any considerable performance difference between
         cluster/family sizes;
   \vspace{0.15cm}
   \item Satisfactory full likelihood analysis under the maximum
         likelihood estimation framework (the estimates bias-variance
         could be smaller).
   \end{enumerate}
 \end{block}
\end{minipage}
\vspace{0.1cm}
What else can we do?

1. Instead of a conditional approach (latent effects model),\newline
   we can try a marginal approach e.g., an McGLM [@mcglm];

2. We can also try a copula [@copulas], on maybe two fronts:\newline 1)
   for a full specification; 2) to accommodate the within-cluster
   dependence.

\includegraphics[height=0.5cm]{logo/book.png}
For more read @laurence master thesis.

### Thanks for watching and have a great day

\vspace{0.5cm}
Special thanks to

\bigskip
\begin{columns}
 \column{1.5cm}
  \centering\includegraphics{logo/ppgmne-logo.png}
 \column{13.75cm}
  {\large \textbf{PPGMNE}}\newline
  Programa de PÃ³s-GraduaÃ§Ã£o em\newline
  MÃ©todos NumÃ©ricos em Engenharia
\end{columns}

\bigskip
\begin{columns}
 \column{2cm}
  \includegraphics[height=2cm]{logo/capes.jpg}
 \column{3cm}
  \includegraphics[height=2cm]{logo/ufpr.png}
 \column{4.5cm}
  Joint work with
  \vspace{0.2cm}\newline
  Wagner H. Bonat\newline
  \url{http://leg.ufpr.br/~wagner}
 \column{4.75cm}
  \textcolor{white}{Joint work with}
  \vspace{0.2cm}\newline
  Paulo Justiniano Ribeiro Jr.\newline
  \url{http://leg.ufpr.br/~paulojus}
\end{columns}

\vspace{1.5cm}
\begin{columns}
 \column{10cm}
 \column{5cm}
  \includegraphics[height=0.3cm,angle=90]{../../laurence.jpg}
  \hspace{0.05cm}
  \href{https://henriquelaureano.github.io}{henriquelaureano.github.io}
\end{columns}

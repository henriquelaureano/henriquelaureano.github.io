---
title: "HPP: COVID-19"
author: "Ana Paula Pacheco, Carolina Prando e 
         [Henrique Laureano](https://henriquelaureano.github.io/)"
date: "*Last modification on* `r Sys.time()`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r, echo=FALSE}

if (!requireNamespace('knitr', quietly=TRUE)) install.packages('knitr')
library(knitr)
options(width=100)
knitr::opts_chunk$set(fig.path='figuras_1030casos/',
                      fig.align='center',
                      ## dev=c('pdf', 'png'),
                      warning=FALSE, message=FALSE, prompt=FALSE,
                      echo=FALSE, comment=NA)

```

***

```{r pkgs}

if (!requireNamespace('pacman', quietly=TRUE)) install.packages('pacman')

pacman::p_load(readxl, dplyr, tidyr, forcats, lubridate, ggplot2,
               patchwork, geobr, ggspatial, psych, ggalluvial)

## library(devtools)
## devtools::install_github('ipeaGIT/geobr', subdir='r-package')
## library(geobr)

source(
    '../../henriquelaureano.github.io/i4p-colors/i4p-palette.R'
)
unique_color <- '#3e4989ff'

```

```{r dat}

dat <- readxl::read_xlsx('Análise estatística.xlsx',
                         sheet='Todos',
                         range='A1:CA1031')|>
    dplyr::filter(!CÓDIGO %in% c('HPP 0334', 'HPP 0546'))

```

```{r functions}

stringtable <- function(x)
{
    cbind(c('Total', 'Percentual'), 
          rbind(table(x), 
                paste0(round(100*prop.table(table(x)), 3), '%')))
}

chisquare <- function(datvar)
{
    names(datvar) <- 'var'
    out <- datvar|>
        dplyr::count(var)|>
        tidyr::spread(var, n)|>
        chisq.test()
    return(out$p.value)
}

```

# Carga Viral

***

```{r}

dat <- dat|>
    dplyr::mutate(
               `CARGA VIRAL`=forcats::fct_collapse(
                                          `CARGA VIRAL`,
                                          Alta =c('alta', 'ALTA'),
                                          Baixa=c('baixa', 'BAIXA'),
                                          Média=c('média', 'MÉDIA')
                                      ))

stringtable(dat$`CARGA VIRAL`)

dat|>
    dplyr::filter(`CARGA VIRAL` %in% c('Alta', 'Baixa', 'Média'))|>
    dplyr::select(`CARGA VIRAL`)|>
    chisquare()

```

> p-valor altamente significativo indicando diferença significativa
> entre as frequências de carga viral alta, média e baixa.

# Classificação

***

```{r}

stringtable(dat$CLASSIF)

```

# Sexo

***

```{r}

dat <- dat|>
    dplyr::mutate(Sexo=forcats::fct_collapse(Sexo, M=c('m', 'M')),
                  Sexo=dplyr::recode(Sexo,
                                     'F'='Feminino', 'M'='Masculino'))

stringtable(dat$Sexo)

dat|>
    dplyr::select(Sexo)|>
    chisquare()

```

> p-valor significativo indicando diferença significativa entre as
> frequências de meninas e meninos com COVID-!9.

# Etnia

***

```{r}

dat <- dat|>
    dplyr::mutate(Etnia=forcats::fct_collapse(Etnia,
                                              Parda=c('Parda',
                                                      'PARDA')))

stringtable(dat$Etnia)

```

# Idade

***

```{r idade}

dat <- dat|>
    dplyr::mutate(IDADE=(`DATA PARA CÁLCULO IDADE` - DN)/
                      lubridate::dyears())

dat|>
    dplyr::summarise(Mínimo       =min(IDADE),
                     '1o.quantil' =quantile(IDADE, 0.25), 
                     Mediana      =median(IDADE),
                     '3o.quantil' =quantile(IDADE, 0.75), 
                     Máximo       =max(IDADE), 
                     Media        =mean(IDADE),
                     Desvio.Padrão=sd(IDADE))

```

```{r piramide_etaria,fig.width=10,fig.height=5.5}

dat <- dat|>
    dplyr::mutate(IDADEcat=cut(IDADE,
                               breaks=0:18,
                               include.lowest=TRUE),
                  IDADEcat2=cut(IDADE,
                                breaks=c(0, 1, 2, 4, 10, 18),
                                include.lowest=TRUE),
                  IDADEcat3=cut(IDADE,
                                breaks=c(0, 2, 10, 18),
                                include.lowest=TRUE))

idadef <- dat|>
    dplyr::filter(Sexo=='Feminino')|>
    ggplot(aes(x=IDADEcat))+
    geom_bar(fill=i4p_colors['yellow'], alpha=0.75)+
    geom_text(stat='count',
              aes(label=paste0(..count..,
                               ' (', 100*round(..count../1028, 3), '%)'
                               )),
              hjust=1.1, fontface='bold')+
    scale_y_continuous(trans='reverse', limits=c(110, 0), breaks=NULL)+
    labs(x=NULL, y=NULL, title='Age pyramid:', subtitle='Female')+
    theme_minimal(base_size=14)+
    theme(axis.text.y  =element_blank(), 
          plot.margin  =margin(t=1, r=0, b=1, l=1, unit='lines'),
          plot.title   =element_text(hjust=1, face='bold'), 
          plot.subtitle=element_text(hjust=1, face='bold'))+
    coord_flip()

idadem <- dat|>
    dplyr::filter(Sexo=='Masculino')|>
    ggplot(aes(x=IDADEcat))+
    geom_bar(fill=i4p_1c, alpha=0.75)+
    geom_text(stat='count',
              aes(label=paste0(..count..,
                               ' (', 100*round(..count../1028, 3), '%)'
                               )),
              hjust=-0.1, fontface='bold')+
    scale_y_continuous(limits=c(0, 110), breaks=NULL)+
    labs(x=NULL, y=NULL, title='1028 cases', subtitle='Male')+
    theme_minimal(base_size=14)+
    theme(axis.text.y  =element_text(hjust=0.5, face='bold'),
          plot.margin  =margin(t=1, r=1, b=1, l=0, unit='lines'),
          plot.title   =element_text(face='bold'), 
          plot.subtitle=element_text(face='bold'))+
    coord_flip()

idadef + idadem

dat|>
    dplyr::group_by(Sexo)|>
    dplyr::summarise(Mínimo       =min(IDADE),
                     '1o.quantil' =quantile(IDADE, 0.25), 
                     Mediana      =median(IDADE),
                     '3o.quantil' =quantile(IDADE, 0.75), 
                     Máximo       =max(IDADE), 
                     Media        =mean(IDADE),
                     Desvio.Padrão=sd(IDADE))

t.test(
    dplyr::filter(dat, Sexo ==  'Feminino')|>dplyr::pull(IDADE), 
    dplyr::filter(dat, Sexo == 'Masculino')|>dplyr::pull(IDADE)
)$p.value

```

> Diferença média das idades por sexo não difere significativamente.

```{r piramide_etaria_2,fig.width=10,fig.height=2.5}

idadef <- dat|>
    dplyr::filter(Sexo=='Feminino')|>
    ggplot(aes(x=IDADEcat2))+
    geom_bar(fill=i4p_colors['yellow'], alpha=0.75)+
    geom_text(stat='count',
              aes(label=paste0(..count..,
                               ' (', 100*round(..count../1028, 3), '%)'
                               )),
              hjust=1.1, fontface='bold')+
    scale_y_continuous(trans='reverse', limits=c(210, 0), breaks=NULL)+
    labs(x=NULL, y=NULL, title='Age pyramid:', subtitle='Female')+
    theme_minimal(base_size=14)+
    theme(axis.text.y  =element_blank(), 
          plot.margin  =margin(t=1, r=0, b=1, l=1, unit='lines'),
          plot.title   =element_text(hjust=1, face='bold'), 
          plot.subtitle=element_text(hjust=1, face='bold'))+
    coord_flip()

idadem <- dat|>
    dplyr::filter(Sexo=='Masculino')|>
    ggplot(aes(x=IDADEcat2))+
    geom_bar(fill=i4p_1c, alpha=0.75)+
    geom_text(stat='count',
              aes(label=paste0(..count..,
                               ' (', 100*round(..count../1028, 3), '%)'
                               )),
              hjust=-0.1, fontface='bold')+
    scale_y_continuous(limits=c(0, 210), breaks=NULL)+
    labs(x=NULL, y=NULL, title='1028 cases', subtitle='Male')+
    theme_minimal(base_size=14)+
    theme(axis.text.y  =element_text(hjust=0.5, face='bold'),
          plot.margin  =margin(t=1, r=1, b=1, l=0, unit='lines'),
          plot.title   =element_text(face='bold'), 
          plot.subtitle=element_text(face='bold'))+
    coord_flip()

idadef + idadem

```

```{r piramide_etaria_3,fig.width=10,fig.height=2}

idadef <- dat|>
    dplyr::filter(Sexo=='Feminino')|>
    ggplot(aes(x=IDADEcat3))+
    geom_bar(fill=i4p_colors['yellow'], alpha=0.75)+
    geom_text(stat='count',
              aes(label=paste0(..count..,
                               ' (', 100*round(..count../1028, 3), '%)'
                               )),
              hjust=1.1, fontface='bold')+
    scale_y_continuous(trans='reverse', limits=c(285, 0), breaks=NULL)+
    labs(x=NULL, y=NULL, title='Age pyramid:', subtitle='Female')+
    theme_minimal(base_size=14)+
    theme(axis.text.y  =element_blank(), 
          plot.margin  =margin(t=1, r=0, b=1, l=1, unit='lines'),
          plot.title   =element_text(hjust=1, face='bold'), 
          plot.subtitle=element_text(hjust=1, face='bold'))+
    coord_flip()

idadem <- dat|>
    dplyr::filter(Sexo=='Masculino')|>
    ggplot(aes(x=IDADEcat3))+
    geom_bar(fill=i4p_1c, alpha=0.75)+
    geom_text(stat='count',
              aes(label=paste0(..count..,
                               ' (', 100*round(..count../1028, 3), '%)'
                               )),
              hjust=-0.1, fontface='bold')+
    scale_y_continuous(limits=c(0, 285), breaks=NULL)+
    labs(x=NULL, y=NULL, title='1028 cases', subtitle='Male')+
    theme_minimal(base_size=14)+
    theme(axis.text.y  =element_text(hjust=0.5, face='bold'),
          plot.margin  =margin(t=1, r=1, b=1, l=0, unit='lines'),
          plot.title   =element_text(face='bold'), 
          plot.subtitle=element_text(face='bold'))+
    coord_flip()

idadef + idadem

```

## Idade e comorbidade

```{r idade_comorbidade}

dat|>
    dplyr::group_by(`PRESENÇA DE COMORBIDADE`)|>
    dplyr::summarise(Mínimo       =min(IDADE),
                     '1o.quantil' =quantile(IDADE, 0.25), 
                     Mediana      =median(IDADE),
                     '3o.quantil' =quantile(IDADE, 0.75), 
                     Máximo       =max(IDADE), 
                     Media        =mean(IDADE),
                     Desvio.Padrão=sd(IDADE))
t.test(
    dat|>
    dplyr::filter(`PRESENÇA DE COMORBIDADE` == 0)|>dplyr::pull(IDADE),
    dat|>
    dplyr::filter(`PRESENÇA DE COMORBIDADE` == 1)|>dplyr::pull(IDADE)
)$p.value

```

> Diferença média das idades por presença de comorbidade difere
> significativamente.

# Município

***

```{r municipio}

dat <- dat|>
    dplyr::mutate(
               Município=
                   forcats::fct_collapse(
                                Município,
                                'CAJATI (SP)'=c('CAJATI',
                                                'CAJATI(SP)'),
                                CURITIBA=c('CURITIBA', 'CURITIVA'),
                                'FOZ DO IGUAÇU'=c('FOZ DO IGUACU',
                                                  'FOZ DO IGUAÇU'),
                                PINHAIS=c('PINHAIS', 'PINHAS'),
                                QUITANDINHA=c('QUINTANDINHA',
                                              'QUITANDINHA'), 
                                'SÃO JOSÉ DOS PINHAIS'=c(
                                    'SAO JOSE DOS PINHAIS',
                                    'SÃO JOSE DOS PINHAIS',
                                    'SÃO JOSÉ DOS PINHAIS'),
                                'ALMIRANTE TAMANDARÉ'=
                                    'ALMIRANTE TAMANDARE',
                                ARAUCÁRIA='ARAUCARIA',
                                PARANAGUÁ='PARANAGUA',
                                'PONTAL DO PARANÁ'='PONTAL DO PARANA',
                                'RIBEIRÃO DO PINHAL'=
                                    'RIBEIRAO DO PINHAL',
                                'SÃO JOÃO DO TRIUNFO'=
                                    'SAO JOAO DO TRIUNFO',
                                AMPÉRE='AMPERE',
                                ICARAÍMA='ICARAIMA',
                                ITAPERUÇU='ITAPERUCU',
                                'LARANJEIRAS DO SUL'=
                                    'LARANJEIRA DO SUL'))

munis <- dat|>
    dplyr::count(Município)|>
    dplyr::arrange(dplyr::desc(n))

munis|>
    print(n=45)

munis <- munis|>
    dplyr::filter(!Município %in% c('CUIABA',
                                    'CAJATI (SP)',
                                    'IRATI (sc)',
                                    'NETEROI',
                                    'PORTO VELHO',
                                    'RIO DE JANEIRO',
                                    'SAO PAULO',
                                    'PAPANDUVA'))|>
    dplyr::mutate(Município=stringr::str_to_title(Município))

dplyr::left_join(geobr::read_municipality(code_muni='PR', year=2020),
                 dplyr::rename(munis, name_muni='Município'))|>
    dplyr::mutate(n=cut(n,
                        breaks=c(0, 1, 2, 10, 50, 100, 659),
                        labels=c('1',
                                 '2',
                                 '(2,10]',
                                 '(10,50]',
                                 '(50,100]',
                                 '659')))|>
    ggplot(aes(fill=n))+
    geom_sf(size=0.3)+
    coord_sf(datum=NA)+
    ggspatial::annotation_scale()+
    scale_fill_brewer(palette='Spectral', direction=-1,
                      na.value='white', na.translate=FALSE)+
    labs(title=paste0('Municipalities of Paraná\n',
                      'with patients treated by HPP | COVID-19'),
         fill='Number of\npeople served')+
    theme_classic(base_size=14)+
    theme(plot.title     =element_text(face='bold'),
          legend.title   =element_text(face='bold'))

```

# Alta

***

```{r}

dat <- dat|>
    dplyr::mutate(Alta=dplyr::recode(Alta,
                                     '0'='Não internou',
                                     '1'='Alta',
                                     '2'='Óbito',
                                     '3'='Transferência'))

stringtable(dat$Alta)

```

# Resultado COVID

***

```{r}

dat <- dat|>
    dplyr::mutate(
               `RESULTADO COVID`=forcats::fct_collapse(
                                              `RESULTADO COVID`,
                                              DETECTÁVEL=c('deTECTÁVEL',
                                                           'DETECTÁVEL')
                                          ))

stringtable(dat$`RESULTADO COVID`)

```

# Comorbidade

***

## Presença

```{r}

stringtable(dat$`PRESENÇA DE COMORBIDADE`)

dat|>
    dplyr::select(`PRESENÇA DE COMORBIDADE`)|>
    chisquare()

```

> p-valor altamente significativo. Existe uma diferença significativa
> entre a quantidade de pacientes com e sem comorbidades.

## Comorbidades

```{r}

datsc <- dat|>
    dplyr::filter(`PRESENÇA DE COMORBIDADE` == 1)|>
    dplyr::select(`SISTEMA COMORBIDADE 1`:`SISTEMA COMORBIDADE 5`)|>
    dplyr::mutate(id=haven::as_factor(1:n()),
                  `SISTEMA COMORBIDADE 2`=
                      dplyr::na_if(`SISTEMA COMORBIDADE 2`, '0.0'),
                  `SISTEMA COMORBIDADE 3`=
                      dplyr::na_if(`SISTEMA COMORBIDADE 3`, '0.0'),
                  `SISTEMA COMORBIDADE 4`=
                      dplyr::na_if(`SISTEMA COMORBIDADE 4`, '0.0'),
                  `SISTEMA COMORBIDADE 5`=
                      dplyr::na_if(`SISTEMA COMORBIDADE 5`, '0.0'))|>
    tidyr::pivot_longer(!id,
                        names_to='sistema', values_to='comorbidade',
                        values_drop_na=TRUE)|>
    dplyr::mutate(comorbidade=stringr::str_to_title(comorbidade),
                  comorbidade=forcats::fct_collapse(
                                           comorbidade,
                                           'Renal/Urinário'=c(
                                               'Urinário/Renal',
                                               'Renal/Urinário'),
                                           Outro=c('Outro', 'Outra'),
                                           'Sd Genética'=c(
                                               'Sd Genética',
                                               'Sd Genetica')))

```

```{r comorbidades,fig.height=3}

datsc_sum <- dplyr::summarize(dplyr::group_by(datsc, comorbidade),
                              n=length(id), id='total')

datsc_sum|>
    dplyr::filter(!comorbidade %in% '0')|>
    dplyr::arrange(n)|>
    dplyr::mutate(
               comorbidade=haven::as_factor(as.character(comorbidade))
           )|>
    ggplot(aes(x=n, y=comorbidade))+
    geom_col(fill=unique_color, alpha=0.75)+
    geom_text(aes(label=paste0(n, ' (', round(100*n/252, 1), '%)')),
              hjust=-0.1, fontface='bold')+
    scale_x_continuous(expand=c(0, 0), limits=c(0, 75), breaks=NULL)+
    labs(x=NULL, y=NULL,
         title=paste0(183, ' (', round(100*183/1028, 1), '%)',
                      ' patients with ',
                      sum(datsc_sum$n), ' comorbidities'))+
    theme_minimal(base_size=14)+
    theme(axis.text.y=element_text(face='bold'),
          plot.title =element_text(face='bold'))

```

```{r comorbidades_split,fig.width=10,fig.height=6.5}

datsc_idsum <- datsc|>
    dplyr::filter(!comorbidade %in% '0')|>
    dplyr::group_by(id)|>
    dplyr::summarise(n=length(id), comorbidade='total')

idsum_1 <- dplyr::filter(datsc_idsum, n == 1)|>dplyr::pull(id)

datsc.p1 <- datsc|>
    dplyr::filter(!comorbidade %in% '0')|>
    dplyr::filter(id %in% idsum_1)|>
    dplyr::count(comorbidade)|>
    dplyr::arrange(n)|>
    dplyr::mutate(
               comorbidade=haven::as_factor(as.character(comorbidade))
           )

p1 <- datsc.p1|>
    ggplot(aes(x=n, y=comorbidade))+
    geom_col(fill=unique_color, alpha=0.75)+
    geom_text(aes(label=paste0(n, ' (', round(100*n/252, 1), '%)')),
              hjust=-0.1, fontface='bold')+
    scale_x_continuous(expand=c(0, 0), limits=c(0, 60), breaks=NULL)+
    labs(x=NULL, y=NULL,
         title=paste0(length(idsum_1),
                      ' (', round(100*length(idsum_1)/1028, 1), '%)',
                      ' patients\nwith 1 comorbidity'))+
    theme_minimal(base_size=14)+
    theme(axis.text.y=element_text(face='bold'),
          plot.title =element_text(face='bold'))

idsum_plus1 <- dplyr::filter(datsc_idsum, n > 1)|>dplyr::pull(id)

datsc_plus1 <- datsc|>
    dplyr::filter(!comorbidade %in% '0')|>
    dplyr::filter(id %in% idsum_plus1)

datsc.p2 <- dplyr::count(datsc_plus1, comorbidade)

p2 <- datsc.p2|>
    dplyr::mutate(
               comorbidade=factor(comorbidade,
                                  levels=levels(datsc.p1$comorbidade))
           )|>
    ggplot(aes(x=n, y=comorbidade))+
    geom_col(fill=unique_color, alpha=0.75)+
    geom_text(aes(label=paste0(n, ' (', round(100*n/252, 1), '%)')),
              hjust=-0.1, fontface='bold')+
    scale_x_continuous(expand=c(0, 0), limits=c(0, 30), breaks=NULL)+
    labs(x=NULL, y=NULL,
         title=paste0(length(idsum_plus1), ' (',
                      round(100*length(idsum_plus1)/1028, 1), '%)',
                      ' patients\nwith +1 comorbidity'))+
    theme_minimal(base_size=14)+
    theme(axis.text.y=element_blank(),
          plot.title =element_text(face='bold'))

id_plus1 <- datsc_plus1|>
    dplyr::count(id, sort=TRUE)|>
    dplyr::mutate(id=haven::as_factor(as.character(id)))|>
    dplyr::pull(id)

levels.p3 <- datsc.p2|>
    dplyr::arrange(n)|>
    dplyr::mutate(
               comorbidade=haven::as_factor(as.character(comorbidade))
           )|>
    dplyr::pull(comorbidade)|>
    levels()

p3 <- datsc_plus1|>
    dplyr::mutate(id=factor(id, levels=id_plus1),
                  comorbidade=factor(comorbidade, levels=levels.p3))|>
    ggplot(aes(x=id, fill=comorbidade))+
    geom_bar(alpha=0.75)+
    labs(x='Patient 1:48', y=NULL,
         title='Patients with +1 comorbidities')+
    scale_fill_viridis_d()+
    theme_minimal(base_size=14)+
    theme(legend.title   =element_blank(),
          axis.title.x   =element_text(face='bold'),
          plot.title     =element_text(face='bold'),
          legend.position='bottom',
          axis.text.x    =element_blank())

(p1 + p2) / p3 +
    patchwork::plot_layout(heights=c(1, 0.6))

```

## Quantas comorbidades

```{r}

stringtable(dat$`QUANTAS COMORBIDADES`)

```

## Comorbidade por internação

```{r comorbidade_internacao}

(ci <- dat|>
     dplyr::count(`PRESENÇA DE COMORBIDADE`, Internou)|>
     dplyr::mutate(Internou=dplyr::recode(Internou,
                                          '0'='Internou: 0',
                                          '1'='Internou: 1'))|>
     tidyr::spread(Internou, n))

ci.pv <- ci|>
    dplyr::select(!`PRESENÇA DE COMORBIDADE`)|>
    chisq.test()

ci.pv$p.value

```

> Existe uma interação significativa entre presença de comorbidade e
> internação, valor-*p* < 0.0001.
>
> Quando analisamos apenas as crianças internadas, a presença de
> comorbidade não se mostrou estatisticamente significativa (valor-*p*
> de 0.4). Contudo, aqui é. Ou seja, entre as crianças sem comorbidade,
> a probabilidade de não ser internada é maior, significativa. Entre as
> crianças com comorbidade, a internação é o eventro de maior
> probabilidade.

# Data do início dos sintomas

***

```{r}

dat|>
    dplyr::filter(
               `DATA DO INICIO DOS SINTOMAS` %in% c('ASSINTOMÁTICO',
                                                    'NÃO DISPONÍVEL')
           )|>
    dplyr::select(`DATA DO INICIO DOS SINTOMAS`)|>
    stringtable()

```

```{r data_inicio_sintomas,fig.width=10,fig.height=3.75}

data_inicio_sintomas <- readxl::read_xlsx('Análise estatística.xlsx',
                                          sheet    ='Todos',
                                          range    ='Y1:Y1031',
                                          col_types='date')|>
    dplyr::filter(!`DATA DO INICIO DOS SINTOMAS` %in% NA)|>
    dplyr::rename(data=`DATA DO INICIO DOS SINTOMAS`)|>
    dplyr::mutate(data=as.Date(data))

data_inicio_sintomas|>
    ggplot(aes(x=data))+
    geom_vline(xintercept=seq(as.Date('2020-04-01'),
                              as.Date('2022-09-01'), by='month'),
               linetype='dashed')+
    geom_bar(fill=unique_color)+
    scale_x_date(date_labels='%m-%Y', date_breaks='2 month')+
    labs(x=NULL, y=NULL,
         title='Date of onset of symptoms',
         subtitle=paste0(
             length(data_inicio_sintomas$data), ' (',
             round(100*length(data_inicio_sintomas$data)/1028, 1),
             '%) patients with available date'
         ))+
    scale_y_continuous(breaks=1:12)+
    theme_classic(base_size=14)+
    theme(plot.title =element_text(face='bold'),
          axis.text.x=element_text(face='bold'),
          axis.text.y=element_text(face='bold'))

md <- summary(data_inicio_sintomas$data)

names(md) <- c('Mínimo',
               '1o.quantil',
               'Mediana',
               'Média',
               '3o.quantil',
               'Máximo');md

c('Desvio.Padrão'=sd(data_inicio_sintomas$data))

```

# Tempo do início dos sintomas

***

```{r}

dat|>
    dplyr::filter(`Tempo inicio sintomas` %in% c('ASSINTOMÁTICO',
                                                 'NÃO DISPONÍVEL'))|>
    dplyr::select(`Tempo inicio sintomas`)|>
    stringtable()

```

```{r tempo_inicio_dos_sintomas,fig.width=10,fig.height=3.75}

dat.p <- dat|>
    dplyr::filter(!`Tempo inicio sintomas` %in% c('ASSINTOMÁTICO',
                                                  'NÃO DISPONÍVEL'))|>
    dplyr::rename(tempo=`Tempo inicio sintomas`)|>
    dplyr::mutate(tempo=as.numeric(tempo))

dat.p|>
    ggplot(aes(x=tempo))+
    geom_hline(yintercept=seq(0, 175, by=25), linetype='dashed')+
    geom_bar(fill=unique_color)+
    scale_x_continuous(breaks=c(-10, seq(-5, 30, by=5), 34))+
    scale_y_continuous(breaks=seq(0, 175, by=25))+
    labs(x=NULL, y=NULL,
         title='Days from onset of symptoms to medical consultation',
         subtitle=paste0(length(dat.p$tempo), ' (',
                         round(100*length(dat.p$tempo)/1028, 1),
                         '%) patients with available date'))+
    theme_classic(base_size=14)+
    theme(plot.title =element_text(face='bold'),
          axis.text.x=element_text(face='bold'),
          axis.text.y=element_text(face='bold'))

dat.p|>
    dplyr::summarise(Mínimo       =min(tempo),
                     '1o.quantil' =quantile(tempo, 0.25), 
                     Mediana      =median(tempo),
                     '3o.quantil' =quantile(tempo, 0.75), 
                     Máximo       =max(tempo), 
                     Media        =mean(tempo),
                     Desvio.Padrão=sd(tempo))

```

# Contato confirmado ou suspeito

***

```{r}

dat <- dat|>
    dplyr::mutate(`CONTATO CONFIRMADO OU SUSPEITO`=
                      dplyr::recode(`CONTATO CONFIRMADO OU SUSPEITO`,
                                    '0'='Não',
                                    '1'='Sim',
                                    '9'='Desconhecido'))

stringtable(dat$`CONTATO CONFIRMADO OU SUSPEITO`)

```

# Sintomas

***

```{r sintomas}

dats <- dat|>
    dplyr::select(FEBRE:ROUQUIDÃO)|>
    dplyr::mutate(id=factor(1:1028))|>
    tidyr::pivot_longer(!id)|>
    dplyr::filter(value %in% c(0, 1))|>
    dplyr::mutate(name=stringr::str_to_title(name))

dats1 <- dats|>
    dplyr::filter(value == 1)

dats1|>
    dplyr::count(name)|>
    dplyr::arrange(n)|>
    dplyr::mutate(name=haven::as_factor(name))|>
    ggplot(aes(x=n, y=name))+
    geom_col(fill=unique_color, alpha=0.75)+
    geom_text(aes(label=paste0(n, ' (', round(100*n/1028, 1), '%)')),
              hjust=-0.1, fontface='bold')+
    scale_x_continuous(expand=c(0, 0), limits=c(0, 805), breaks=NULL)+
    labs(x=NULL, y=NULL, title='Symptoms')+
    theme_minimal(base_size=14)+
    theme(axis.text.y=element_text(face='bold'),
          plot.title =element_text(face='bold'))

```

> Múltiplos sintomas:

```{r multiple_symptoms,fig.height=3.5,fig.width=6}

dats1_idsum <- dplyr::count(dats1, id)

cbind(c('Total', 'Percentual %'), 
      rbind(c('0'=(1028-989), table(dats1_idsum$n)), 
            round(100*c('0'=(1028-989), table(dats1_idsum$n))/1028, 3)))

dats1_idsum|>
    dplyr::summarise(Mínimo       =min(n),
                     '1o.quantil' =quantile(n, 0.25), 
                     Mediana      =median(n),
                     '3o.quantil' =quantile(n, 0.75), 
                     Máximo       =max(n), 
                     Media        =mean(n),
                     Desvio.Padrão=sd(n))

dats1_idsum|>
    ggplot(aes(x=n))+
    geom_hline(yintercept=seq(0, 300, by=50), linetype='dashed')+
    geom_bar(fill=unique_color)+
    scale_x_continuous(breaks=1:8)+
    scale_y_continuous(breaks=seq(0, 300, by=50))+
    labs(x='Number of symptoms', y=NULL, title='Multiple symptoms')+
    theme_classic(base_size=14)+
    theme(plot.title  =element_text(face='bold'),
          axis.text.x =element_text(face='bold'),
          axis.text.y =element_text(face='bold'),
          axis.title.x=element_text(face='bold'))

```

```{r multiplos_sintomas,fig.width=10,fig.height=6}

dats|>
    dplyr::mutate(value=factor(value, labels=c('Absent', 'Present')))|>
    ggplot(aes(x=id, y=name, fill=value))+
    geom_tile()+
    scale_x_discrete(expand=c(0, 0))+
    scale_fill_manual(values=c('Absent'='yellow', 'Present'='red'))+
    labs(x=NULL, y=NULL,
         title='Symptoms heatmap',
         subtitle='Each row is a symptom and each column is a patient',
         fill='Symptom:')+
    theme_minimal(base_size=14)+
    theme(axis.text.x    =element_blank(),
          axis.text.y    =element_text(face='bold'),
          legend.position='bottom',
          legend.title   =element_text(face='bold'), 
          plot.title     =element_text(face='bold'))

```

# Raio-X

***

```{r raiox,fig.height=2.75,fig.width=10}

raiox <- c('Normal + TQT',
           'Normal',
           'Infiltrado Instersticial',
           'Infiltrado Instersticial + Condensação/Opacidade',
           'Condensação/Opacidade',
           'Hiperinsuflação',
           'Outro',
           'Não realizado')

dat <- dat|>
    dplyr::mutate(RAIOX=dplyr::case_when(
                                   startsWith(RAIOX, '5') |
                                   startsWith(RAIOX, 'vidro') ~ '5.0',
                                   TRUE ~ as.character(RAIOX)
                               ),
                  RAIOX=dplyr::recode(RAIOX,
                                      '0'      =raiox[2],
                                      '1 + TQT'=raiox[1],
                                      '1'      =raiox[2],
                                      '2'      =raiox[3],
                                      '2+3'    =raiox[4],
                                      '3'      =raiox[5],
                                      '4'      =raiox[6],
                                      '5.0'    =raiox[7],
                                      '6'      =raiox[8]),
                  RAIOX=factor(RAIOX, levels=raiox)
                  )

t(stringtable(dat$RAIOX))

dat|>
    dplyr::count(RAIOX)|>
    dplyr::arrange(n)|>
    dplyr::filter(!RAIOX == 'Não realizado')|>
    ggplot(aes(x=n, y=RAIOX))+
    geom_col(fill=unique_color, alpha=0.75)+
    geom_text(aes(label=paste0(n, ' (', round(100*n/1028, 1), '%)')),
              hjust=-0.1, fontface='bold')+
    scale_x_continuous(expand=c(0, 0), limits=c(0, 165), breaks=NULL)+
    labs(x=NULL, y=NULL, title='X-Ray',
         subtitle=paste0(1028-803, ' (', round(100*(1028-803)/1028, 2),
                         '%) patients had an X-ray'))+
    theme_minimal(base_size=14)+
    theme(axis.text.y=element_text(face='bold'),
          plot.title =element_text(face='bold'))

```

# Tomografia

***

```{r tomografia,fig.height=1.75,fig.width=10}

tomo <- c('Normal',
          'Condensação/Opacidade',
          'Vidro Fosco',
          'Outro',
          'Não realizado',
          'NR')

dat <- dat|>
    dplyr::mutate(TOMO=dplyr::recode(TOMO,
                                     '1' =tomo[1],
                                     '3' =tomo[2],
                                     '4' =tomo[3],
                                     '5' =tomo[4],
                                     '6' =tomo[5],
                                     'NR'=tomo[6]),
                  TOMO=factor(TOMO, levels=tomo))

stringtable(dat$TOMO)

dat|>
    dplyr::count(TOMO)|>
    dplyr::arrange(n)|>
    dplyr::filter(!TOMO %in% c('Não realizado', 'NR'))|>
    ggplot(aes(x=n, y=TOMO))+
    geom_col(fill=unique_color, alpha=0.75)+
    geom_text(aes(label=paste0(n, ' (', round(100*n/1028, 1), '%)')),
              hjust=-0.1, fontface='bold')+
    scale_x_continuous(expand=c(0, 0), limits=c(0, 77.5), breaks=NULL)+
    labs(x=NULL, y=NULL, title='Tomography',
         subtitle=paste0(1028-918, ' (', round(100*(1028-918)/1028, 2),
                         '%) patients had a CT scan'))+
    theme_minimal(base_size=14)+
    theme(axis.text.y=element_text(face='bold'),
          plot.title =element_text(face='bold'))

```

# Dímero-D

***

```{r}

dat <- dat|>
    dplyr::mutate(`DIMERO D`=dplyr::recode(`DIMERO D`,
                                           '> 10000'='10000',
                                           '>10000' ='10000'),
                  `DIMERO D`=dplyr::na_if(`DIMERO D`, 'NR'),
                  `DIMERO D`=as.numeric(`DIMERO D`))

md <- summary(dat$`DIMERO D`)

names(md) <- c('Mínimo',
               '1o.quantil',
               'Mediana',
               'Média',
               '3o.quantil',
               'Máximo',
               'Não realizados')

t(c(md, 'Desvio.Padrão'=sd(dat$`DIMERO D`, na.rm=TRUE)))

```

# PCR

***

```{r}

dat <- dat|>
    dplyr::mutate(PCR=dplyr::recode(PCR,
                                    '<5'            ='5',
                                    'INFERIOR 5'    ='5',
                                    'INFERIOR A 5,0'='5',
                                    'INFERIOR A 5.0'='5'),
                  PCR=dplyr::na_if(PCR, 'NR'),
                  PCR=as.numeric(PCR))

md <- summary(dat$PCR)

names(md) <- c('Mínimo',
               '1o.quantil',
               'Mediana',
               'Média',
               '3o.quantil',
               'Máximo',
               'Não realizados')

t(c(md, 'Desvio.Padrão'=sd(dat$PCR, na.rm=TRUE)))

```

# VHS

***

```{r}

dat <- dat|>
    dplyr::mutate(VHS=dplyr::na_if(VHS, 'NR'),
                  VHS=as.numeric(VHS))

md <- summary(dat$VHS)

names(md) <- c('Mínimo',
               '1o.quantil',
               'Mediana',
               'Média',
               '3o.quantil',
               'Máximo',
               'Não realizados')

t(c(md, 'Desvio.Padrão'=sd(dat$VHS, na.rm=TRUE)))

```

# Dímero-D, PCR & VHS

***

```{r dimerod_pcr_vhs,fig.width=6.5,fig.height=6}

psych::pairs.panels(dat|>
                    dplyr::select(`DIMERO D`, PCR, VHS)|>
                    dplyr::rename(`D-Dimer`=`DIMERO D`),
                    stars   =TRUE,
                    lm      =TRUE,
                    smoother=TRUE,
                    ci      =TRUE,
                    hist.col='gray80',
                    main    ='Dímero-D, PCR & VHS',
                    density =FALSE,
                    ellipses=FALSE)

```

> Na diagonal temos os histogramas, mostrando como cada variável se
> distribuí. Os risquinhos na parte de baixo indicam aonde cada
> observação se localiza. Nos painéis superiores temos as correlações,
> estrelas indicam significância (três estrelas significam p-valor <
> 0.0001). Nos painéis inferiores temos os gráficos de dispersão num
> estilo mapa de calor para facilitar a visualização, dado que temos
> muitas observações. As retas em vermelho correspondem a modelos
> lineares para indicar a tendência, em cinza seus intervalos de 95% de
> confiança.

# Linfócitos

***

```{r}

dat <- dat|>
    dplyr::mutate(linfócitos=dplyr::recode(linfócitos,
                                           '0'='Normal',
                                           '1'='Decreased',
                                           '2'='Increased',
                                           '9'='Não disponível'),
                  linfócitos=factor(linfócitos,
                                    levels=c('Normal',
                                             'Decreased',
                                             'Increased',
                                             'Não disponível')),
                  linfocitos=dplyr::na_if(linfocitos, 'NR'),
                  linfocitos=as.numeric(linfocitos, 'NR'))

stringtable(dat$linfócitos)

md <- summary(dat$linfocitos)

names(md) <- c('Mínimo',
               '1o.quantil',
               'Mediana',
               'Média',
               '3o.quantil',
               'Máximo',
               'Não realizados')

t(c(md, 'Desvio.Padrão'=sd(dat$linfocitos, na.rm=TRUE)))

```

# Neutrófilos

***

```{r}

dat <- dat|>
    dplyr::mutate(neutrófilos=dplyr::recode(neutrófilos,
                                            '0'='Normal',
                                            '1'='Decreased',
                                            '2'='Increased',
                                            '9'='Não disponível'),
                  neutrófilos=factor(neutrófilos,
                                     levels=c('Normal',
                                              'Decreased',
                                              'Increased',
                                              'Não disponível')),
                  neutrofilos=dplyr::na_if(neutrofilos, 'NR'),
                  neutrofilos=as.numeric(neutrofilos, 'NR'))

stringtable(dat$neutrófilos)

md <- summary(dat$neutrofilos)

names(md) <- c('Mínimo',
               '1o.quantil',
               'Mediana',
               'Média',
               '3o.quantil',
               'Máximo',
               'Não realizados')

t(c(md, 'Desvio.Padrão'=sd(dat$neutrofilos, na.rm=TRUE)))

```

# Linfócitos vs. Neutrófilos

***

```{r linfocitos_vs_neutrolilos,fig.width=6,fig.height=5.75}

(datln <- dat|>
     dplyr::filter(! linfócitos %in% 'Não disponível' &
                   !neutrófilos %in% 'Não disponível')|>
     dplyr::count(linfócitos, neutrófilos))

datln|>
    ggplot(aes(y=n, axis1=linfócitos, axis2=neutrófilos))+
    ggalluvial::geom_alluvium(aes(fill=linfócitos))+
    ggalluvial::geom_stratum(width=1/10,
                             fill='8a8d8f', color='white', alpha=0.5)+
    geom_label(stat='stratum', aes(label=after_stat(stratum)))+
    scale_x_continuous(breaks=1:2,
                       labels=c('Lymphocytes', 'Neutrophils'))+
    scale_fill_viridis_d()+
    labs(y=NULL, title='Lymphocytes & Neutrophils',
         subtitle=paste0(301,
                         ' (', round(100*301/1028, 1), '%) patients'))+
    theme_minimal(base_size=14)+
    theme(legend.position='none',
          axis.text.x    =element_text(face='bold'), 
          axis.text.y    =element_blank(),
          plot.title     =element_text(face='bold'))

psych::pairs.panels(dat|>
                    dplyr::select(linfocitos, neutrofilos)|>
                    dplyr::rename(Lymphocytes=linfocitos,
                                  Neutrophils=neutrofilos),
                    stars   =TRUE,
                    lm      =TRUE,
                    smoother=TRUE,
                    ci      =TRUE,
                    hist.col='gray80',
                    main    ='Lymphocytes & Neutrophils',
                    density =FALSE,
                    ellipses=FALSE)

```

# iga, igg & igm

***

```{r}

dat <- dat|>
    dplyr::mutate(iga=dplyr::na_if(iga, 'NR'),
                  iga=as.numeric(iga, 'NR'),
                  igg=dplyr::na_if(igg, 'NR'),
                  igg=as.numeric(igg, 'NR'),
                  igm=dplyr::na_if(igm, 'NR'),
                  igm=as.numeric(igm, 'NR'))

md <- rbind(c(summary(dat$iga), sd(dat$iga, na.rm=TRUE)), 
            c(summary(dat$igg), sd(dat$igg, na.rm=TRUE)), 
            c(summary(dat$igm), sd(dat$igm, na.rm=TRUE)))

colnames(md) <- c('Mínimo',
                  '1o.quantil',
                  'Mediana',
                  'Média',
                  '3o.quantil',
                  'Máximo',
                  'Não realizados',
                  'Desvio.Padrão')

t(cbind(c('iga', 'igg', 'igm'), md))

```

# Referências

***

> A análise estatística foi realizada no ambiente de computação
> estatística `R` (R Core Team, 2022). Os principais pacotes `R`
> utilizados foram o {`dplyr`} (Wickham et al., 2022), {`tidyr`}
> (Wickham & Girlich, 2022), {`forcats`} (Wickham, 2021), {`lubridate`}
> (Grolemund & Wickham, 2011), {`ggplot2`} (Wickham, 2016),
> {`patckwork`} (Pedersen, 2020), {`geobr`} (Pereira & Gonçalves, 2022),
> {`psych`} (Revelle, 2022), e {`ggalluvial`} (Brunson & Read, 2020).

> R Core Team (2022). R: A language and environment for statistical
> computing. R Foundation for Statistical Computing, Vienna,
> Austria. URL https://www.R-project.org/
>
> Wickham, H., François, R., Henry, L., Müller, K. (2022). dplyr: A
> Grammar of Data Manipulation. R package version
> 1.0.9. https://CRAN.R-project.org/package=dplyr
>
> Wickham, H., Girlich, M. (2022). tidyr: Tidy Messy Data. R package
> version 1.2.0, https://CRAN.R-project.org/package=tidyr
>
> Wickham, H. (2021). forcats: Tools for Working with Categorical
> Variables (Factors). R package version 0.5.1,
> https://CRAN.R-project.org/package=forcats
>
> Grolemund, G., Wickham, H. (2011). Dates and Times Made Easy with
> lubridate. Journal of Statistical Software, 40(3),
> 1-25. https://www.jstatsoft.org/v40/i03/
>
> Wickham, H. (2016). ggplot2: Elegant Graphics for Data
> Analysis. Springer-Verlag New York
>
> Pedersen, T. L. (2020). patchwork: The Composer of Plots. R package
> version 1.1.1. https://CRAN.R-project.org/package=patchwork
>
> Pereira, R. H. M., Gonçalves, C. N. (2022). geobr: Download Official
> Spatial Data Sets of Brazil. R package version 1.6.5999,
> <https://github.com/ipeaGIT/geobr
>
> Revelle, W. (2022). psych: Procedures for Personality and
> Psychological Research, Northwestern University, Evanston, Illinois,
> USA, R package version 2.2.3. https://CRAN.R-project.org/package=psych
>
> Brunson, J. C., Read, Q. D. (2020). ggalluvial: Alluvial Plots in
> 'ggplot2'. R package version
> 0.12.3. http://corybrunson.github.io/ggalluvial/

---
title: "multiGLMM: a multinomial GLMM 4 clustered competing risks data"
author: "[Henrique Ap. Laureano](http://www.leg.ufpr.br/~henrique)"
date: "*Last modification on* `r Sys.time()`"
include-before:
  - '\(\newcommand{\bm}[1]{\boldsymbol{\mathbf{#1}}}\)'
output:
  html_document:
    toc: true
    toc_float: true
    css: font_size.css
    code_folding: show
---

```{r, echo=FALSE}
library(knitr)
htmltools::img(src = image_uri("logo_leg.jpg"),
               alt = 'logo',
               style = 'position:absolute; top:0; right:0;
                        padding:10px; width:175px;')
options(width = 100)
opts_chunk$set(fig.path = "iprocess/",
               cache = TRUE,
               cache.path = "cprocess/",
               ## warning = FALSE,
               comment = NA,
               prompt = FALSE)
```

```{r packages}
pacman::p_load(tidyverse, ## pipes, select()
               TMB, ## template model builder
               Matrix, ## bdiag()
               tmbstan, ## MCMC samp. from TMB model object using Stan
               patchwork
               )
## why not library()?
## with p_load(), if the package isn't installed,
## install_packages() is automatically loaded
```

## starting from the bottom

## just fixed effects

```
times: equally spaced grid from 30 to 80 years old
```

```{r datasimuF}
datasimuF <- function(J, from = 30, to =  79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    risk1 <- exp(beta[1])
    risk2 <- exp(beta[2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
tmbparsF <- list(beta1 = -2,
                 beta2 = -1.5,
                 gama1 = 1.2,
                 gama2 = 1,
                 w1 = 3,
                 w2 = 5)
```

```{r fixedmodels}
## compile("multiGLM.cpp")
dyn.load(dynlib("multiGLM"))
openmp(n = 10)
## ---------------------------------------------------------------------
dfF <- datasimuF(J = 1e3)
dfF %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdataF <- list(Y = as.matrix(dfF %>% select(y1:y3)),
                 T = dfF$t,
                 delta = 80)
objF <- MakeADFun(data = tmbdataF,
                  parameters = tmbparsF,
                  DLL = "multiGLM",
                  hessian = TRUE, silent = TRUE)
objF$fn()
tictoc::tic()
optF <- nlminb(objF$par, objF$fn, objF$gr)
tictoc::toc()
sdrF <- sdreport(objF)
## ---------------------------------------------------------------------
dfF2 <- datasimuF(J = 5e3)
dfF2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdataF2 <- list(Y = as.matrix(dfF2 %>% select(y1:y3)),
                  T = dfF2$t,
                  delta = 80)
objF2 <- MakeADFun(data = tmbdataF2,
                   parameters = tmbparsF,
                   DLL = "multiGLM",
                   hessian = TRUE, silent = TRUE)
objF2$fn()
tictoc::tic()
optF2 <- nlminb(objF2$par, objF2$fn, objF2$gr)
tictoc::toc()
sdrF2 <- sdreport(objF2)
## ---------------------------------------------------------------------
dfF3 <- datasimuF(J = 1e4)
dfF3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdataF3 <- list(Y = as.matrix(dfF3 %>% select(y1:y3)),
                  T = dfF3$t,
                  delta = 80)
objF3 <- MakeADFun(data = tmbdataF3,
                   parameters = tmbparsF,
                   DLL = "multiGLM",
                   hessian = TRUE, silent = TRUE)
objF3$fn()
tictoc::tic()
optF3 <- nlminb(objF3$par, objF3$fn, objF3$gr)
tictoc::toc()
sdrF3 <- sdreport(objF3)
## ---------------------------------------------------------------------
dfF4 <- datasimuF(J = 25e3)
dfF4 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdataF4 <- list(Y = as.matrix(dfF4 %>% select(y1:y3)),
                  T = dfF4$t,
                  delta = 80)
objF4 <- MakeADFun(data = tmbdataF4,
                   parameters = tmbparsF,
                   DLL = "multiGLM",
                   hessian = TRUE, silent = TRUE)
objF4$fn()
tictoc::tic()
optF4 <- nlminb(objF4$par, objF4$fn, objF4$gr)
tictoc::toc()
sdrF4 <- sdreport(objF4)
## ---------------------------------------------------------------------
dfF5 <- datasimuF(J = 50e3)
dfF5 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdataF5 <- list(Y = as.matrix(dfF5 %>% select(y1:y3)),
                  T = dfF5$t,
                  delta = 80)
objF5 <- MakeADFun(data = tmbdataF5,
                   parameters = tmbparsF,
                   DLL = "multiGLM",
                   hessian = TRUE, silent = TRUE)
objF5$fn()
tictoc::tic()
optF5 <- nlminb(objF5$par, objF5$fn, objF5$gr)
tictoc::toc()
sdrF5 <- sdreport(objF5)
```

```{r fixedsummaries}
## 1e3 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5), summary(sdrF))
## 5e3 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5), summary(sdrF2))
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5), summary(sdrF3))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5), summary(sdrF4))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5), summary(sdrF5))
```

```{r fixedprofiles}
b1F <- tmbprofile(objF5, name = "beta1", trace = FALSE)
b2F <- tmbprofile(objF5, name = "beta2", trace = FALSE)
g1F <- tmbprofile(objF5, name = "gama1", trace = FALSE)
g2F <- tmbprofile(objF5, name = "gama2", trace = FALSE)
w1F <- tmbprofile(objF5, name = "w1", trace = FALSE)
w2F <- tmbprofile(objF5, name = "w2", trace = FALSE)
## ---------------------------------------------------------------------
par(mfrow = c(2, 3), mar =  c(4, 4, 2, 2))
plot(b1F) ; abline(v = -2, lty = 2)
plot(b2F) ; abline(v = -1.5, lty = 2)
plot(g1F) ; abline(v = 1.2, lty = 2)
plot(g2F) ; abline(v = 1, lty = 2)
plot(w1F) ; abline(v = 3, lty = 2)
plot(w2F) ; abline(v = 5, lty = 2)
```

```
remember: this is just one fit. the right thing to do here should be a
simulation study to get the histogram estimates
```

## adding latent structure

### 1

```{r datasimu1}
datasimu1 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(0.5, 0.0,
                                                0.0, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(110137)
df1.1 <- datasimu1(J = 1e4)
df1.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata1.1 <- list(
    Y = as.matrix(df1.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df1.1$t,
    delta = 80)
tmbpars1.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = log(0.5))
## ---------------------------------------------------------------------
set.seed(110208)
df1.2 <- datasimu1(J = 25e3)
df1.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata1.2 <- list(
    Y = as.matrix(df1.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df1.2$t,
    delta = 80)
tmbpars1.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = log(0.5))
## ---------------------------------------------------------------------
set.seed(110246)
df1.3 <- datasimu1(J = 50e3)
df1.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata1.3 <- list(
    Y = as.matrix(df1.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df1.3$t,
    delta = 80)
tmbpars1.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = log(0.5))
```

```{r models_1, error=TRUE, warning=FALSE, dependson="datasimu1"}
## compile("multiGLMM_1.cpp")
dyn.load(dynlib("multiGLMM_1"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_1.1 <- MakeADFun(data = tmbdata1.1,
                   parameters = tmbpars1.1,
                   DLL = "multiGLMM_1",
                   random = "R",
                   hessian = TRUE, silent = TRUE)
obj_1.1$fn()
tictoc::tic()
opt_1.1 <- nlminb(obj_1.1$par, obj_1.1$fn, obj_1.1$gr)
tictoc::toc()
sdr_1.1 <- sdreport(obj_1.1)
## ---------------------------------------------------------------------
obj_1.2 <- MakeADFun(data = tmbdata1.2,
                   parameters = tmbpars1.2,
                   DLL = "multiGLMM_1",
                   random = "R",
                   hessian = TRUE, silent = TRUE)
obj_1.2$fn()
tictoc::tic()
opt_1.2 <- nlminb(obj_1.2$par, obj_1.2$fn, obj_1.2$gr)
tictoc::toc()
sdr_1.2 <- sdreport(obj_1.2)
##----------------------------------------------------------------------
obj_1.3 <- MakeADFun(data = tmbdata1.3,
                     parameters = tmbpars1.3,
                     DLL = "multiGLMM_1",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_1.3$fn()
tictoc::tic()
opt_1.3 <- nlminb(obj_1.3$par, obj_1.3$fn, obj_1.3$gr)
tictoc::toc()
sdr_1.3 <- sdreport(obj_1.3)
```

```{r summaries_1, error=TRUE, dependson="datasimu1"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5)), summary(sdr_1.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5)), summary(sdr_1.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5)), summary(sdr_1.3, "fixed"))
```

### 2

```{r datasimu2}
datasimu2 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(1.0, 0.0,
                                                0.0, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(151340)
df2.1 <- datasimu2(J = 1e4)
df2.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata2.1 <- list(
    Y = as.matrix(df2.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df2.1$t,
    delta = 80)
tmbpars2.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = c(log(1), log(0.5)))
## ---------------------------------------------------------------------
set.seed(151449)
df2.2 <- datasimu2(J = 25e3)
df2.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata2.2 <- list(
    Y = as.matrix(df2.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df2.2$t,
    delta = 80)
tmbpars2.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)))
## ---------------------------------------------------------------------
set.seed(151532)
df2.3 <- datasimu2(J = 50e3)
df2.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata2.3 <- list(
    Y = as.matrix(df2.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df2.3$t,
    delta = 80)
tmbpars2.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)))
```

```{r models_2, error=TRUE, warning=FALSE, dependson="datasimu2"}
## compile("multiGLMM_2.cpp")
dyn.load(dynlib("multiGLMM_2"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_2.1 <- MakeADFun(data = tmbdata2.1,
                     parameters = tmbpars2.1,
                     DLL = "multiGLMM_2",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_2.1$fn()
tictoc::tic()
opt_2.1 <- nlminb(obj_2.1$par, obj_2.1$fn, obj_2.1$gr)
tictoc::toc()
sdr_2.1 <- sdreport(obj_2.1)
## ---------------------------------------------------------------------
obj_2.2 <- MakeADFun(data = tmbdata2.2,
                     parameters = tmbpars2.2,
                     DLL = "multiGLMM_2",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_2.2$fn()
tictoc::tic()
opt_2.2 <- nlminb(obj_2.2$par, obj_2.2$fn, obj_2.2$gr)
tictoc::toc()
sdr_2.2 <- sdreport(obj_2.2)
##----------------------------------------------------------------------
obj_2.3 <- MakeADFun(data = tmbdata2.3,
                     parameters = tmbpars2.3,
                     DLL = "multiGLMM_2",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_2.3$fn()
tictoc::tic()
opt_2.3 <- nlminb(obj_2.3$par, obj_2.3$fn, obj_2.3$gr)
tictoc::toc()
sdr_2.3 <- sdreport(obj_2.3)
```

```{r summaries_2, error=TRUE, dependson="datasimu2"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_2.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_2.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_2.3, "fixed"))
```

### 3

```{r datasimu3}
datasimu3 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(0.5, 0.25,
                                                0.25, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(173612)
df3.1 <- datasimu3(J = 1e4)
df3.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata3.1 <- list(
    Y = as.matrix(df3.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df3.1$t,
    delta = 80)
tmbpars3.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = log(0.5),
                   rhoZ = atanh(2 * 0.25))
## ---------------------------------------------------------------------
set.seed(173725)
df3.2 <- datasimu3(J = 25e3)
df3.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata3.2 <- list(
    Y = as.matrix(df3.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df3.2$t,
    delta = 80)
tmbpars3.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = log(0.5),
                   rhoZ = atanh(2 * 0.25))
## ---------------------------------------------------------------------
set.seed(173812)
df3.3 <- datasimu3(J = 50e3)
df3.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata3.3 <- list(
    Y = as.matrix(df3.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df3.3$t,
    delta = 80)
tmbpars3.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = log(0.5),
                   rhoZ = atanh(2 * 0.25))
```

```{r models_3, error=TRUE, warning=FALSE, dependson="datasimu3"}
## compile("multiGLMM_3.cpp")
dyn.load(dynlib("multiGLMM_3"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_3.1 <- MakeADFun(data = tmbdata3.1,
                     parameters = tmbpars3.1,
                     DLL = "multiGLMM_3",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_3.1$fn()
tictoc::tic()
opt_3.1 <- nlminb(obj_3.1$par, obj_3.1$fn, obj_3.1$gr)
tictoc::toc()
sdr_3.1 <- sdreport(obj_3.1)
## ---------------------------------------------------------------------
obj_3.2 <- MakeADFun(data = tmbdata3.2,
                     parameters = tmbpars3.2,
                     DLL = "multiGLMM_3",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_3.2$fn()
tictoc::tic()
opt_3.2 <- nlminb(obj_3.2$par, obj_3.2$fn, obj_3.2$gr)
tictoc::toc()
sdr_3.2 <- sdreport(obj_3.2)
##----------------------------------------------------------------------
obj_3.3 <- MakeADFun(data = tmbdata3.3,
                     parameters = tmbpars3.3,
                     DLL = "multiGLMM_3",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_3.3$fn()
tictoc::tic()
opt_3.3 <- nlminb(obj_3.3$par, obj_3.3$fn, obj_3.3$gr)
tictoc::toc()
sdr_3.3 <- sdreport(obj_3.3)
```

```{r summaries_3, error=TRUE, dependson="datasimu3"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      summary(sdr_3.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      summary(sdr_3.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      summary(sdr_3.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      opt_3.1$par, ## 1e4 pairs
      opt_3.2$par, ## 25e3
      opt_3.3$par) ## 50e3
```

### 4

```{r datasimu4}
datasimu4 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(1.0, 0.25,
                                                0.25, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(083512)
df4.1 <- datasimu4(J = 1e4)
df4.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata4.1 <- list(
    Y = as.matrix(df4.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df4.1$t,
    delta = 80)
tmbpars4.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = c(log(1), log(0.5)),
                   rhoZ = atanh(0.25/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(083602)
df4.2 <- datasimu4(J = 25e3)
df4.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata4.2 <- list(
    Y = as.matrix(df4.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df4.2$t,
    delta = 80)
tmbpars4.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)),
                   rhoZ = atanh(0.25/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(083639)
df4.3 <- datasimu4(J = 50e3)
df4.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata4.3 <- list(
    Y = as.matrix(df4.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df4.3$t,
    delta = 80)
tmbpars4.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)),
                   rhoZ = atanh(0.25/sqrt(0.5)))
```

```{r models_4, error=TRUE, warning=FALSE, dependson="datasimu4"}
## compile("multiGLMM_4.cpp")
dyn.load(dynlib("multiGLMM_4"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_4.1 <- MakeADFun(data = tmbdata4.1,
                     parameters = tmbpars4.1,
                     DLL = "multiGLMM_4",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_4.1$fn()
tictoc::tic()
opt_4.1 <- nlminb(obj_4.1$par, obj_4.1$fn, obj_4.1$gr)
tictoc::toc()
sdr_4.1 <- sdreport(obj_4.1)
## ---------------------------------------------------------------------
obj_4.2 <- MakeADFun(data = tmbdata4.2,
                     parameters = tmbpars4.2,
                     DLL = "multiGLMM_4",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_4.2$fn()
tictoc::tic()
opt_4.2 <- nlminb(obj_4.2$par, obj_4.2$fn, obj_4.2$gr)
tictoc::toc()
sdr_4.2 <- sdreport(obj_4.2)
##----------------------------------------------------------------------
obj_4.3 <- MakeADFun(data = tmbdata4.3,
                     parameters = tmbpars4.3,
                     DLL = "multiGLMM_4",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_4.3$fn()
tictoc::tic()
opt_4.3 <- nlminb(obj_4.3$par, obj_4.3$fn, obj_4.3$gr)
tictoc::toc()
sdr_4.3 <- sdreport(obj_4.3)
```

```{r summaries_4, error=TRUE, dependson="datasimu4"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      summary(sdr_4.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      summary(sdr_4.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      summary(sdr_4.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      opt_4.1$par, ## 1e4 pairs
      opt_4.2$par, ## 25e3
      opt_4.3$par) ## 50e3
```

### 5

```{r datasimu5}
datasimu5 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(0.5, 0.0,
                                                0.0, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1])
    risk2 <- exp(beta[2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(132643)
df5.1 <- datasimu5(J = 1e4)
df5.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata5.1 <- list(
    Y = as.matrix(df5.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df5.1$t,
    delta = 80)
tmbpars5.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = log(0.5))
## ---------------------------------------------------------------------
set.seed(132741)
df5.2 <- datasimu5(J = 25e3)
df5.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata5.2 <- list(
    Y = as.matrix(df5.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df5.2$t,
    delta = 80)
tmbpars5.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = log(0.5))
## ---------------------------------------------------------------------
set.seed(132810)
df5.3 <- datasimu5(J = 50e3)
df5.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata5.3 <- list(
    Y = as.matrix(df5.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df5.3$t,
    delta = 80)
tmbpars5.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = log(0.5))
```

```{r models_5, error=TRUE, warning=FALSE, dependson="datasimu5"}
## compile("multiGLMM_5.cpp")
dyn.load(dynlib("multiGLMM_5"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_5.1 <- MakeADFun(data = tmbdata5.1,
                     parameters = tmbpars5.1,
                     DLL = "multiGLMM_5",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_5.1$fn()
tictoc::tic()
opt_5.1 <- nlminb(obj_5.1$par, obj_5.1$fn, obj_5.1$gr)
tictoc::toc()
sdr_5.1 <- sdreport(obj_5.1)
## ---------------------------------------------------------------------
obj_5.2 <- MakeADFun(data = tmbdata5.2,
                     parameters = tmbpars5.2,
                     DLL = "multiGLMM_5",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_5.2$fn()
tictoc::tic()
opt_5.2 <- nlminb(obj_5.2$par, obj_5.2$fn, obj_5.2$gr)
tictoc::toc()
sdr_5.2 <- sdreport(obj_5.2)
##----------------------------------------------------------------------
obj_5.3 <- MakeADFun(data = tmbdata5.3,
                     parameters = tmbpars5.3,
                     DLL = "multiGLMM_5",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_5.3$fn()
tictoc::tic()
opt_5.3 <- nlminb(obj_5.3$par, obj_5.3$fn, obj_5.3$gr)
tictoc::toc()
sdr_5.3 <- sdreport(obj_5.3)
```

```{r summaries_5, error=TRUE, dependson="datasimu5"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5)), summary(sdr_5.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5)), summary(sdr_5.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5)), summary(sdr_5.3, "fixed"))
```

### 6

```{r datasimu6}
datasimu6 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(1.0, 0.0,
                                                0.0, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1])
    risk2 <- exp(beta[2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(150447)
df6.1 <- datasimu6(J = 1e4)
df6.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata6.1 <- list(
    Y = as.matrix(df6.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df6.1$t,
    delta = 80)
tmbpars6.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = c(log(1), log(0.5)))
## ---------------------------------------------------------------------
set.seed(150527)
df6.2 <- datasimu6(J = 25e3)
df6.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata6.2 <- list(
    Y = as.matrix(df6.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df6.2$t,
    delta = 80)
tmbpars6.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)))
## ---------------------------------------------------------------------
set.seed(150611)
df6.3 <- datasimu6(J = 50e3)
df6.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata6.3 <- list(
    Y = as.matrix(df6.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df6.3$t,
    delta = 80)
tmbpars6.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)))
```

```{r models_6, error=TRUE, warning=FALSE, dependson="datasimu6"}
## compile("multiGLMM_6.cpp")
dyn.load(dynlib("multiGLMM_6"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_6.1 <- MakeADFun(data = tmbdata6.1,
                     parameters = tmbpars6.1,
                     DLL = "multiGLMM_6",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_6.1$fn()
tictoc::tic()
opt_6.1 <- nlminb(obj_6.1$par, obj_6.1$fn, obj_6.1$gr)
tictoc::toc()
sdr_6.1 <- sdreport(obj_6.1)
## ---------------------------------------------------------------------
obj_6.2 <- MakeADFun(data = tmbdata6.2,
                     parameters = tmbpars6.2,
                     DLL = "multiGLMM_6",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_6.2$fn()
tictoc::tic()
opt_6.2 <- nlminb(obj_6.2$par, obj_6.2$fn, obj_6.2$gr)
tictoc::toc()
sdr_6.2 <- sdreport(obj_6.2)
##----------------------------------------------------------------------
obj_6.3 <- MakeADFun(data = tmbdata6.3,
                     parameters = tmbpars6.3,
                     DLL = "multiGLMM_6",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_6.3$fn()
tictoc::tic()
opt_6.3 <- nlminb(obj_6.3$par, obj_6.3$fn, obj_6.3$gr)
tictoc::toc()
sdr_6.3 <- sdreport(obj_6.3)
```

```{r summaries_6, error=TRUE, dependson="datasimu6"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_6.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_6.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_6.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      opt_6.1$par, ## 1e4
      opt_6.2$par) ## 25e3
```

### 7

```{r datasimu7}
datasimu7 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(0.5, 0.25,
                                                0.25, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1])
    risk2 <- exp(beta[2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(163308)
df7.1 <- datasimu7(J = 1e4)
df7.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata7.1 <- list(
    Y = as.matrix(df7.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df7.1$t,
    delta = 80)
tmbpars7.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = log(0.5),
                   rhoZ = atanh(2 * 0.25))
## ---------------------------------------------------------------------
set.seed(163411)
df7.2 <- datasimu7(J = 25e3)
df7.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata7.2 <- list(
    Y = as.matrix(df7.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df7.2$t,
    delta = 80)
tmbpars7.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = log(0.5),
                   rhoZ = atanh(2 * 0.25))
## ---------------------------------------------------------------------
set.seed(163454)
df7.3 <- datasimu7(J = 50e3)
df7.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata7.3 <- list(
    Y = as.matrix(df7.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df7.3$t,
    delta = 80)
tmbpars7.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = log(0.5),
                   rhoZ = atanh(2 * 0.25))
```

```{r models_7, error=TRUE, warning=FALSE, dependson="datasimu7"}
## compile("multiGLMM_7.cpp")
dyn.load(dynlib("multiGLMM_7"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_7.1 <- MakeADFun(data = tmbdata7.1,
                     parameters = tmbpars7.1,
                     DLL = "multiGLMM_7",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_7.1$fn()
tictoc::tic()
opt_7.1 <- nlminb(obj_7.1$par, obj_7.1$fn, obj_7.1$gr)
tictoc::toc()
sdr_7.1 <- sdreport(obj_7.1)
## ---------------------------------------------------------------------
obj_7.2 <- MakeADFun(data = tmbdata7.2,
                     parameters = tmbpars7.2,
                     DLL = "multiGLMM_7",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_7.2$fn()
tictoc::tic()
opt_7.2 <- nlminb(obj_7.2$par, obj_7.2$fn, obj_7.2$gr)
tictoc::toc()
sdr_7.2 <- sdreport(obj_7.2)
##----------------------------------------------------------------------
obj_7.3 <- MakeADFun(data = tmbdata7.3,
                     parameters = tmbpars7.3,
                     DLL = "multiGLMM_7",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_7.3$fn()
tictoc::tic()
opt_7.3 <- nlminb(obj_7.3$par, obj_7.3$fn, obj_7.3$gr)
tictoc::toc()
sdr_7.3 <- sdreport(obj_7.3)
```

```{r summaries_7, error=TRUE, dependson="datasimu7"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      summary(sdr_7.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      summary(sdr_7.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      summary(sdr_7.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(0.5), atanh(2 * 0.25)),
      opt_7.1$par, ## 1e4 pairs
      opt_7.2$par, ## 25e3
      opt_7.3$par) ## 50e3
```

### 8

```{r datasimu8}
datasimu8 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(1.0, 0.25,
                                                0.25, 0.5), 2, 2))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1])
    risk2 <- exp(beta[2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 1])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 2])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(174316)
df8.1 <- datasimu8(J = 1e4)
df8.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata8.1 <- list(
    Y = as.matrix(df8.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df8.1$t,
    delta = 80)
tmbpars8.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 2),
                   logs2 = c(log(1), log(0.5)),
                   rhoZ = atanh(0.25/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(174355)
df8.2 <- datasimu8(J = 25e3)
df8.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata8.2 <- list(
    Y = as.matrix(df8.2 %>% select(y1:y3)),
    Z = bdiag(replicate(25e3, rep(1, 2), simplify = FALSE)),
    T = df8.2$t,
    delta = 80)
tmbpars8.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 25e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)),
                   rhoZ = atanh(0.25/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(174433)
df8.3 <- datasimu8(J = 50e3)
df8.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata8.3 <- list(
    Y = as.matrix(df8.3 %>% select(y1:y3)),
    Z = bdiag(replicate(50e3, rep(1, 2), simplify = FALSE)),
    T = df8.3$t,
    delta = 80)
tmbpars8.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 50e3, ncol = 2),
                   logs2 = c(log(1), log(0.5)),
                   rhoZ = atanh(0.25/sqrt(0.5)))
```

```{r models_8, error=TRUE, warning=FALSE, dependson="datasimu8"}
## compile("multiGLMM_8.cpp")
dyn.load(dynlib("multiGLMM_8"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_8.1 <- MakeADFun(data = tmbdata8.1,
                     parameters = tmbpars8.1,
                     DLL = "multiGLMM_8",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_8.1$fn()
tictoc::tic()
opt_8.1 <- nlminb(obj_8.1$par, obj_8.1$fn, obj_8.1$gr)
tictoc::toc()
sdr_8.1 <- sdreport(obj_8.1)
## ---------------------------------------------------------------------
obj_8.2 <- MakeADFun(data = tmbdata8.2,
                     parameters = tmbpars8.2,
                     DLL = "multiGLMM_8",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_8.2$fn()
tictoc::tic()
opt_8.2 <- nlminb(obj_8.2$par, obj_8.2$fn, obj_8.2$gr)
tictoc::toc()
sdr_8.2 <- sdreport(obj_8.2)
##----------------------------------------------------------------------
obj_8.3 <- MakeADFun(data = tmbdata8.3,
                     parameters = tmbpars8.3,
                     DLL = "multiGLMM_8",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_8.3$fn()
tictoc::tic()
opt_8.3 <- nlminb(obj_8.3$par, obj_8.3$fn, obj_8.3$gr)
tictoc::toc()
sdr_8.3 <- sdreport(obj_8.3)
```

```{r summaries_8, error=TRUE, dependson="datasimu8"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      summary(sdr_8.1, "fixed"))
## 25e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      summary(sdr_8.2, "fixed"))
## 50e3 ----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      summary(sdr_8.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.25/sqrt(0.5))),
      opt_8.1$par, ## 1e4 pairs
      opt_8.2$par, ## 25e3
      opt_8.3$par) ## 50e3
```

### 9

```{r datasimu9}
datasimu9 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                      beta = c(-2, -1.5), gamma = c(1.2, 1),
                      w = c(3, 5), S = matrix(c(1.0, 0.0, 0.0, 0.0,
                                                0.0, 1.0, 0.0, 0.0,
                                                0.0, 0.0, 0.5, 0.0,
                                                0.0, 0.0, 0.0, 0.5),
                                              4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension

B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(111706)
df9.1 <- datasimu9(J = 1e4)
df9.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata9.1 <- list(
    Y = as.matrix(df9.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df9.1$t,
    delta = 80)
tmbpars9.1 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 1e4, ncol = 4),
                   logs2 = c(log(1), log(0.5)))
## ---------------------------------------------------------------------
set.seed(111752)
df9.2 <- datasimu9(J = 2e4)
df9.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata9.2 <- list(
    Y = as.matrix(df9.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df9.2$t,
    delta = 80)
tmbpars9.2 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 2e4, ncol = 4),
                   logs2 = c(log(1), log(0.5)))
## ---------------------------------------------------------------------
set.seed(111824)
df9.3 <- datasimu9(J = 4e4)
df9.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata9.3 <- list(
    Y = as.matrix(df9.3 %>% select(y1:y3)),
    Z = bdiag(replicate(4e4, rep(1, 2), simplify = FALSE)),
    T = df9.3$t,
    delta = 80)
tmbpars9.3 <- list(beta1 = -2,
                   beta2 = -1.5,
                   gama1 = 1.2,
                   gama2 = 1,
                   w1 = 3,
                   w2 = 5,
                   R = matrix(0, nrow = 4e4, ncol = 4),
                   logs2 = c(log(1), log(0.5)))
```

```{r models_9, error=TRUE, warning=FALSE, dependson="datasimu9"}
## compile("multiGLMM_9.cpp")
dyn.load(dynlib("multiGLMM_9"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_9.1 <- MakeADFun(data = tmbdata9.1,
                     parameters = tmbpars9.1,
                     DLL = "multiGLMM_9",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_9.1$fn()
tictoc::tic()
opt_9.1 <- nlminb(obj_9.1$par, obj_9.1$fn, obj_9.1$gr)
tictoc::toc()
sdr_9.1 <- sdreport(obj_9.1)
## ---------------------------------------------------------------------
obj_9.2 <- MakeADFun(data = tmbdata9.2,
                     parameters = tmbpars9.2,
                     DLL = "multiGLMM_9",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_9.2$fn()
tictoc::tic()
opt_9.2 <- nlminb(obj_9.2$par, obj_9.2$fn, obj_9.2$gr)
tictoc::toc()
sdr_9.2 <- sdreport(obj_9.2)
##----------------------------------------------------------------------
obj_9.3 <- MakeADFun(data = tmbdata9.3,
                     parameters = tmbpars9.3,
                     DLL = "multiGLMM_9",
                     random = "R",
                     hessian = TRUE, silent = TRUE)
obj_9.3$fn()
tictoc::tic()
opt_9.3 <- nlminb(obj_9.3$par, obj_9.3$fn, obj_9.3$gr)
tictoc::toc()
sdr_9.3 <- sdreport(obj_9.3)
```

```{r summaries_9, error=TRUE, dependson="datasimu9"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_9.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_9.2, "fixed"))
## 4e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5)),
      summary(sdr_9.3, "fixed"))
```

### 10

```{r datasimu10}
datasimu10 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.0, 0.0,
                                                 0.0, 1.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.5, 0.0,
                                                 0.0, 0.0, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(132428)
df10.1 <- datasimu10(J = 1e4)
df10.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata10.1 <- list(
    Y = as.matrix(df10.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df10.1$t,
    delta = 80)
tmbpars10.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)))
## ---------------------------------------------------------------------
set.seed(132536)
df10.2 <- datasimu10(J = 2e4)
df10.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata10.2 <- list(
    Y = as.matrix(df10.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df10.2$t,
    delta = 80)
tmbpars10.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)))
## ---------------------------------------------------------------------
set.seed(132720)
df10.3 <- datasimu10(J = 4e4)
df10.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata10.3 <- list(
    Y = as.matrix(df10.3 %>% select(y1:y3)),
    Z = bdiag(replicate(4e4, rep(1, 2), simplify = FALSE)),
    T = df10.3$t,
    delta = 80)
tmbpars10.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 4e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)))
```

```{r models_10, error=TRUE, warning=FALSE, dependson="datasimu10"}
## compile("multiGLMM_10.cpp")
dyn.load(dynlib("multiGLMM_10"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_10.1 <- MakeADFun(data = tmbdata10.1,
                      parameters = tmbpars10.1,
                      DLL = "multiGLMM_10",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_10.1$fn()
tictoc::tic()
opt_10.1 <- nlminb(obj_10.1$par, obj_10.1$fn, obj_10.1$gr)
tictoc::toc()
sdr_10.1 <- sdreport(obj_10.1)
## ---------------------------------------------------------------------
obj_10.2 <- MakeADFun(data = tmbdata10.2,
                      parameters = tmbpars10.2,
                      DLL = "multiGLMM_10",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_10.2$fn()
tictoc::tic()
opt_10.2 <- nlminb(obj_10.2$par, obj_10.2$fn, obj_10.2$gr)
tictoc::toc()
sdr_10.2 <- sdreport(obj_10.2)
##----------------------------------------------------------------------
obj_10.3 <- MakeADFun(data = tmbdata10.3,
                      parameters = tmbpars10.3,
                      DLL = "multiGLMM_10",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_10.3$fn()
tictoc::tic()
opt_10.3 <- nlminb(obj_10.3$par, obj_10.3$fn, obj_10.3$gr)
tictoc::toc()
sdr_10.3 <- sdreport(obj_10.3)
```

```{r summaries_10, error=TRUE, dependson="datasimu10"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5)),
      summary(sdr_10.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5)),
      summary(sdr_10.2, "fixed"))
## 4e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5)),
      summary(sdr_10.3, "fixed"))
```

### 11

```{r datasimu11}
datasimu11 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.5, 0.0, 0.0,
                                                 0.5, 1.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.5, 0.0,
                                                 0.0, 0.0, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(164922)
df11.1 <- datasimu11(J = 1e4)
df11.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata11.1 <- list(
    Y = as.matrix(df11.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df11.1$t,
    delta = 80)
tmbpars11.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(0.5))
## ---------------------------------------------------------------------
set.seed(165023)
df11.2 <- datasimu11(J = 2e4)
df11.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata11.2 <- list(
    Y = as.matrix(df11.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df11.2$t,
    delta = 80)
tmbpars11.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(0.5))
## ---------------------------------------------------------------------
set.seed(165101)
df11.3 <- datasimu11(J = 3e4)
df11.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata11.3 <- list(
    Y = as.matrix(df11.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df11.3$t,
    delta = 80)
tmbpars11.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(0.5))
```

```{r models_11, error=TRUE, warning=FALSE, dependson="datasimu11"}
## compile("multiGLMM_11.cpp")
dyn.load(dynlib("multiGLMM_11"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_11.1 <- MakeADFun(data = tmbdata11.1,
                      parameters = tmbpars11.1,
                      DLL = "multiGLMM_11",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_11.1$fn()
tictoc::tic()
opt_11.1 <- nlminb(obj_11.1$par, obj_11.1$fn, obj_11.1$gr)
tictoc::toc()
sdr_11.1 <- sdreport(obj_11.1)
## ---------------------------------------------------------------------
obj_11.2 <- MakeADFun(data = tmbdata11.2,
                      parameters = tmbpars11.2,
                      DLL = "multiGLMM_11",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_11.2$fn()
tictoc::tic()
opt_11.2 <- nlminb(obj_11.2$par, obj_11.2$fn, obj_11.2$gr)
tictoc::toc()
sdr_11.2 <- sdreport(obj_11.2)
##----------------------------------------------------------------------
obj_11.3 <- MakeADFun(data = tmbdata11.3,
                      parameters = tmbpars11.3,
                      DLL = "multiGLMM_11",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_11.3$fn()
tictoc::tic()
opt_11.3 <- nlminb(obj_11.3$par, obj_11.3$fn, obj_11.3$gr)
tictoc::toc()
sdr_11.3 <- sdreport(obj_11.3)
```

```{r summaries_11, error=TRUE, dependson="datasimu11"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(0.5)),
      summary(sdr_11.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(0.5)),
      summary(sdr_11.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(0.5)),
      summary(sdr_11.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(0.5)),
      opt_11.1$par, ## 1e4 pairs
      opt_11.2$par, ## 2e4
      opt_11.3$par) ## 3e4
```

### 12

```{r datasimu12}
datasimu12 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.5, 0.0, 0.0,
                                                 0.5, 1.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.5, 0.0,
                                                 0.0, 0.0, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(090722)
df12.1 <- datasimu12(J = 1e4)
df12.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata12.1 <- list(
    Y = as.matrix(df12.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df12.1$t,
    delta = 80)
tmbpars12.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(0.5))
## ---------------------------------------------------------------------
set.seed(090806)
df12.2 <- datasimu12(J = 2e4)
df12.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata12.2 <- list(
    Y = as.matrix(df12.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df12.2$t,
    delta = 80)
tmbpars12.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(0.5))
## ---------------------------------------------------------------------
set.seed(090843)
df12.3 <- datasimu12(J = 3e4)
df12.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata12.3 <- list(
    Y = as.matrix(df12.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df12.3$t,
    delta = 80)
tmbpars12.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(0.5))
```

```{r models_12, error=TRUE, warning=FALSE, dependson="datasimu12"}
## compile("multiGLMM_12.cpp")
dyn.load(dynlib("multiGLMM_12"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_12.1 <- MakeADFun(data = tmbdata12.1,
                      parameters = tmbpars12.1,
                      DLL = "multiGLMM_12",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_12.1$fn()
tictoc::tic()
opt_12.1 <- nlminb(obj_12.1$par, obj_12.1$fn, obj_12.1$gr)
tictoc::toc()
sdr_12.1 <- sdreport(obj_12.1)
## ---------------------------------------------------------------------
obj_12.2 <- MakeADFun(data = tmbdata12.2,
                      parameters = tmbpars12.2,
                      DLL = "multiGLMM_12",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_12.2$fn()
tictoc::tic()
opt_12.2 <- nlminb(obj_12.2$par, obj_12.2$fn, obj_12.2$gr)
tictoc::toc()
sdr_12.2 <- sdreport(obj_12.2)
##----------------------------------------------------------------------
obj_12.3 <- MakeADFun(data = tmbdata12.3,
                      parameters = tmbpars12.3,
                      DLL = "multiGLMM_12",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_12.3$fn()
tictoc::tic()
opt_12.3 <- nlminb(obj_12.3$par, obj_12.3$fn, obj_12.3$gr)
tictoc::toc()
sdr_12.3 <- sdreport(obj_12.3)
```

```{r summaries_12, error=TRUE, dependson="datasimu12"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.5)),
      summary(sdr_12.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.5)),
      summary(sdr_12.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.5)),
      summary(sdr_12.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.5)),
      opt_12.1$par, ## 1e4 pairs
      opt_12.2$par, ## 2e4
      opt_12.3$par) ## 3e4
```

### 13

```{r datasimu13}
datasimu13 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.0, 0.0,
                                                 0.0, 1.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(105757)
df13.1 <- datasimu13(J = 1e4)
df13.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata13.1 <- list(
    Y = as.matrix(df13.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df13.1$t,
    delta = 80)
tmbpars13.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(2 * 0.2))
## ---------------------------------------------------------------------
set.seed(110249)
df13.2 <- datasimu13(J = 2e4)
df13.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata13.2 <- list(
    Y = as.matrix(df13.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df13.2$t,
    delta = 80)
tmbpars13.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(2 * 0.2))
## ---------------------------------------------------------------------
set.seed(110340)
df13.3 <- datasimu13(J = 3e4)
df13.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata13.3 <- list(
    Y = as.matrix(df13.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df13.3$t,
    delta = 80)
tmbpars13.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(2 * 0.2))
```

```{r models_13, error=TRUE, warning=FALSE, dependson="datasimu13"}
## compile("multiGLMM_13.cpp")
dyn.load(dynlib("multiGLMM_13"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_13.1 <- MakeADFun(data = tmbdata13.1,
                      parameters = tmbpars13.1,
                      DLL = "multiGLMM_13",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_13.1$fn()
tictoc::tic()
opt_13.1 <- nlminb(obj_13.1$par, obj_13.1$fn, obj_13.1$gr)
tictoc::toc()
sdr_13.1 <- sdreport(obj_13.1)
## ---------------------------------------------------------------------
obj_13.2 <- MakeADFun(data = tmbdata13.2,
                      parameters = tmbpars13.2,
                      DLL = "multiGLMM_13",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_13.2$fn()
tictoc::tic()
opt_13.2 <- nlminb(obj_13.2$par, obj_13.2$fn, obj_13.2$gr)
tictoc::toc()
sdr_13.2 <- sdreport(obj_13.2)
##----------------------------------------------------------------------
obj_13.3 <- MakeADFun(data = tmbdata13.3,
                      parameters = tmbpars13.3,
                      DLL = "multiGLMM_13",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_13.3$fn()
tictoc::tic()
opt_13.3 <- nlminb(obj_13.3$par, obj_13.3$fn, obj_13.3$gr)
tictoc::toc()
sdr_13.3 <- sdreport(obj_13.3)
```

```{r summaries_13, error=TRUE, dependson="datasimu13"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(2 * 0.2)),
      summary(sdr_13.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(2 * 0.2)),
      summary(sdr_13.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(2 * 0.2)),
      summary(sdr_13.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(2 * 0.2)),
      opt_13.1$par, ## 1e4 pairs
      opt_13.2$par, ## 2e4
      opt_13.3$par) ## 3e4
```

### 14

```{r datasimu14}
datasimu14 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.0, 0.0,
                                                 0.0, 1.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(131606)
df14.1 <- datasimu14(J = 1e4)
df14.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata14.1 <- list(
    Y = as.matrix(df14.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df14.1$t,
    delta = 80)
tmbpars14.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(2 * 0.2))
## ---------------------------------------------------------------------
set.seed(131642)
df14.2 <- datasimu14(J = 2e4)
df14.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata14.2 <- list(
    Y = as.matrix(df14.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df14.2$t,
    delta = 80)
tmbpars14.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(2 * 0.2))
## ---------------------------------------------------------------------
set.seed(131713)
df14.3 <- datasimu14(J = 3e4)
df14.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata14.3 <- list(
    Y = as.matrix(df14.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df14.3$t,
    delta = 80)
tmbpars14.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(2 * 0.2))
```

```{r models_14, error=TRUE, warning=FALSE, dependson="datasimu14"}
## compile("multiGLMM_14.cpp")
dyn.load(dynlib("multiGLMM_14"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_14.1 <- MakeADFun(data = tmbdata14.1,
                      parameters = tmbpars14.1,
                      DLL = "multiGLMM_14",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_14.1$fn()
tictoc::tic()
opt_14.1 <- nlminb(obj_14.1$par, obj_14.1$fn, obj_14.1$gr)
tictoc::toc()
sdr_14.1 <- sdreport(obj_14.1)
## ---------------------------------------------------------------------
obj_14.2 <- MakeADFun(data = tmbdata14.2,
                      parameters = tmbpars14.2,
                      DLL = "multiGLMM_14",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_14.2$fn()
tictoc::tic()
opt_14.2 <- nlminb(obj_14.2$par, obj_14.2$fn, obj_14.2$gr)
tictoc::toc()
sdr_14.2 <- sdreport(obj_14.2)
##----------------------------------------------------------------------
obj_14.3 <- MakeADFun(data = tmbdata14.3,
                      parameters = tmbpars14.3,
                      DLL = "multiGLMM_14",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_14.3$fn()
tictoc::tic()
opt_14.3 <- nlminb(obj_14.3$par, obj_14.3$fn, obj_14.3$gr)
tictoc::toc()
sdr_14.3 <- sdreport(obj_14.3)
```

```{r summaries_14, error=TRUE, dependson="datasimu14"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(2 * 0.2)),
      summary(sdr_14.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(2 * 0.2)),
      summary(sdr_14.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(2 * 0.2)),
      summary(sdr_14.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(2 * 0.2)),
      opt_14.1$par, ## 1e4 pairs
      opt_14.2$par, ## 2e4
      opt_14.3$par) ## 3e4
```

### 15

```{r datasimu15}
datasimu15 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.0, 0.0,
                                                 0.4, 1.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(130038)
df15.1 <- datasimu15(J = 1e4)
df15.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata15.1 <- list(
    Y = as.matrix(df15.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df15.1$t,
    delta = 80)
tmbpars15.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2)))
## ---------------------------------------------------------------------
set.seed(130127)
df15.2 <- datasimu15(J = 2e4)
df15.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata15.2 <- list(
    Y = as.matrix(df15.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df15.2$t,
    delta = 80)
tmbpars15.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2)))
## ---------------------------------------------------------------------
set.seed(130215)
df15.3 <- datasimu15(J = 3e4)
df15.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata15.3 <- list(
    Y = as.matrix(df15.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df15.3$t,
    delta = 80)
tmbpars15.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2)))
```

```{r models_15, error=TRUE, warning=FALSE, dependson="datasimu15"}
## compile("multiGLMM_15.cpp")
dyn.load(dynlib("multiGLMM_15"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_15.1 <- MakeADFun(data = tmbdata15.1,
                      parameters = tmbpars15.1,
                      DLL = "multiGLMM_15",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_15.1$fn()
tictoc::tic()
opt_15.1 <- nlminb(obj_15.1$par, obj_15.1$fn, obj_15.1$gr)
tictoc::toc()
sdr_15.1 <- sdreport(obj_15.1)
## ---------------------------------------------------------------------
obj_15.2 <- MakeADFun(data = tmbdata15.2,
                      parameters = tmbpars15.2,
                      DLL = "multiGLMM_15",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_15.2$fn()
tictoc::tic()
opt_15.2 <- nlminb(obj_15.2$par, obj_15.2$fn, obj_15.2$gr)
tictoc::toc()
sdr_15.2 <- sdreport(obj_15.2)
##----------------------------------------------------------------------
obj_15.3 <- MakeADFun(data = tmbdata15.3,
                      parameters = tmbpars15.3,
                      DLL = "multiGLMM_15",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_15.3$fn()
tictoc::tic()
opt_15.3 <- nlminb(obj_15.3$par, obj_15.3$fn, obj_15.3$gr)
tictoc::toc()
sdr_15.3 <- sdreport(obj_15.3)
```

```{r summaries_15, error=TRUE, dependson="datasimu15"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(2 * 0.2)),
      summary(sdr_15.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(2 * 0.2)),
      summary(sdr_15.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(2 * 0.2)),
      summary(sdr_15.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(2 * 0.2)),
      opt_15.1$par, ## 1e4 pairs
      opt_15.2$par, ## 2e4
      opt_15.3$par) ## 3e4
```

### 16

```{r datasimu16}
datasimu16 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.0, 0.0,
                                                 0.4, 1.0, 0.0, 0.0,
                                                 0.0, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(123240)
df16.1 <- datasimu16(J = 1e4)
df16.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata16.1 <- list(
    Y = as.matrix(df16.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df16.1$t,
    delta = 80)
tmbpars16.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2)))
## ---------------------------------------------------------------------
set.seed(133323)
df16.2 <- datasimu16(J = 2e4)
df16.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata16.2 <- list(
    Y = as.matrix(df16.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df16.2$t,
    delta = 80)
tmbpars16.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2)))
## ---------------------------------------------------------------------
set.seed(123356)
df16.3 <- datasimu16(J = 3e4)
df16.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata16.3 <- list(
    Y = as.matrix(df16.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df16.3$t,
    delta = 80)
tmbpars16.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2)))
```

```{r models_16, error=TRUE, warning=FALSE, dependson="datasimu16"}
## compile("multiGLMM_16.cpp")
dyn.load(dynlib("multiGLMM_16"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_16.1 <- MakeADFun(data = tmbdata16.1,
                      parameters = tmbpars16.1,
                      DLL = "multiGLMM_16",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_16.1$fn()
tictoc::tic()
opt_16.1 <- nlminb(obj_16.1$par, obj_16.1$fn, obj_16.1$gr)
tictoc::toc()
sdr_16.1 <- sdreport(obj_16.1)
## ---------------------------------------------------------------------
obj_16.2 <- MakeADFun(data = tmbdata16.2,
                      parameters = tmbpars16.2,
                      DLL = "multiGLMM_16",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_16.2$fn()
tictoc::tic()
opt_16.2 <- nlminb(obj_16.2$par, obj_16.2$fn, obj_16.2$gr)
tictoc::toc()
sdr_16.2 <- sdreport(obj_16.2)
##----------------------------------------------------------------------
obj_16.3 <- MakeADFun(data = tmbdata16.3,
                      parameters = tmbpars16.3,
                      DLL = "multiGLMM_16",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_16.3$fn()
tictoc::tic()
opt_16.3 <- nlminb(obj_16.3$par, obj_16.3$fn, obj_16.3$gr)
tictoc::toc()
sdr_16.3 <- sdreport(obj_16.3)
```

```{r summaries_16, error=TRUE, dependson="datasimu16"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.4), atanh(2 * 0.2)),
      summary(sdr_16.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.4), atanh(2 * 0.2)),
      summary(sdr_16.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.4), atanh(2 * 0.2)),
      summary(sdr_16.3, "fixed"))
```

### 17

```{r datasimu17}
datasimu17 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(141219)
df17.1 <- datasimu17(J = 1e4)
df17.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata17.1 <- list(
    Y = as.matrix(df17.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df17.1$t,
    delta = 80)
tmbpars17.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(141602)
df17.2 <- datasimu17(J = 2e4)
df17.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata17.2 <- list(
    Y = as.matrix(df17.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df17.2$t,
    delta = 80)
tmbpars17.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(141655)
df17.3 <- datasimu17(J = 3e4)
df17.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata17.3 <- list(
    Y = as.matrix(df17.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df17.3$t,
    delta = 80)
tmbpars17.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5))))
```

```{r models_17, error=TRUE, warning=FALSE, dependson="datasimu17"}
## compile("multiGLMM_17.cpp")
dyn.load(dynlib("multiGLMM_17"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_17.1 <- MakeADFun(data = tmbdata17.1,
                      parameters = tmbpars17.1,
                      DLL = "multiGLMM_17",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_17.1$fn()
tictoc::tic()
opt_17.1 <- nlminb(obj_17.1$par, obj_17.1$fn, obj_17.1$gr)
tictoc::toc()
sdr_17.1 <- sdreport(obj_17.1)
## ---------------------------------------------------------------------
obj_17.2 <- MakeADFun(data = tmbdata17.2,
                      parameters = tmbpars17.2,
                      DLL = "multiGLMM_17",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_17.2$fn()
tictoc::tic()
opt_17.2 <- nlminb(obj_17.2$par, obj_17.2$fn, obj_17.2$gr)
tictoc::toc()
sdr_17.2 <- sdreport(obj_17.2)
##----------------------------------------------------------------------
obj_17.3 <- MakeADFun(data = tmbdata17.3,
                      parameters = tmbpars17.3,
                      DLL = "multiGLMM_17",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_17.3$fn()
tictoc::tic()
opt_17.3 <- nlminb(obj_17.3$par, obj_17.3$fn, obj_17.3$gr)
tictoc::toc()
sdr_17.3 <- sdreport(obj_17.3)
```

```{r summaries_17, error=TRUE, dependson="datasimu17"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_17.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_17.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_17.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      opt_17.1$par, ## 1e4 pairs
      opt_17.2$par, ## 2e4
      opt_17.3$par) ## 3e4
```

### 18

```{r datasimu18}
datasimu18 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(162933)
df18.1 <- datasimu18(J = 1e4)
df18.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata18.1 <- list(
    Y = as.matrix(df18.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df18.1$t,
    delta = 80)
tmbpars18.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(163055)
df18.2 <- datasimu18(J = 2e4)
df18.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata18.2 <- list(
    Y = as.matrix(df18.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df18.2$t,
    delta = 80)
tmbpars18.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(163137)
df18.3 <- datasimu18(J = 3e4)
df18.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata18.3 <- list(
    Y = as.matrix(df18.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df18.3$t,
    delta = 80)
tmbpars18.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5))))
```

```{r models_18, error=TRUE, warning=FALSE, dependson="datasimu18"}
## compile("multiGLMM_18.cpp")
dyn.load(dynlib("multiGLMM_18"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_18.1 <- MakeADFun(data = tmbdata18.1,
                      parameters = tmbpars18.1,
                      DLL = "multiGLMM_18",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_18.1$fn()
tictoc::tic()
opt_18.1 <- nlminb(obj_18.1$par, obj_18.1$fn, obj_18.1$gr)
tictoc::toc()
sdr_18.1 <- sdreport(obj_18.1)
## ---------------------------------------------------------------------
obj_18.2 <- MakeADFun(data = tmbdata18.2,
                      parameters = tmbpars18.2,
                      DLL = "multiGLMM_18",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_18.2$fn()
tictoc::tic()
opt_18.2 <- nlminb(obj_18.2$par, obj_18.2$fn, obj_18.2$gr)
tictoc::toc()
sdr_18.2 <- sdreport(obj_18.2)
##----------------------------------------------------------------------
obj_18.3 <- MakeADFun(data = tmbdata18.3,
                      parameters = tmbpars18.3,
                      DLL = "multiGLMM_18",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_18.3$fn()
tictoc::tic()
opt_18.3 <- nlminb(obj_18.3$par, obj_18.3$fn, obj_18.3$gr)
tictoc::toc()
sdr_18.3 <- sdreport(obj_18.3)
```

```{r summaries_18, error=TRUE, dependson="datasimu18"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_18.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_18.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_18.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      opt_18.1$par, ## 1e4 pairs
      opt_18.2$par, ## 2e4
      opt_18.3$par) ## 3e4
```

### 19

```{r datasimu19}
datasimu19 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.0, 0.0,
                                                 0.4, 1.0, 0.0, 0.1,
                                                 0.0, 0.0, 0.5, 0.2,
                                                 0.0, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(182838)
df19.1 <- datasimu19(J = 1e4)
df19.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata19.1 <- list(
    Y = as.matrix(df19.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df19.1$t,
    delta = 80)
tmbpars19.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(182937)
df19.2 <- datasimu19(J = 2e4)
df19.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata19.2 <- list(
    Y = as.matrix(df19.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df19.2$t,
    delta = 80)
tmbpars19.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(183018)
df19.3 <- datasimu19(J = 3e4)
df19.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata19.3 <- list(
    Y = as.matrix(df19.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df19.3$t,
    delta = 80)
tmbpars19.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_19, error=TRUE, warning=FALSE, dependson="datasimu19"}
## compile("multiGLMM_19.cpp")
dyn.load(dynlib("multiGLMM_19"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_19.1 <- MakeADFun(data = tmbdata19.1,
                      parameters = tmbpars19.1,
                      DLL = "multiGLMM_19",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_19.1$fn()
tictoc::tic()
opt_19.1 <- nlminb(obj_19.1$par, obj_19.1$fn, obj_19.1$gr)
tictoc::toc()
sdr_19.1 <- sdreport(obj_19.1)
## ---------------------------------------------------------------------
obj_19.2 <- MakeADFun(data = tmbdata19.2,
                      parameters = tmbpars19.2,
                      DLL = "multiGLMM_19",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_19.2$fn()
tictoc::tic()
opt_19.2 <- nlminb(obj_19.2$par, obj_19.2$fn, obj_19.2$gr)
tictoc::toc()
sdr_19.2 <- sdreport(obj_19.2)
##----------------------------------------------------------------------
obj_19.3 <- MakeADFun(data = tmbdata19.3,
                      parameters = tmbpars19.3,
                      DLL = "multiGLMM_19",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_19.3$fn()
tictoc::tic()
opt_19.3 <- nlminb(obj_19.3$par, obj_19.3$fn, obj_19.3$gr)
tictoc::toc()
sdr_19.3 <- sdreport(obj_19.3)
```

```{r summaries_19, error=TRUE, dependson="datasimu19"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      summary(sdr_19.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      summary(sdr_19.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      summary(sdr_19.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      opt_19.1$par, ## 1e4 pairs
      opt_19.2$par, ## 2e4
      opt_19.3$par) ## 3e4
```

### 20

```{r datasimu20}
datasimu20 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.0, 0.0,
                                                 0.4, 1.0, 0.0, 0.1,
                                                 0.0, 0.0, 0.5, 0.2,
                                                 0.0, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(205253)
df20.1 <- datasimu20(J = 1e4)
df20.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata20.1 <- list(
    Y = as.matrix(df20.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df20.1$t,
    delta = 80)
tmbpars20.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(205344)
df20.2 <- datasimu20(J = 2e4)
df20.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata20.2 <- list(
    Y = as.matrix(df20.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df20.2$t,
    delta = 80)
tmbpars20.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(205427)
df20.3 <- datasimu20(J = 3e4)
df20.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata20.3 <- list(
    Y = as.matrix(df20.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df20.3$t,
    delta = 80)
tmbpars20.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_20, error=TRUE, warning=FALSE, dependson="datasimu20"}
## compile("multiGLMM_20.cpp")
dyn.load(dynlib("multiGLMM_20"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_20.1 <- MakeADFun(data = tmbdata20.1,
                      parameters = tmbpars20.1,
                      DLL = "multiGLMM_20",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_20.1$fn()
tictoc::tic()
opt_20.1 <- nlminb(obj_20.1$par, obj_20.1$fn, obj_20.1$gr)
tictoc::toc()
sdr_20.1 <- sdreport(obj_20.1)
## ---------------------------------------------------------------------
obj_20.2 <- MakeADFun(data = tmbdata20.2,
                      parameters = tmbpars20.2,
                      DLL = "multiGLMM_20",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_20.2$fn()
tictoc::tic()
opt_20.2 <- nlminb(obj_20.2$par, obj_20.2$fn, obj_20.2$gr)
tictoc::toc()
sdr_20.2 <- sdreport(obj_20.2)
##----------------------------------------------------------------------
obj_20.3 <- MakeADFun(data = tmbdata20.3,
                      parameters = tmbpars20.3,
                      DLL = "multiGLMM_20",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_20.3$fn()
tictoc::tic()
opt_20.3 <- nlminb(obj_20.3$par, obj_20.3$fn, obj_20.3$gr)
tictoc::toc()
sdr_20.3 <- sdreport(obj_20.3)
```

```{r summaries_20, error=TRUE, dependson="datasimu20"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      summary(sdr_20.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      summary(sdr_20.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      summary(sdr_20.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2), atanh(0.1/sqrt(0.5))),
      opt_20.1$par, ## 1e4 pairs
      opt_20.2$par, ## 2e4
      opt_20.3$par) ## 3e4
```

### 21

```{r datasimu21}
datasimu21 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(092103)
df21.1 <- datasimu21(J = 1e4)
df21.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata21.1 <- list(
    Y = as.matrix(df21.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df21.1$t,
    delta = 80)
tmbpars21.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(092201)
df21.2 <- datasimu21(J = 2e4)
df21.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata21.2 <- list(
    Y = as.matrix(df21.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df21.2$t,
    delta = 80)
tmbpars21.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(092245)
df21.3 <- datasimu21(J = 3e4)
df21.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata21.3 <- list(
    Y = as.matrix(df21.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df21.3$t,
    delta = 80)
tmbpars21.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_21, error=TRUE, warning=FALSE, dependson="datasimu21"}
## compile("multiGLMM_21.cpp")
dyn.load(dynlib("multiGLMM_21"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_21.1 <- MakeADFun(data = tmbdata21.1,
                      parameters = tmbpars21.1,
                      DLL = "multiGLMM_21",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_21.1$fn()
tictoc::tic()
opt_21.1 <- nlminb(obj_21.1$par, obj_21.1$fn, obj_21.1$gr)
tictoc::toc()
sdr_21.1 <- sdreport(obj_21.1)
## ---------------------------------------------------------------------
obj_21.2 <- MakeADFun(data = tmbdata21.2,
                      parameters = tmbpars21.2,
                      DLL = "multiGLMM_21",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_21.2$fn()
tictoc::tic()
opt_21.2 <- nlminb(obj_21.2$par, obj_21.2$fn, obj_21.2$gr)
tictoc::toc()
sdr_21.2 <- sdreport(obj_21.2)
##----------------------------------------------------------------------
obj_21.3 <- MakeADFun(data = tmbdata21.3,
                      parameters = tmbpars21.3,
                      DLL = "multiGLMM_21",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_21.3$fn()
tictoc::tic()
opt_21.3 <- nlminb(obj_21.3$par, obj_21.3$fn, obj_21.3$gr)
tictoc::toc()
sdr_21.3 <- sdreport(obj_21.3)
```

```{r summaries_21, error=TRUE, dependson="datasimu21"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_21.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_21.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_21.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_21.1$par, ## 1e4 pairs
      opt_21.2$par, ## 2e4
      opt_21.3$par) ## 3e4
```

### 22

```{r datasimu22}
datasimu22 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(115519)
df22.1 <- datasimu22(J = 1e4)
df22.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata22.1 <- list(
    Y = as.matrix(df22.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df22.1$t,
    delta = 80)
tmbpars22.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(115557)
df22.2 <- datasimu22(J = 2e4)
df22.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata22.2 <- list(
    Y = as.matrix(df22.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df22.2$t,
    delta = 80)
tmbpars22.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(115631)
df22.3 <- datasimu22(J = 3e4)
df22.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata22.3 <- list(
    Y = as.matrix(df22.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df22.3$t,
    delta = 80)
tmbpars22.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_22, error=TRUE, warning=FALSE, dependson="datasimu22"}
## compile("multiGLMM_22.cpp")
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_22.1 <- MakeADFun(data = tmbdata22.1,
                      parameters = tmbpars22.1,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.1$fn()
tictoc::tic()
opt_22.1 <- nlminb(obj_22.1$par, obj_22.1$fn, obj_22.1$gr)
tictoc::toc()
sdr_22.1 <- sdreport(obj_22.1)
## ---------------------------------------------------------------------
obj_22.2 <- MakeADFun(data = tmbdata22.2,
                      parameters = tmbpars22.2,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.2$fn()
tictoc::tic()
opt_22.2 <- nlminb(obj_22.2$par, obj_22.2$fn, obj_22.2$gr)
tictoc::toc()
sdr_22.2 <- sdreport(obj_22.2)
##----------------------------------------------------------------------
obj_22.3 <- MakeADFun(data = tmbdata22.3,
                      parameters = tmbpars22.3,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.3$fn()
tictoc::tic()
opt_22.3 <- nlminb(obj_22.3$par, obj_22.3$fn, obj_22.3$gr)
tictoc::toc()
sdr_22.3 <- sdreport(obj_22.3)
```

```{r summaries_22, error=TRUE, dependson="datasimu22"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_22.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_22.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_22.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.1$par, ## 1e4 pairs
      opt_22.2$par, ## 2e4
      opt_22.3$par) ## 3e4
```

### 23

```{r datasimu23}
datasimu23 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.0, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(174833)
df23.1 <- datasimu23(J = 1e4)
df23.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata23.1 <- list(
    Y = as.matrix(df23.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df23.1$t,
    delta = 80)
tmbpars23.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(0.2/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(175021)
df23.2 <- datasimu23(J = 2e4)
df23.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata23.2 <- list(
    Y = as.matrix(df23.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df23.2$t,
    delta = 80)
tmbpars23.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(0.2/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(175113)
df23.3 <- datasimu23(J = 3e4)
df23.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata23.3 <- list(
    Y = as.matrix(df23.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df23.3$t,
    delta = 80)
tmbpars23.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = atanh(0.2/sqrt(0.5)))
```

```{r models_23, error=TRUE, warning=FALSE, dependson="datasimu23"}
## compile("multiGLMM_23.cpp")
dyn.load(dynlib("multiGLMM_23"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_23.1 <- MakeADFun(data = tmbdata23.1,
                      parameters = tmbpars23.1,
                      DLL = "multiGLMM_23",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_23.1$fn()
tictoc::tic()
opt_23.1 <- nlminb(obj_23.1$par, obj_23.1$fn, obj_23.1$gr)
tictoc::toc()
sdr_23.1 <- sdreport(obj_23.1)
## ---------------------------------------------------------------------
obj_23.2 <- MakeADFun(data = tmbdata23.2,
                      parameters = tmbpars23.2,
                      DLL = "multiGLMM_23",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_23.2$fn()
tictoc::tic()
opt_23.2 <- nlminb(obj_23.2$par, obj_23.2$fn, obj_23.2$gr)
tictoc::toc()
sdr_23.2 <- sdreport(obj_23.2)
##----------------------------------------------------------------------
obj_23.3 <- MakeADFun(data = tmbdata23.3,
                      parameters = tmbpars23.3,
                      DLL = "multiGLMM_23",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_23.3$fn()
tictoc::tic()
opt_23.3 <- nlminb(obj_23.3$par, obj_23.3$fn, obj_23.3$gr)
tictoc::toc()
sdr_23.3 <- sdreport(obj_23.3)
```

```{r summaries_23, error=TRUE, dependson="datasimu23"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(0.2/sqrt(0.5))),
      summary(sdr_23.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(0.2/sqrt(0.5))),
      summary(sdr_23.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5), atanh(0.2/sqrt(0.5))),
      summary(sdr_23.3, "fixed"))
```

### 24

```{r datasimu24}
datasimu24 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.0, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(111521)
df24.1 <- datasimu24(J = 1e4)
df24.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata24.1 <- list(
    Y = as.matrix(df24.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df24.1$t,
    delta = 80)
tmbpars24.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(0.2/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(114613)
df24.2 <- datasimu24(J = 2e4)
df24.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata24.2 <- list(
    Y = as.matrix(df24.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df24.2$t,
    delta = 80)
tmbpars24.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(0.2/sqrt(0.5)))
## ---------------------------------------------------------------------
set.seed(114619)
df24.3 <- datasimu24(J = 3e4)
df24.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata24.3 <- list(
    Y = as.matrix(df24.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df24.3$t,
    delta = 80)
tmbpars24.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = atanh(0.2/sqrt(0.5)))
```

```{r models_24, error=TRUE, warning=FALSE, dependson="datasimu24"}
## compile("multiGLMM_24.cpp")
dyn.load(dynlib("multiGLMM_24"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_24.1 <- MakeADFun(data = tmbdata24.1,
                      parameters = tmbpars24.1,
                      DLL = "multiGLMM_24",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_24.1$fn()
tictoc::tic()
opt_24.1 <- nlminb(obj_24.1$par, obj_24.1$fn, obj_24.1$gr)
tictoc::toc()
sdr_24.1 <- sdreport(obj_24.1)
## ---------------------------------------------------------------------
obj_24.2 <- MakeADFun(data = tmbdata24.2,
                      parameters = tmbpars24.2,
                      DLL = "multiGLMM_24",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_24.2$fn()
tictoc::tic()
opt_24.2 <- nlminb(obj_24.2$par, obj_24.2$fn, obj_24.2$gr)
tictoc::toc()
sdr_24.2 <- sdreport(obj_24.2)
##----------------------------------------------------------------------
obj_24.3 <- MakeADFun(data = tmbdata24.3,
                      parameters = tmbpars24.3,
                      DLL = "multiGLMM_24",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_24.3$fn()
tictoc::tic()
opt_24.3 <- nlminb(obj_24.3$par, obj_24.3$fn, obj_24.3$gr)
tictoc::toc()
sdr_24.3 <- sdreport(obj_24.3)
```

```{r summaries_24, error=TRUE, dependson="datasimu24"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.2/sqrt(0.5))),
      summary(sdr_24.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.2/sqrt(0.5))),
      summary(sdr_24.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5), atanh(0.2/sqrt(0.5))),
      summary(sdr_24.3, "fixed"))
```

### 25

```{r datasimu25}
datasimu25 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.0, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(114638)
df25.1 <- datasimu25(J = 1e4)
df25.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata25.1 <- list(
    Y = as.matrix(df25.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df25.1$t,
    delta = 80)
tmbpars25.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(114646)
df25.2 <- datasimu25(J = 2e4)
df25.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata25.2 <- list(
    Y = as.matrix(df25.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df25.2$t,
    delta = 80)
tmbpars25.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(114652)
df25.3 <- datasimu25(J = 3e4)
df25.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata25.3 <- list(
    Y = as.matrix(df25.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df25.3$t,
    delta = 80)
tmbpars25.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5))))
```

```{r models_25, error=TRUE, warning=FALSE, dependson="datasimu25"}
## compile("multiGLMM_25.cpp")
dyn.load(dynlib("multiGLMM_25"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_25.1 <- MakeADFun(data = tmbdata25.1,
                      parameters = tmbpars25.1,
                      DLL = "multiGLMM_25",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_25.1$fn()
tictoc::tic()
opt_25.1 <- nlminb(obj_25.1$par, obj_25.1$fn, obj_25.1$gr)
tictoc::toc()
sdr_25.1 <- sdreport(obj_25.1)
## ---------------------------------------------------------------------
obj_25.2 <- MakeADFun(data = tmbdata25.2,
                      parameters = tmbpars25.2,
                      DLL = "multiGLMM_25",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_25.2$fn()
tictoc::tic()
opt_25.2 <- nlminb(obj_25.2$par, obj_25.2$fn, obj_25.2$gr)
tictoc::toc()
sdr_25.2 <- sdreport(obj_25.2)
##----------------------------------------------------------------------
obj_25.3 <- MakeADFun(data = tmbdata25.3,
                      parameters = tmbpars25.3,
                      DLL = "multiGLMM_25",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_25.3$fn()
tictoc::tic()
opt_25.3 <- nlminb(obj_25.3$par, obj_25.3$fn, obj_25.3$gr)
tictoc::toc()
sdr_25.3 <- sdreport(obj_25.3)
```

```{r summaries_25, error=TRUE, dependson="datasimu25"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(0.2/sqrt(0.5))),
      summary(sdr_25.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(0.2/sqrt(0.5))),
      summary(sdr_25.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(0.2/sqrt(0.5))),
      summary(sdr_25.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.4), atanh(0.2/sqrt(0.5))),
      opt_25.1$par, ## 1e4 pairs
      opt_25.2$par, ## 2e4
      opt_25.3$par) ## 3e4
```

### 26

```{r datasimu26}
datasimu26 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.0, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(092412)
df26.1 <- datasimu26(J = 1e4)
df26.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata26.1 <- list(
    Y = as.matrix(df26.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df26.1$t,
    delta = 80)
tmbpars26.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(092431)
df26.2 <- datasimu26(J = 2e4)
df26.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata26.2 <- list(
    Y = as.matrix(df26.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df26.2$t,
    delta = 80)
tmbpars26.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(092452)
df26.3 <- datasimu26(J = 3e4)
df26.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata26.3 <- list(
    Y = as.matrix(df26.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df26.3$t,
    delta = 80)
tmbpars26.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5))))
```

```{r models_26, error=TRUE, warning=FALSE, dependson="datasimu26"}
## compile("multiGLMM_26.cpp")
dyn.load(dynlib("multiGLMM_26"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_26.1 <- MakeADFun(data = tmbdata26.1,
                      parameters = tmbpars26.1,
                      DLL = "multiGLMM_26",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_26.1$fn()
tictoc::tic()
opt_26.1 <- nlminb(obj_26.1$par, obj_26.1$fn, obj_26.1$gr)
tictoc::toc()
sdr_26.1 <- sdreport(obj_26.1)
## ---------------------------------------------------------------------
obj_26.2 <- MakeADFun(data = tmbdata26.2,
                      parameters = tmbpars26.2,
                      DLL = "multiGLMM_26",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_26.2$fn()
tictoc::tic()
opt_26.2 <- nlminb(obj_26.2$par, obj_26.2$fn, obj_26.2$gr)
tictoc::toc()
sdr_26.2 <- sdreport(obj_26.2)
##----------------------------------------------------------------------
obj_26.3 <- MakeADFun(data = tmbdata26.3,
                      parameters = tmbpars26.3,
                      DLL = "multiGLMM_26",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_26.3$fn()
tictoc::tic()
opt_26.3 <- nlminb(obj_26.3$par, obj_26.3$fn, obj_26.3$gr)
tictoc::toc()
sdr_26.3 <- sdreport(obj_26.3)
```

```{r summaries_26, error=TRUE, dependson="datasimu26"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5))),
      summary(sdr_26.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5))),
      summary(sdr_26.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5))),
      summary(sdr_26.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5))),
      opt_26.1$par, ## 1e4 pairs
      opt_26.2$par, ## 2e4
      opt_26.3$par) ## 3e4
```

### 27

```{r datasimu27}
datasimu27 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(100205)
df27.1 <- datasimu27(J = 1e4)
df27.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata27.1 <- list(
    Y = as.matrix(df27.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df27.1$t,
    delta = 80)
tmbpars27.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(100225)
df27.2 <- datasimu27(J = 2e4)
df27.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata27.2 <- list(
    Y = as.matrix(df27.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df27.2$t,
    delta = 80)
tmbpars27.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(100238)
df27.3 <- datasimu27(J = 3e4)
df27.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata27.3 <- list(
    Y = as.matrix(df27.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df27.3$t,
    delta = 80)
tmbpars27.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5))))
```

```{r models_27, error=TRUE, warning=FALSE, dependson="datasimu27"}
## compile("multiGLMM_27.cpp")
dyn.load(dynlib("multiGLMM_27"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_27.1 <- MakeADFun(data = tmbdata27.1,
                      parameters = tmbpars27.1,
                      DLL = "multiGLMM_27",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_27.1$fn()
tictoc::tic()
opt_27.1 <- nlminb(obj_27.1$par, obj_27.1$fn, obj_27.1$gr)
tictoc::toc()
sdr_27.1 <- sdreport(obj_27.1)
## ---------------------------------------------------------------------
obj_27.2 <- MakeADFun(data = tmbdata27.2,
                      parameters = tmbpars27.2,
                      DLL = "multiGLMM_27",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_27.2$fn()
tictoc::tic()
opt_27.2 <- nlminb(obj_27.2$par, obj_27.2$fn, obj_27.2$gr)
tictoc::toc()
sdr_27.2 <- sdreport(obj_27.2)
##----------------------------------------------------------------------
obj_27.3 <- MakeADFun(data = tmbdata27.3,
                      parameters = tmbpars27.3,
                      DLL = "multiGLMM_27",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_27.3$fn()
tictoc::tic()
opt_27.3 <- nlminb(obj_27.3$par, obj_27.3$fn, obj_27.3$gr)
tictoc::toc()
sdr_27.3 <- sdreport(obj_27.3)
```

```{r summaries_27, error=TRUE, dependson="datasimu27"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_27.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_27.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_27.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      opt_27.1$par, ## 1e4 pairs
      opt_27.2$par, ## 2e4
      opt_27.3$par) ## 3e4
```

### 28

```{r datasimu28}
datasimu28 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.0,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(130024)
df28.1 <- datasimu28(J = 1e4)
df28.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata28.1 <- list(
    Y = as.matrix(df28.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df28.1$t,
    delta = 80)
tmbpars28.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(130048)
df28.2 <- datasimu28(J = 2e4)
df28.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata28.2 <- list(
    Y = as.matrix(df28.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df28.2$t,
    delta = 80)
tmbpars28.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(130118)
df28.3 <- datasimu28(J = 3e4)
df28.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata28.3 <- list(
    Y = as.matrix(df28.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df28.3$t,
    delta = 80)
tmbpars28.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5))))
```

```{r models_28, error=TRUE, warning=FALSE, dependson="datasimu28"}
## compile("multiGLMM_28.cpp")
dyn.load(dynlib("multiGLMM_28"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_28.1 <- MakeADFun(data = tmbdata28.1,
                      parameters = tmbpars28.1,
                      DLL = "multiGLMM_28",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_28.1$fn()
tictoc::tic()
opt_28.1 <- nlminb(obj_28.1$par, obj_28.1$fn, obj_28.1$gr)
tictoc::toc()
sdr_28.1 <- sdreport(obj_28.1)
## ---------------------------------------------------------------------
obj_28.2 <- MakeADFun(data = tmbdata28.2,
                      parameters = tmbpars28.2,
                      DLL = "multiGLMM_28",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_28.2$fn()
tictoc::tic()
opt_28.2 <- nlminb(obj_28.2$par, obj_28.2$fn, obj_28.2$gr)
tictoc::toc()
sdr_28.2 <- sdreport(obj_28.2)
##----------------------------------------------------------------------
obj_28.3 <- MakeADFun(data = tmbdata28.3,
                      parameters = tmbpars28.3,
                      DLL = "multiGLMM_28",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_28.3$fn()
tictoc::tic()
opt_28.3 <- nlminb(obj_28.3$par, obj_28.3$fn, obj_28.3$gr)
tictoc::toc()
sdr_28.3 <- sdreport(obj_28.3)
```

```{r summaries_28, error=TRUE, dependson="datasimu28"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_28.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_28.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      summary(sdr_28.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5))),
      opt_28.1$par, ## 1e4 pairs
      opt_28.2$par, ## 2e4
      opt_28.3$par) ## 3e4
```

### 29

```{r datasimu29}
datasimu29 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.1, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(143035)
df29.1 <- datasimu29(J = 1e4)
df29.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata29.1 <- list(
    Y = as.matrix(df29.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df29.1$t,
    delta = 80)
tmbpars29.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(143146)
df29.2 <- datasimu29(J = 2e4)
df29.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata29.2 <- list(
    Y = as.matrix(df29.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df29.2$t,
    delta = 80)
tmbpars29.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(143214)
df29.3 <- datasimu29(J = 3e4)
df29.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata29.3 <- list(
    Y = as.matrix(df29.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df29.3$t,
    delta = 80)
tmbpars29.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_29, error=TRUE, warning=FALSE, dependson="datasimu29"}
## compile("multiGLMM_29.cpp")
dyn.load(dynlib("multiGLMM_29"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_29.1 <- MakeADFun(data = tmbdata29.1,
                      parameters = tmbpars29.1,
                      DLL = "multiGLMM_29",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_29.1$fn()
tictoc::tic()
opt_29.1 <- nlminb(obj_29.1$par, obj_29.1$fn, obj_29.1$gr)
tictoc::toc()
sdr_29.1 <- sdreport(obj_29.1)
## ---------------------------------------------------------------------
obj_29.2 <- MakeADFun(data = tmbdata29.2,
                      parameters = tmbpars29.2,
                      DLL = "multiGLMM_29",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_29.2$fn()
tictoc::tic()
opt_29.2 <- nlminb(obj_29.2$par, obj_29.2$fn, obj_29.2$gr)
tictoc::toc()
sdr_29.2 <- sdreport(obj_29.2)
##----------------------------------------------------------------------
obj_29.3 <- MakeADFun(data = tmbdata29.3,
                      parameters = tmbpars29.3,
                      DLL = "multiGLMM_29",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_29.3$fn()
tictoc::tic()
opt_29.3 <- nlminb(obj_29.3$par, obj_29.3$fn, obj_29.3$gr)
tictoc::toc()
sdr_29.3 <- sdreport(obj_29.3)
```

```{r summaries_29, error=TRUE, dependson="datasimu29"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_29.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_29.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(0.5), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_29.3, "fixed"))
```

### 30

```{r datasimu30}
datasimu30 <- function(J, from = 30, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.1, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(152315)
df30.1 <- datasimu30(J = 1e4)
df30.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata30.1 <- list(
    Y = as.matrix(df30.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df30.1$t,
    delta = 80)
tmbpars30.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(152340)
df30.2 <- datasimu30(J = 2e4)
df30.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata30.2 <- list(
    Y = as.matrix(df30.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df30.2$t,
    delta = 80)
tmbpars30.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(152358)
df30.3 <- datasimu30(J = 3e4)
df30.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata30.3 <- list(
    Y = as.matrix(df30.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df30.3$t,
    delta = 80)
tmbpars30.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_30, error=TRUE, warning=FALSE, dependson="datasimu30"}
## compile("multiGLMM_30.cpp")
dyn.load(dynlib("multiGLMM_30"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_30.1 <- MakeADFun(data = tmbdata30.1,
                      parameters = tmbpars30.1,
                      DLL = "multiGLMM_30",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_30.1$fn()
tictoc::tic()
opt_30.1 <- nlminb(obj_30.1$par, obj_30.1$fn, obj_30.1$gr)
tictoc::toc()
sdr_30.1 <- sdreport(obj_30.1)
## ---------------------------------------------------------------------
obj_30.2 <- MakeADFun(data = tmbdata30.2,
                      parameters = tmbpars30.2,
                      DLL = "multiGLMM_30",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_30.2$fn()
tictoc::tic()
opt_30.2 <- nlminb(obj_30.2$par, obj_30.2$fn, obj_30.2$gr)
tictoc::toc()
sdr_30.2 <- sdreport(obj_30.2)
##----------------------------------------------------------------------
obj_30.3 <- MakeADFun(data = tmbdata30.3,
                      parameters = tmbpars30.3,
                      DLL = "multiGLMM_30",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_30.3$fn()
tictoc::tic()
opt_30.3 <- nlminb(obj_30.3$par, obj_30.3$fn, obj_30.3$gr)
tictoc::toc()
sdr_30.3 <- sdreport(obj_30.3)
```

```{r summaries_30, error=TRUE, dependson="datasimu30"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_30.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_30.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_30.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_30.1$par, ## 1e4 pairs
      opt_30.2$par, ## 2e4
      opt_30.3$par) ## 3e4
```

### 31

```{r datasimu31}
datasimu31 <- function(J, from = 31, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.1, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(160022)
df31.1 <- datasimu31(J = 1e4)
df31.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata31.1 <- list(
    Y = as.matrix(df31.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df31.1$t,
    delta = 80)
tmbpars31.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(160118)
df31.2 <- datasimu31(J = 2e4)
df31.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata31.2 <- list(
    Y = as.matrix(df31.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df31.2$t,
    delta = 80)
tmbpars31.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(160138)
df31.3 <- datasimu31(J = 3e4)
df31.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata31.3 <- list(
    Y = as.matrix(df31.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df31.3$t,
    delta = 80)
tmbpars31.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_31, error=TRUE, warning=FALSE, dependson="datasimu31"}
## compile("multiGLMM_31.cpp")
dyn.load(dynlib("multiGLMM_31"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_31.1 <- MakeADFun(data = tmbdata31.1,
                      parameters = tmbpars31.1,
                      DLL = "multiGLMM_31",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_31.1$fn()
tictoc::tic()
opt_31.1 <- nlminb(obj_31.1$par, obj_31.1$fn, obj_31.1$gr)
tictoc::toc()
sdr_31.1 <- sdreport(obj_31.1)
## ---------------------------------------------------------------------
obj_31.2 <- MakeADFun(data = tmbdata31.2,
                      parameters = tmbpars31.2,
                      DLL = "multiGLMM_31",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_31.2$fn()
tictoc::tic()
opt_31.2 <- nlminb(obj_31.2$par, obj_31.2$fn, obj_31.2$gr)
tictoc::toc()
sdr_31.2 <- sdreport(obj_31.2)
##----------------------------------------------------------------------
obj_31.3 <- MakeADFun(data = tmbdata31.3,
                      parameters = tmbpars31.3,
                      DLL = "multiGLMM_31",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_31.3$fn()
tictoc::tic()
opt_31.3 <- nlminb(obj_31.3$par, obj_31.3$fn, obj_31.3$gr)
tictoc::toc()
sdr_31.3 <- sdreport(obj_31.3)
```

```{r summaries_31, error=TRUE, dependson="datasimu31"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_31.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_31.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_31.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_31.1$par, ## 1e4 pairs
      opt_31.2$par, ## 2e4
      opt_31.3$par) ## 3e4
```

### 32

```{r datasimu32}
datasimu32 <- function(J, from = 32, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.0,
                                                 0.4, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.0,
                                                 0.0, 0.1, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(174411)
df32.1 <- datasimu32(J = 1e4)
df32.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata32.1 <- list(
    Y = as.matrix(df32.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df32.1$t,
    delta = 80)
tmbpars32.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(174428)
df32.2 <- datasimu32(J = 2e4)
df32.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata32.2 <- list(
    Y = as.matrix(df32.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df32.2$t,
    delta = 80)
tmbpars32.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(174444)
df32.3 <- datasimu32(J = 3e4)
df32.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata32.3 <- list(
    Y = as.matrix(df32.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df32.3$t,
    delta = 80)
tmbpars32.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_32, error=TRUE, warning=FALSE, dependson="datasimu32"}
## compile("multiGLMM_32.cpp")
dyn.load(dynlib("multiGLMM_32"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_32.1 <- MakeADFun(data = tmbdata32.1,
                      parameters = tmbpars32.1,
                      DLL = "multiGLMM_32",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_32.1$fn()
tictoc::tic()
opt_32.1 <- nlminb(obj_32.1$par, obj_32.1$fn, obj_32.1$gr)
tictoc::toc()
sdr_32.1 <- sdreport(obj_32.1)
## ---------------------------------------------------------------------
obj_32.2 <- MakeADFun(data = tmbdata32.2,
                      parameters = tmbpars32.2,
                      DLL = "multiGLMM_32",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_32.2$fn()
tictoc::tic()
opt_32.2 <- nlminb(obj_32.2$par, obj_32.2$fn, obj_32.2$gr)
tictoc::toc()
sdr_32.2 <- sdreport(obj_32.2)
##----------------------------------------------------------------------
obj_32.3 <- MakeADFun(data = tmbdata32.3,
                      parameters = tmbpars32.3,
                      DLL = "multiGLMM_32",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_32.3$fn()
tictoc::tic()
opt_32.3 <- nlminb(obj_32.3$par, obj_32.3$fn, obj_32.3$gr)
tictoc::toc()
sdr_32.3 <- sdreport(obj_32.3)
```

```{r summaries_32, error=TRUE, dependson="datasimu32"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_32.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_32.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_32.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_32.1$par, ## 1e4 pairs
      opt_32.2$par, ## 2e4
      opt_32.3$par) ## 3e4
```

### 33

```{r datasimu33}
datasimu33 <- function(J, from = 33, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(195423)
df33.1 <- datasimu33(J = 1e4)
df33.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata33.1 <- list(
    Y = as.matrix(df33.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df33.1$t,
    delta = 80)
tmbpars33.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(195444)
df33.2 <- datasimu33(J = 2e4)
df33.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata33.2 <- list(
    Y = as.matrix(df33.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df33.2$t,
    delta = 80)
tmbpars33.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(195503)
df33.3 <- datasimu33(J = 3e4)
df33.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata33.3 <- list(
    Y = as.matrix(df33.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df33.3$t,
    delta = 80)
tmbpars33.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_33, error=TRUE, warning=FALSE, dependson="datasimu33"}
## compile("multiGLMM_33.cpp")
dyn.load(dynlib("multiGLMM_33"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_33.1 <- MakeADFun(data = tmbdata33.1,
                      parameters = tmbpars33.1,
                      DLL = "multiGLMM_33",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_33.1$fn()
tictoc::tic()
opt_33.1 <- nlminb(obj_33.1$par, obj_33.1$fn, obj_33.1$gr)
tictoc::toc()
sdr_33.1 <- sdreport(obj_33.1)
## ---------------------------------------------------------------------
obj_33.2 <- MakeADFun(data = tmbdata33.2,
                      parameters = tmbpars33.2,
                      DLL = "multiGLMM_33",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_33.2$fn()
tictoc::tic()
opt_33.2 <- nlminb(obj_33.2$par, obj_33.2$fn, obj_33.2$gr)
tictoc::toc()
sdr_33.2 <- sdreport(obj_33.2)
##----------------------------------------------------------------------
obj_33.3 <- MakeADFun(data = tmbdata33.3,
                      parameters = tmbpars33.3,
                      DLL = "multiGLMM_33",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_33.3$fn()
tictoc::tic()
opt_33.3 <- nlminb(obj_33.3$par, obj_33.3$fn, obj_33.3$gr)
tictoc::toc()
sdr_33.3 <- sdreport(obj_33.3)
```

```{r summaries_33, error=TRUE, dependson="datasimu33"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_33.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_33.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_33.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_33.1$par, ## 1e4 pairs
      opt_33.2$par, ## 2e4
      opt_33.3$par) ## 3e4
```

### 34

```{r datasimu34}
datasimu34 <- function(J, from = 34, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.0,
                                                 0.0, 1.0, 0.0, 0.1,
                                                 0.2, 0.0, 0.5, 0.2,
                                                 0.0, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(195757)
df34.1 <- datasimu34(J = 1e4)
df34.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata34.1 <- list(
    Y = as.matrix(df34.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df34.1$t,
    delta = 80)
tmbpars34.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(195807)
df34.2 <- datasimu34(J = 2e4)
df34.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata34.2 <- list(
    Y = as.matrix(df34.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df34.2$t,
    delta = 80)
tmbpars34.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
set.seed(195816)
df34.3 <- datasimu34(J = 3e4)
df34.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata34.3 <- list(
    Y = as.matrix(df34.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df34.3$t,
    delta = 80)
tmbpars34.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(2 * 0.2), atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r models_34, error=TRUE, warning=FALSE, dependson="datasimu34"}
## compile("multiGLMM_34.cpp")
dyn.load(dynlib("multiGLMM_34"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_34.1 <- MakeADFun(data = tmbdata34.1,
                      parameters = tmbpars34.1,
                      DLL = "multiGLMM_34",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_34.1$fn()
tictoc::tic()
opt_34.1 <- nlminb(obj_34.1$par, obj_34.1$fn, obj_34.1$gr)
tictoc::toc()
sdr_34.1 <- sdreport(obj_34.1)
## ---------------------------------------------------------------------
obj_34.2 <- MakeADFun(data = tmbdata34.2,
                      parameters = tmbpars34.2,
                      DLL = "multiGLMM_34",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_34.2$fn()
tictoc::tic()
opt_34.2 <- nlminb(obj_34.2$par, obj_34.2$fn, obj_34.2$gr)
tictoc::toc()
sdr_34.2 <- sdreport(obj_34.2)
##----------------------------------------------------------------------
obj_34.3 <- MakeADFun(data = tmbdata34.3,
                      parameters = tmbpars34.3,
                      DLL = "multiGLMM_34",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_34.3$fn()
tictoc::tic()
opt_34.3 <- nlminb(obj_34.3$par, obj_34.3$fn, obj_34.3$gr)
tictoc::toc()
sdr_34.3 <- sdreport(obj_34.3)
```

```{r summaries_34, error=TRUE, dependson="datasimu34"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_34.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_34.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      summary(sdr_34.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(2 * 0.2), atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_34.1$par, ## 1e4 pairs
      opt_34.2$par, ## 2e4
      opt_34.3$par) ## 3e4
```

### 35

```{r datasimu35}
datasimu35 <- function(J, from = 35, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.3,
                                                 0.4, 1.0, 0.2, 0.1,
                                                 0.2, 0.2, 0.5, 0.2,
                                                 0.3, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(074227)
df35.1 <- datasimu35(J = 1e4)
df35.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata35.1 <- list(
    Y = as.matrix(df35.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df35.1$t,
    delta = 80)
tmbpars35.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(074451)
df35.2 <- datasimu35(J = 2e4)
df35.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata35.2 <- list(
    Y = as.matrix(df35.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df35.2$t,
    delta = 80)
tmbpars35.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(074510)
df35.3 <- datasimu35(J = 3e4)
df35.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata35.3 <- list(
    Y = as.matrix(df35.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df35.3$t,
    delta = 80)
tmbpars35.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r models_35, error=TRUE, warning=FALSE, dependson="datasimu35"}
## compile("multiGLMM_35.cpp")
dyn.load(dynlib("multiGLMM_35"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_35.1 <- MakeADFun(data = tmbdata35.1,
                      parameters = tmbpars35.1,
                      DLL = "multiGLMM_35",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_35.1$fn()
tictoc::tic()
opt_35.1 <- nlminb(obj_35.1$par, obj_35.1$fn, obj_35.1$gr)
tictoc::toc()
sdr_35.1 <- sdreport(obj_35.1)
## ---------------------------------------------------------------------
obj_35.2 <- MakeADFun(data = tmbdata35.2,
                      parameters = tmbpars35.2,
                      DLL = "multiGLMM_35",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_35.2$fn()
tictoc::tic()
opt_35.2 <- nlminb(obj_35.2$par, obj_35.2$fn, obj_35.2$gr)
tictoc::toc()
sdr_35.2 <- sdreport(obj_35.2)
##----------------------------------------------------------------------
obj_35.3 <- MakeADFun(data = tmbdata35.3,
                      parameters = tmbpars35.3,
                      DLL = "multiGLMM_35",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_35.3$fn()
tictoc::tic()
opt_35.3 <- nlminb(obj_35.3$par, obj_35.3$fn, obj_35.3$gr)
tictoc::toc()
sdr_35.3 <- sdreport(obj_35.3)
```

```{r summaries_35, error=TRUE, dependson="datasimu35"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_35.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_35.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_35.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_35.1$par, ## 1e4 pairs
      opt_35.2$par, ## 2e4
      opt_35.3$par) ## 3e4
```

### 36

```{r datasimu36}
datasimu36 <- function(J, from = 36, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.2, 0.3,
                                                 0.4, 1.0, 0.2, 0.1,
                                                 0.2, 0.2, 0.5, 0.2,
                                                 0.3, 0.1, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(075445)
df36.1 <- datasimu36(J = 1e4)
df36.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata36.1 <- list(
    Y = as.matrix(df36.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df36.1$t,
    delta = 80)
tmbpars36.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(075505)
df36.2 <- datasimu36(J = 2e4)
df36.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata36.2 <- list(
    Y = as.matrix(df36.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df36.2$t,
    delta = 80)
tmbpars36.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(075532)
df36.3 <- datasimu36(J = 3e4)
df36.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata36.3 <- list(
    Y = as.matrix(df36.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df36.3$t,
    delta = 80)
tmbpars36.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r models_36, error=TRUE, warning=FALSE, dependson="datasimu36"}
## compile("multiGLMM_36.cpp")
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_36.1 <- MakeADFun(data = tmbdata36.1,
                      parameters = tmbpars36.1,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.1$fn()
tictoc::tic()
opt_36.1 <- nlminb(obj_36.1$par, obj_36.1$fn, obj_36.1$gr)
tictoc::toc()
sdr_36.1 <- sdreport(obj_36.1)
## ---------------------------------------------------------------------
obj_36.2 <- MakeADFun(data = tmbdata36.2,
                      parameters = tmbpars36.2,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.2$fn()
tictoc::tic()
opt_36.2 <- nlminb(obj_36.2$par, obj_36.2$fn, obj_36.2$gr)
tictoc::toc()
sdr_36.2 <- sdreport(obj_36.2)
##----------------------------------------------------------------------
obj_36.3 <- MakeADFun(data = tmbdata36.3,
                      parameters = tmbpars36.3,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.3$fn()
tictoc::tic()
opt_36.3 <- nlminb(obj_36.3$par, obj_36.3$fn, obj_36.3$gr)
tictoc::toc()
sdr_36.3 <- sdreport(obj_36.3)
```

```{r summaries_36, error=TRUE, dependson="datasimu36"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_36.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_36.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_36.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.1$par, ## 1e4 pairs
      opt_36.2$par, ## 2e4
      opt_36.3$par) ## 3e4
```

### 37

```{r datasimu37}
datasimu37 <- function(J, from = 37, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.0, 0.3,
                                                 0.4, 1.0, 0.2, 0.0,
                                                 0.0, 0.2, 0.5, 0.2,
                                                 0.3, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(113012)
df37.1 <- datasimu37(J = 1e4)
df37.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata37.1 <- list(
    Y = as.matrix(df37.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df37.1$t,
    delta = 80)
tmbpars37.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(113227)
df37.2 <- datasimu37(J = 2e4)
df37.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata37.2 <- list(
    Y = as.matrix(df37.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df37.2$t,
    delta = 80)
tmbpars37.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(113239)
df37.3 <- datasimu37(J = 3e4)
df37.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata37.3 <- list(
    Y = as.matrix(df37.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df37.3$t,
    delta = 80)
tmbpars37.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r models_37, error=TRUE, warning=FALSE, dependson="datasimu37"}
## compile("multiGLMM_37.cpp")
dyn.load(dynlib("multiGLMM_37"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_37.1 <- MakeADFun(data = tmbdata37.1,
                      parameters = tmbpars37.1,
                      DLL = "multiGLMM_37",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_37.1$fn()
tictoc::tic()
opt_37.1 <- nlminb(obj_37.1$par, obj_37.1$fn, obj_37.1$gr)
tictoc::toc()
sdr_37.1 <- sdreport(obj_37.1)
## ---------------------------------------------------------------------
obj_37.2 <- MakeADFun(data = tmbdata37.2,
                      parameters = tmbpars37.2,
                      DLL = "multiGLMM_37",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_37.2$fn()
tictoc::tic()
opt_37.2 <- nlminb(obj_37.2$par, obj_37.2$fn, obj_37.2$gr)
tictoc::toc()
sdr_37.2 <- sdreport(obj_37.2)
##----------------------------------------------------------------------
obj_37.3 <- MakeADFun(data = tmbdata37.3,
                      parameters = tmbpars37.3,
                      DLL = "multiGLMM_37",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_37.3$fn()
tictoc::tic()
opt_37.3 <- nlminb(obj_37.3$par, obj_37.3$fn, obj_37.3$gr)
tictoc::toc()
sdr_37.3 <- sdreport(obj_37.3)
```

```{r summaries_37, error=TRUE, dependson="datasimu37"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_37.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_37.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_37.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_37.1$par, ## 1e4 pairs
      opt_37.2$par, ## 2e4
      opt_37.3$par) ## 3e4
```

### 38

```{r datasimu38}
datasimu38 <- function(J, from = 38, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.4, 0.0, 0.3,
                                                 0.4, 1.0, 0.2, 0.0,
                                                 0.0, 0.2, 0.5, 0.2,
                                                 0.3, 0.0, 0.2, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(114623)
df38.1 <- datasimu38(J = 1e4)
df38.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata38.1 <- list(
    Y = as.matrix(df38.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df38.1$t,
    delta = 80)
tmbpars38.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(114629)
df38.2 <- datasimu38(J = 2e4)
df38.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata38.2 <- list(
    Y = as.matrix(df38.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df38.2$t,
    delta = 80)
tmbpars38.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(114703)
df38.3 <- datasimu38(J = 3e4)
df38.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata38.3 <- list(
    Y = as.matrix(df38.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df38.3$t,
    delta = 80)
tmbpars38.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r models_38, error=TRUE, warning=FALSE, dependson="datasimu38"}
## compile("multiGLMM_38.cpp")
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_38.1 <- MakeADFun(data = tmbdata38.1,
                      parameters = tmbpars38.1,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.1$fn()
tictoc::tic()
opt_38.1 <- nlminb(obj_38.1$par, obj_38.1$fn, obj_38.1$gr)
tictoc::toc()
sdr_38.1 <- sdreport(obj_38.1)
## ---------------------------------------------------------------------
obj_38.2 <- MakeADFun(data = tmbdata38.2,
                      parameters = tmbpars38.2,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.2$fn()
tictoc::tic()
opt_38.2 <- nlminb(obj_38.2$par, obj_38.2$fn, obj_38.2$gr)
tictoc::toc()
sdr_38.2 <- sdreport(obj_38.2)
##----------------------------------------------------------------------
obj_38.3 <- MakeADFun(data = tmbdata38.3,
                      parameters = tmbpars38.3,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.3$fn()
tictoc::tic()
opt_38.3 <- nlminb(obj_38.3$par, obj_38.3$fn, obj_38.3$gr)
tictoc::toc()
sdr_38.3 <- sdreport(obj_38.3)
```

```{r summaries_38, error=TRUE, dependson="datasimu38"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_38.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_38.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_38.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.1$par, ## 1e4 pairs
      opt_38.2$par, ## 2e4
      opt_38.3$par) ## 3e4
```

### 39

```{r datasimu39}
datasimu39 <- function(J, from = 39, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.3,
                                                 0.0, 1.0, 0.2, 0.1,
                                                 0.2, 0.2, 0.5, 0.0,
                                                 0.3, 0.1, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(112639)
df39.1 <- datasimu39(J = 1e4)
df39.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata39.1 <- list(
    Y = as.matrix(df39.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df39.1$t,
    delta = 80)
tmbpars39.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(112656)
df39.2 <- datasimu39(J = 2e4)
df39.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata39.2 <- list(
    Y = as.matrix(df39.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df39.2$t,
    delta = 80)
tmbpars39.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(112706)
df39.3 <- datasimu39(J = 3e4)
df39.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata39.3 <- list(
    Y = as.matrix(df39.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df39.3$t,
    delta = 80)
tmbpars39.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r models_39, error=TRUE, warning=FALSE, dependson="datasimu39"}
## compile("multiGLMM_39.cpp")
dyn.load(dynlib("multiGLMM_39"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_39.1 <- MakeADFun(data = tmbdata39.1,
                      parameters = tmbpars39.1,
                      DLL = "multiGLMM_39",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_39.1$fn()
tictoc::tic()
opt_39.1 <- nlminb(obj_39.1$par, obj_39.1$fn, obj_39.1$gr)
tictoc::toc()
sdr_39.1 <- sdreport(obj_39.1)
## ---------------------------------------------------------------------
obj_39.2 <- MakeADFun(data = tmbdata39.2,
                      parameters = tmbpars39.2,
                      DLL = "multiGLMM_39",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_39.2$fn()
tictoc::tic()
opt_39.2 <- nlminb(obj_39.2$par, obj_39.2$fn, obj_39.2$gr)
tictoc::toc()
sdr_39.2 <- sdreport(obj_39.2)
##----------------------------------------------------------------------
obj_39.3 <- MakeADFun(data = tmbdata39.3,
                      parameters = tmbpars39.3,
                      DLL = "multiGLMM_39",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_39.3$fn()
tictoc::tic()
opt_39.3 <- nlminb(obj_39.3$par, obj_39.3$fn, obj_39.3$gr)
tictoc::toc()
sdr_39.3 <- sdreport(obj_39.3)
```

```{r summaries_39, error=TRUE, dependson="datasimu39"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_39.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_39.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_39.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5, log(1), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_39.1$par, ## 1e4 pairs
      opt_39.2$par, ## 2e4
      opt_39.3$par) ## 3e4
```

### 40

```{r datasimu40}
datasimu40 <- function(J, from = 40, to = 79.5, by = 0.5, delta = 80,
                       beta = c(-2, -1.5), gamma = c(1.2, 1),
                       w = c(3, 5), S = matrix(c(1.0, 0.0, 0.2, 0.3,
                                                 0.0, 1.0, 0.2, 0.1,
                                                 0.2, 0.2, 0.5, 0.0,
                                                 0.3, 0.1, 0.0, 0.5),
                                               4, 4))
{
    out <- data.frame("i" = rep(seq(2), times = J),
                      "j" = factor(rep(seq(J), each = 2)),
                      "p1" = NA, "p2" = NA, "p3" = NA,
                      "y1" = NA, "y2" = NA, "y3" = NA,
                      "t" = rep(seq(from = from, to = to, by = by),
                                length.out = 2 * J))
    K <- dim(S)[1]/2 + 1
    ladim <- 2 * (K - 1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean = rep(0, ladim), sigma = S)
    Z <- bdiag(replicate(J, rep(1, 2), simplify = FALSE))
    R <- Z %*% B
    risk1 <- exp(beta[1] + R[ , 1])
    risk2 <- exp(beta[2] + R[ , 2])
    level <- 1 + risk1 + risk2
    out$p1 <- risk1/level *
        w[1] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[1] * atanh(2 * out$t/delta - 1) - gamma[1] - R[ , 3])
    out$p2 <- risk2/level *
        w[2] * delta/(2 * out$t * (delta - out$t)) *
        dnorm(w[2] * atanh(2 * out$t/delta - 1) - gamma[2] - R[ , 4])
    out$p3 <- with(out, 1 - p1 - p2)
    out[ , c("y1", "y2", "y3")] <-
        mc2d::rmultinomial(2 * J, 1,
                           prob = with(out, cbind(p1, p2, p3)))
    return(out)
}
## ---------------------------------------------------------------------
set.seed(113256)
df40.1 <- datasimu40(J = 1e4)
df40.1 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata40.1 <- list(
    Y = as.matrix(df40.1 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df40.1$t,
    delta = 80)
tmbpars40.1 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(113307)
df40.2 <- datasimu40(J = 2e4)
df40.2 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata40.2 <- list(
    Y = as.matrix(df40.2 %>% select(y1:y3)),
    Z = bdiag(replicate(2e4, rep(1, 2), simplify = FALSE)),
    T = df40.2$t,
    delta = 80)
tmbpars40.2 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 2e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
set.seed(113317)
df40.3 <- datasimu40(J = 3e4)
df40.3 %>% dplyr::select(y1:y3) %>% colSums() %>% prop.table()
tmbdata40.3 <- list(
    Y = as.matrix(df40.3 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df40.3$t,
    delta = 80)
tmbpars40.3 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 3e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r models_40, error=TRUE, warning=FALSE, dependson="datasimu40"}
## compile("multiGLMM_40.cpp")
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_40.1 <- MakeADFun(data = tmbdata40.1,
                      parameters = tmbpars40.1,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.1$fn()
tictoc::tic()
opt_40.1 <- nlminb(obj_40.1$par, obj_40.1$fn, obj_40.1$gr)
tictoc::toc()
sdr_40.1 <- sdreport(obj_40.1)
## ---------------------------------------------------------------------
obj_40.2 <- MakeADFun(data = tmbdata40.2,
                      parameters = tmbpars40.2,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.2$fn()
tictoc::tic()
opt_40.2 <- nlminb(obj_40.2$par, obj_40.2$fn, obj_40.2$gr)
tictoc::toc()
sdr_40.2 <- sdreport(obj_40.2)
##----------------------------------------------------------------------
obj_40.3 <- MakeADFun(data = tmbdata40.3,
                      parameters = tmbpars40.3,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.3$fn()
tictoc::tic()
opt_40.3 <- nlminb(obj_40.3$par, obj_40.3$fn, obj_40.3$gr)
tictoc::toc()
sdr_40.3 <- sdreport(obj_40.3)
```

```{r summaries_40, error=TRUE, dependson="datasimu40"}
## 1e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_40.1, "fixed"))
## 2e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_40.2, "fixed"))
## 3e4 -----------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      summary(sdr_40.3, "fixed"))
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.1$par, ## 1e4 pairs
      opt_40.2$par, ## 2e4
      opt_40.3$par) ## 3e4
```

## the best ones

```
models 22, 36, 38 and 40

i.e. all models with different variances *and* at least four
correlation components
```

### different samples sizes

```{r moredatasimu22}
df22.4 <- datasimu22(J = 1e3)
tmbdata22.4 <- list(
    Y = as.matrix(df22.4 %>% select(y1:y3)),
    Z = bdiag(replicate(1e3, rep(1, 2), simplify = FALSE)),
    T = df22.4$t,
    delta = 80)
tmbpars22.4 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
df22.5 <- datasimu22(J = 25e2)
tmbdata22.5 <- list(
    Y = as.matrix(df22.5 %>% select(y1:y3)),
    Z = bdiag(replicate(25e2, rep(1, 2), simplify = FALSE)),
    T = df22.5$t,
    delta = 80)
tmbpars22.5 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 25e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
df22.6 <- datasimu22(J = 5e3)
tmbdata22.6 <- list(
    Y = as.matrix(df22.6 %>% select(y1:y3)),
    Z = bdiag(replicate(5e3, rep(1, 2), simplify = FALSE)),
    T = df22.6$t,
    delta = 80)
tmbpars22.6 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 5e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
df22.7 <- datasimu22(J = 75e2)
tmbdata22.7 <- list(
    Y = as.matrix(df22.7 %>% select(y1:y3)),
    Z = bdiag(replicate(75e2, rep(1, 2), simplify = FALSE)),
    T = df22.7$t,
    delta = 80)
tmbpars22.7 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 75e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
## ---------------------------------------------------------------------
df22.8 <- datasimu22(J = 1e4)
tmbdata22.8 <- list(
    Y = as.matrix(df22.8 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df22.8$t,
    delta = 80)
tmbpars22.8 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)),
                             atanh(0.1/sqrt(0.5))))
```

```{r moredatasimu36}
df36.4 <- datasimu36(J = 1e3)
tmbdata36.4 <- list(
    Y = as.matrix(df36.4 %>% select(y1:y3)),
    Z = bdiag(replicate(1e3, rep(1, 2), simplify = FALSE)),
    T = df36.4$t,
    delta = 80)
tmbpars36.4 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df36.5 <- datasimu36(J = 25e2)
tmbdata36.5 <- list(
    Y = as.matrix(df36.5 %>% select(y1:y3)),
    Z = bdiag(replicate(25e2, rep(1, 2), simplify = FALSE)),
    T = df36.5$t,
    delta = 80)
tmbpars36.5 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 25e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df36.6 <- datasimu36(J = 5e3)
tmbdata36.6 <- list(
    Y = as.matrix(df36.6 %>% select(y1:y3)),
    Z = bdiag(replicate(5e3, rep(1, 2), simplify = FALSE)),
    T = df36.6$t,
    delta = 80)
tmbpars36.6 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 5e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df36.7 <- datasimu36(J = 75e2)
tmbdata36.7 <- list(
    Y = as.matrix(df36.7 %>% select(y1:y3)),
    Z = bdiag(replicate(75e2, rep(1, 2), simplify = FALSE)),
    T = df36.7$t,
    delta = 80)
tmbpars36.7 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 75e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df36.8 <- datasimu36(J = 1e4)
tmbdata36.8 <- list(
    Y = as.matrix(df36.8 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df36.8$t,
    delta = 80)
tmbpars36.8 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r moredatasimu38}
df38.4 <- datasimu36(J = 1e3)
tmbdata38.4 <- list(
    Y = as.matrix(df38.4 %>% select(y1:y3)),
    Z = bdiag(replicate(1e3, rep(1, 2), simplify = FALSE)),
    T = df38.4$t,
    delta = 80)
tmbpars38.4 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df38.5 <- datasimu36(J = 25e2)
tmbdata38.5 <- list(
    Y = as.matrix(df38.5 %>% select(y1:y3)),
    Z = bdiag(replicate(25e2, rep(1, 2), simplify = FALSE)),
    T = df38.5$t,
    delta = 80)
tmbpars38.5 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 25e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df38.6 <- datasimu36(J = 5e3)
tmbdata38.6 <- list(
    Y = as.matrix(df38.6 %>% select(y1:y3)),
    Z = bdiag(replicate(5e3, rep(1, 2), simplify = FALSE)),
    T = df38.6$t,
    delta = 80)
tmbpars38.6 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 5e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df38.7 <- datasimu36(J = 75e2)
tmbdata38.7 <- list(
    Y = as.matrix(df38.7 %>% select(y1:y3)),
    Z = bdiag(replicate(75e2, rep(1, 2), simplify = FALSE)),
    T = df38.7$t,
    delta = 80)
tmbpars38.7 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 75e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df38.8 <- datasimu36(J = 1e4)
tmbdata38.8 <- list(
    Y = as.matrix(df38.8 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df38.8$t,
    delta = 80)
tmbpars38.8 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r moredatasimu40}
df40.4 <- datasimu36(J = 1e3)
tmbdata40.4 <- list(
    Y = as.matrix(df40.4 %>% select(y1:y3)),
    Z = bdiag(replicate(1e3, rep(1, 2), simplify = FALSE)),
    T = df40.4$t,
    delta = 80)
tmbpars40.4 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df40.5 <- datasimu36(J = 25e2)
tmbdata40.5 <- list(
    Y = as.matrix(df40.5 %>% select(y1:y3)),
    Z = bdiag(replicate(25e2, rep(1, 2), simplify = FALSE)),
    T = df40.5$t,
    delta = 80)
tmbpars40.5 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 25e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df40.6 <- datasimu36(J = 5e3)
tmbdata40.6 <- list(
    Y = as.matrix(df40.6 %>% select(y1:y3)),
    Z = bdiag(replicate(5e3, rep(1, 2), simplify = FALSE)),
    T = df40.6$t,
    delta = 80)
tmbpars40.6 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 5e3, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df40.7 <- datasimu36(J = 75e2)
tmbdata40.7 <- list(
    Y = as.matrix(df40.7 %>% select(y1:y3)),
    Z = bdiag(replicate(75e2, rep(1, 2), simplify = FALSE)),
    T = df40.7$t,
    delta = 80)
tmbpars40.7 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 75e2, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
## ---------------------------------------------------------------------
df40.8 <- datasimu36(J = 1e4)
tmbdata40.8 <- list(
    Y = as.matrix(df40.8 %>% select(y1:y3)),
    Z = bdiag(replicate(1e4, rep(1, 2), simplify = FALSE)),
    T = df40.8$t,
    delta = 80)
tmbpars40.8 <- list(beta1 = -2,
                    beta2 = -1.5,
                    gama1 = 1.2,
                    gama2 = 1,
                    w1 = 3,
                    w2 = 5,
                    R = matrix(0, nrow = 1e4, ncol = 4),
                    logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                    rhoZ = c(atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
                             atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))
                             ))
```

```{r moremodels_22, error=TRUE, warning=FALSE, dependson="moredatasimu22"}
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_22.4 <- MakeADFun(data = tmbdata22.4,
                      parameters = tmbpars22.4,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.4$fn()
tictoc::tic()
opt_22.4 <- nlminb(obj_22.4$par, obj_22.4$fn, obj_22.4$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_22.5 <- MakeADFun(data = tmbdata22.5,
                      parameters = tmbpars22.5,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.5$fn()
tictoc::tic()
opt_22.5 <- nlminb(obj_22.5$par, obj_22.5$fn, obj_22.5$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_22.6 <- MakeADFun(data = tmbdata22.6,
                      parameters = tmbpars22.6,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.6$fn()
tictoc::tic()
opt_22.6 <- nlminb(obj_22.6$par, obj_22.6$fn, obj_22.6$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_22.7 <- MakeADFun(data = tmbdata22.7,
                      parameters = tmbpars22.7,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.7$fn()
tictoc::tic()
opt_22.7 <- nlminb(obj_22.7$par, obj_22.7$fn, obj_22.7$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_22.8 <- MakeADFun(data = tmbdata22.8,
                      parameters = tmbpars22.8,
                      DLL = "multiGLMM_22",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_22.8$fn()
tictoc::tic()
opt_22.8 <- nlminb(obj_22.8$par, obj_22.8$fn, obj_22.8$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.4$par, ## 1e3 pairs
      opt_22.5$par, ## 25e2
      opt_22.6$par, ## 5e3
      opt_22.7$par, ## 75e2
      opt_22.8$par) ## 1e4
```

```{r moremodels_36, error=TRUE, warning=FALSE, dependson="moredatasimu36"}
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_36.4 <- MakeADFun(data = tmbdata36.4,
                      parameters = tmbpars36.4,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.4$fn()
tictoc::tic()
opt_36.4 <- nlminb(obj_36.4$par, obj_36.4$fn, obj_36.4$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_36.5 <- MakeADFun(data = tmbdata36.5,
                      parameters = tmbpars36.5,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.5$fn()
tictoc::tic()
opt_36.5 <- nlminb(obj_36.5$par, obj_36.5$fn, obj_36.5$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_36.6 <- MakeADFun(data = tmbdata36.6,
                      parameters = tmbpars36.6,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.6$fn()
tictoc::tic()
opt_36.6 <- nlminb(obj_36.6$par, obj_36.6$fn, obj_36.6$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_36.7 <- MakeADFun(data = tmbdata36.7,
                      parameters = tmbpars36.7,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.7$fn()
tictoc::tic()
opt_36.7 <- nlminb(obj_36.7$par, obj_36.7$fn, obj_36.7$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_36.8 <- MakeADFun(data = tmbdata36.8,
                      parameters = tmbpars36.8,
                      DLL = "multiGLMM_36",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_36.8$fn()
tictoc::tic()
opt_36.8 <- nlminb(obj_36.8$par, obj_36.8$fn, obj_36.8$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.4$par, ## 1e3 pairs
      opt_36.5$par, ## 25e2
      opt_36.6$par, ## 5e3
      opt_36.7$par, ## 75e2
      opt_36.8$par) ## 1e4
```

```{r moremodels_38, error=TRUE, warning=FALSE, dependson="moredatasimu38"}
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_38.4 <- MakeADFun(data = tmbdata38.4,
                      parameters = tmbpars38.4,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.4$fn()
tictoc::tic()
opt_38.4 <- nlminb(obj_38.4$par, obj_38.4$fn, obj_38.4$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_38.5 <- MakeADFun(data = tmbdata38.5,
                      parameters = tmbpars38.5,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.5$fn()
tictoc::tic()
opt_38.5 <- nlminb(obj_38.5$par, obj_38.5$fn, obj_38.5$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_38.6 <- MakeADFun(data = tmbdata38.6,
                      parameters = tmbpars38.6,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.6$fn()
tictoc::tic()
opt_38.6 <- nlminb(obj_38.6$par, obj_38.6$fn, obj_38.6$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_38.7 <- MakeADFun(data = tmbdata38.7,
                      parameters = tmbpars38.7,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.7$fn()
tictoc::tic()
opt_38.7 <- nlminb(obj_38.7$par, obj_38.7$fn, obj_38.7$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_38.8 <- MakeADFun(data = tmbdata38.8,
                      parameters = tmbpars38.8,
                      DLL = "multiGLMM_38",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_38.8$fn()
tictoc::tic()
opt_38.8 <- nlminb(obj_38.8$par, obj_38.8$fn, obj_38.8$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.4$par, ## 1e3 pairs
      opt_38.5$par, ## 25e2
      opt_38.6$par, ## 5e3
      opt_38.7$par, ## 75e2
      opt_38.8$par) ## 1e4
```

```{r moremodels_40, error=TRUE, warning=FALSE, dependson="moredatasimu40"}
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
## ---------------------------------------------------------------------
obj_40.4 <- MakeADFun(data = tmbdata40.4,
                      parameters = tmbpars40.4,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.4$fn()
tictoc::tic()
opt_40.4 <- nlminb(obj_40.4$par, obj_40.4$fn, obj_40.4$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_40.5 <- MakeADFun(data = tmbdata40.5,
                      parameters = tmbpars40.5,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.5$fn()
tictoc::tic()
opt_40.5 <- nlminb(obj_40.5$par, obj_40.5$fn, obj_40.5$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_40.6 <- MakeADFun(data = tmbdata40.6,
                      parameters = tmbpars40.6,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.6$fn()
tictoc::tic()
opt_40.6 <- nlminb(obj_40.6$par, obj_40.6$fn, obj_40.6$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_40.7 <- MakeADFun(data = tmbdata40.7,
                      parameters = tmbpars40.7,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.7$fn()
tictoc::tic()
opt_40.7 <- nlminb(obj_40.7$par, obj_40.7$fn, obj_40.7$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_40.8 <- MakeADFun(data = tmbdata40.8,
                      parameters = tmbpars40.8,
                      DLL = "multiGLMM_40",
                      random = "R",
                      hessian = TRUE, silent = TRUE)
obj_40.8$fn()
tictoc::tic()
opt_40.8 <- nlminb(obj_40.8$par, obj_40.8$fn, obj_40.8$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.4$par, ## 1e3 pairs
      opt_40.5$par, ## 25e2
      opt_40.6$par, ## 5e3
      opt_40.7$par, ## 75e2
      opt_40.8$par) ## 1e4
```

### different initial guesses

```
.6 data, 5e3 pairs
```

```{r guesses_22, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
## ---------------------------------------------------------------------
tmbpars22.6.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5))))
obj_22.6.1 <- MakeADFun(data = tmbdata22.6,
                        parameters = tmbpars22.6.1,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.6.1$fn()
tictoc::tic()
opt_22.6.1 <- nlminb(obj_22.6.1$par, obj_22.6.1$fn, obj_22.6.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars22.6.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5))))
obj_22.6.2 <- MakeADFun(data = tmbdata22.6,
                        parameters = tmbpars22.6.2,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.6.2$fn()
tictoc::tic()
opt_22.6.2 <- nlminb(obj_22.6.2$par, obj_22.6.2$fn, obj_22.6.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars22.6.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5))))
obj_22.6.3 <- MakeADFun(data = tmbdata22.6,
                        parameters = tmbpars22.6.3,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.6.3$fn()
tictoc::tic()
opt_22.6.3 <- nlminb(obj_22.6.3$par, obj_22.6.3$fn, obj_22.6.3$gr)
tictoc::toc()
```

```{r}
cbind(opt_22.6$par,
      opt_22.6.1$par,
      opt_22.6.2$par,
      opt_22.6.3$par)
```

```{r guesses_36, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
## ---------------------------------------------------------------------
tmbpars36.6.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_36.6.1 <- MakeADFun(data = tmbdata36.6,
                        parameters = tmbpars36.6.1,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.6.1$fn()
tictoc::tic()
opt_36.6.1 <- nlminb(obj_36.6.1$par, obj_36.6.1$fn, obj_36.6.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars36.6.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_36.6.2 <- MakeADFun(data = tmbdata36.6,
                        parameters = tmbpars36.6.2,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.6.2$fn()
tictoc::tic()
opt_36.6.2 <- nlminb(obj_36.6.2$par, obj_36.6.2$fn, obj_36.6.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars36.6.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_36.6.3 <- MakeADFun(data = tmbdata36.6,
                        parameters = tmbpars36.6.3,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.6.3$fn()
tictoc::tic()
opt_36.6.3 <- nlminb(obj_36.6.3$par, obj_36.6.3$fn, obj_36.6.3$gr)
tictoc::toc()
```

```{r}
cbind(opt_36.6$par,
      opt_36.6.1$par,
      opt_36.6.2$par,
      opt_36.6.3$par)
```

```{r guesses_38, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
## ---------------------------------------------------------------------
tmbpars38.6.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_38.6.1 <- MakeADFun(data = tmbdata38.6,
                        parameters = tmbpars38.6.1,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.6.1$fn()
tictoc::tic()
opt_38.6.1 <- nlminb(obj_38.6.1$par, obj_38.6.1$fn, obj_38.6.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars38.6.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_38.6.2 <- MakeADFun(data = tmbdata38.6,
                        parameters = tmbpars38.6.2,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.6.2$fn()
tictoc::tic()
opt_38.6.2 <- nlminb(obj_38.6.2$par, obj_38.6.2$fn, obj_38.6.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars38.6.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_38.6.3 <- MakeADFun(data = tmbdata38.6,
                        parameters = tmbpars38.6.3,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.6.3$fn()
tictoc::tic()
opt_38.6.3 <- nlminb(obj_38.6.3$par, obj_38.6.3$fn, obj_38.6.3$gr)
tictoc::toc()
```

```{r}
cbind(opt_38.6$par,
      opt_38.6.1$par,
      opt_38.6.2$par,
      opt_38.6.3$par)
```

```{r guesses_40, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
## ---------------------------------------------------------------------
tmbpars40.6.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_40.6.1 <- MakeADFun(data = tmbdata40.6,
                        parameters = tmbpars40.6.1,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.6.1$fn()
tictoc::tic()
opt_40.6.1 <- nlminb(obj_40.6.1$par, obj_40.6.1$fn, obj_40.6.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars40.6.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_40.6.2 <- MakeADFun(data = tmbdata40.6,
                        parameters = tmbpars40.6.2,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.6.2$fn()
tictoc::tic()
opt_40.6.2 <- nlminb(obj_40.6.2$par, obj_40.6.2$fn, obj_40.6.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars40.6.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 5e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_40.6.3 <- MakeADFun(data = tmbdata40.6,
                        parameters = tmbpars40.6.3,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.6.3$fn()
tictoc::tic()
opt_40.6.3 <- nlminb(obj_40.6.3$par, obj_40.6.3$fn, obj_40.6.3$gr)
tictoc::toc()
```

```{r}
cbind(opt_40.6$par,
      opt_40.6.1$par,
      opt_40.6.2$par,
      opt_40.6.3$par)
```

```
15e3 pairs, to see if goes the same
```

```{r moreguesses_22, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
df22.9 <- datasimu22(J = 15e3)
tmbdata22.9 <- list(
    Y = as.matrix(df22.9 %>% select(y1:y3)),
    Z = bdiag(replicate(15e3, rep(1, 2), simplify = FALSE)),
    T = df22.9$t,
    delta = 80)
## ---------------------------------------------------------------------
tmbpars22.9.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5))))
obj_22.9.1 <- MakeADFun(data = tmbdata22.9,
                        parameters = tmbpars22.9.1,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.9.1$fn()
tictoc::tic()
opt_22.9.1 <- nlminb(obj_22.9.1$par, obj_22.9.1$fn, obj_22.9.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars22.9.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5))))
obj_22.9.2 <- MakeADFun(data = tmbdata22.9,
                        parameters = tmbpars22.9.2,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.9.2$fn()
tictoc::tic()
opt_22.9.2 <- nlminb(obj_22.9.2$par, obj_22.9.2$fn, obj_22.9.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars22.9.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5))))
obj_22.9.3 <- MakeADFun(data = tmbdata22.9,
                        parameters = tmbpars22.9.3,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.9.3$fn()
tictoc::tic()
opt_22.9.3 <- nlminb(obj_22.9.3$par, obj_22.9.3$fn, obj_22.9.3$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.9.1$par,
      opt_22.9.2$par,
      opt_22.9.3$par)
```

```{r moreguesses_36, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
df36.9 <- datasimu36(J = 15e3)
tmbdata36.9 <- list(
    Y = as.matrix(df36.9 %>% select(y1:y3)),
    Z = bdiag(replicate(15e3, rep(1, 2), simplify = FALSE)),
    T = df36.9$t,
    delta = 80)
## ---------------------------------------------------------------------
tmbpars36.9.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_36.9.1 <- MakeADFun(data = tmbdata36.9,
                        parameters = tmbpars36.9.1,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.9.1$fn()
tictoc::tic()
opt_36.9.1 <- nlminb(obj_36.9.1$par, obj_36.9.1$fn, obj_36.9.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars36.9.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_36.9.2 <- MakeADFun(data = tmbdata36.9,
                        parameters = tmbpars36.9.2,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.9.2$fn()
tictoc::tic()
opt_36.9.2 <- nlminb(obj_36.9.2$par, obj_36.9.2$fn, obj_36.9.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars36.9.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_36.9.3 <- MakeADFun(data = tmbdata36.9,
                        parameters = tmbpars36.9.3,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.9.3$fn()
tictoc::tic()
opt_36.9.3 <- nlminb(obj_36.9.3$par, obj_36.9.3$fn, obj_36.9.3$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.9.1$par,
      opt_36.9.2$par,
      opt_36.9.3$par)
```

```{r moreguesses_38, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
df38.9 <- datasimu38(J = 15e3)
tmbdata38.9 <- list(
    Y = as.matrix(df38.9 %>% select(y1:y3)),
    Z = bdiag(replicate(15e3, rep(1, 2), simplify = FALSE)),
    T = df38.9$t,
    delta = 80)
## ---------------------------------------------------------------------
tmbpars38.9.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_38.9.1 <- MakeADFun(data = tmbdata38.9,
                        parameters = tmbpars38.9.1,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.9.1$fn()
tictoc::tic()
opt_38.9.1 <- nlminb(obj_38.9.1$par, obj_38.9.1$fn, obj_38.9.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars38.9.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_38.9.2 <- MakeADFun(data = tmbdata38.9,
                        parameters = tmbpars38.9.2,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.9.2$fn()
tictoc::tic()
opt_38.9.2 <- nlminb(obj_38.9.2$par, obj_38.9.2$fn, obj_38.9.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars38.9.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.4), atanh(2 * 0.2),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_38.9.3 <- MakeADFun(data = tmbdata38.9,
                        parameters = tmbpars38.9.3,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.9.3$fn()
tictoc::tic()
opt_38.9.3 <- nlminb(obj_38.9.3$par, obj_38.9.3$fn, obj_38.9.3$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.9.1$par,
      opt_38.9.2$par,
      opt_38.9.3$par)
```

```{r moreguesses_40, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
df40.9 <- datasimu40(J = 15e3)
tmbdata40.9 <- list(
    Y = as.matrix(df40.9 %>% select(y1:y3)),
    Z = bdiag(replicate(15e3, rep(1, 2), simplify = FALSE)),
    T = df40.9$t,
    delta = 80)
## ---------------------------------------------------------------------
tmbpars40.9.1 <- list(beta1 = 0,
                      beta2 = 0,
                      gama1 = 0,
                      gama2 = 0,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_40.9.1 <- MakeADFun(data = tmbdata40.9,
                        parameters = tmbpars40.9.1,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.9.1$fn()
tictoc::tic()
opt_40.9.1 <- nlminb(obj_40.9.1$par, obj_40.9.1$fn, obj_40.9.1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars40.9.2 <- list(beta1 = -5,
                      beta2 = -5,
                      gama1 = 5,
                      gama2 = 5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_40.9.2 <- MakeADFun(data = tmbdata40.9,
                        parameters = tmbpars40.9.2,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.9.2$fn()
tictoc::tic()
opt_40.9.2 <- nlminb(obj_40.9.2$par, obj_40.9.2$fn, obj_40.9.2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
tmbpars40.9.3 <- list(beta1 = 5,
                      beta2 = 5,
                      gama1 = -5,
                      gama2 = -5,
                      w1 = 1,
                      w2 = 1,
                      R = matrix(0, nrow = 15e3, ncol = 4),
                      logs2 = c(log(1), log(1), log(0.5), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.5)),
                               atanh(0.1/sqrt(0.5)),
                               atanh(0.3/sqrt(0.5)),
                               atanh(0.2/sqrt(0.5))))
obj_40.9.3 <- MakeADFun(data = tmbdata40.9,
                        parameters = tmbpars40.9.3,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.9.3$fn()
tictoc::tic()
opt_40.9.3 <- nlminb(obj_40.9.3$par, obj_40.9.3$fn, obj_40.9.3$gr)
tictoc::toc()
```

```{r}
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.9.1$par,
      opt_40.9.2$par,
      opt_40.9.3$par)
```

## the strategy

```{r}
dyn.load(dynlib("multiGLM"))
openmp(n = 10)
```

```{r fixed22, error=TRUE, warning=FALSE}
tmbdata22f <- list(Y = as.matrix(df22.3 %>% select(y1:y3)),
                   T = df22.3$t,
                   delta = 80)
## ---------------------------------------------------------------------
obj_22f1 <- MakeADFun(data = tmbdata22f,
                      parameters = list(beta1 = 0, beta2 = 0,
                                        gama1 = 0, gama2 = 0,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_22f1$fn()
tictoc::tic()
opt_22f1 <- nlminb(obj_22f1$par, obj_22f1$fn, obj_22f1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_22f2 <- MakeADFun(data = tmbdata22f,
                      parameters = list(beta1 = -5, beta2 = -5,
                                        gama1 = 5, gama2 = 5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_22f2$fn()
tictoc::tic()
opt_22f2 <- nlminb(obj_22f2$par, obj_22f2$fn, obj_22f2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_22f3 <- MakeADFun(data = tmbdata22f,
                      parameters = list(beta1 = 5, beta2 = 5,
                                        gama1 = -5, gama2 = -5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_22f3$fn()
tictoc::tic()
opt_22f3 <- nlminb(obj_22f3$par, obj_22f3$fn, obj_22f3$gr)
tictoc::toc()
## ---------------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5),
      opt_22f1$par, opt_22f2$par, opt_22f3$par)
```

```{r fixed36, error=TRUE, warning=FALSE}
tmbdata36f <- list(Y = as.matrix(df36.3 %>% select(y1:y3)),
                   T = df36.3$t,
                   delta = 80)
## ---------------------------------------------------------------------
obj_36f1 <- MakeADFun(data = tmbdata36f,
                      parameters = list(beta1 = 0, beta2 = 0,
                                        gama1 = 0, gama2 = 0,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_36f1$fn()
tictoc::tic()
opt_36f1 <- nlminb(obj_36f1$par, obj_36f1$fn, obj_36f1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_36f2 <- MakeADFun(data = tmbdata36f,
                      parameters = list(beta1 = -5, beta2 = -5,
                                        gama1 = 5, gama2 = 5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_36f2$fn()
tictoc::tic()
opt_36f2 <- nlminb(obj_36f2$par, obj_36f2$fn, obj_36f2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_36f3 <- MakeADFun(data = tmbdata36f,
                      parameters = list(beta1 = 5, beta2 = 5,
                                        gama1 = -5, gama2 = -5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_36f3$fn()
tictoc::tic()
opt_36f3 <- nlminb(obj_36f3$par, obj_36f3$fn, obj_36f3$gr)
tictoc::toc()
## ---------------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5),
      opt_36f1$par, opt_36f2$par, opt_36f3$par)
```

```{r fixed38, error=TRUE, warning=FALSE}
tmbdata38f <- list(Y = as.matrix(df38.3 %>% select(y1:y3)),
                   T = df38.3$t,
                   delta = 80)
## ---------------------------------------------------------------------
obj_38f1 <- MakeADFun(data = tmbdata38f,
                      parameters = list(beta1 = 0, beta2 = 0,
                                        gama1 = 0, gama2 = 0,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_38f1$fn()
tictoc::tic()
opt_38f1 <- nlminb(obj_38f1$par, obj_38f1$fn, obj_38f1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_38f2 <- MakeADFun(data = tmbdata38f,
                      parameters = list(beta1 = -5, beta2 = -5,
                                        gama1 = 5, gama2 = 5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_38f2$fn()
tictoc::tic()
opt_38f2 <- nlminb(obj_38f2$par, obj_38f2$fn, obj_38f2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_38f3 <- MakeADFun(data = tmbdata38f,
                      parameters = list(beta1 = 5, beta2 = 5,
                                        gama1 = -5, gama2 = -5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_38f3$fn()
tictoc::tic()
opt_38f3 <- nlminb(obj_38f3$par, obj_38f3$fn, obj_38f3$gr)
tictoc::toc()
## ---------------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5),
      opt_38f1$par, opt_38f2$par, opt_38f3$par)
```

```{r fixed40, error=TRUE, warning=FALSE}
tmbdata40f <- list(Y = as.matrix(df40.3 %>% select(y1:y3)),
                   T = df40.3$t,
                   delta = 80)
## ---------------------------------------------------------------------
obj_40f1 <- MakeADFun(data = tmbdata40f,
                      parameters = list(beta1 = 0, beta2 = 0,
                                        gama1 = 0, gama2 = 0,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_40f1$fn()
tictoc::tic()
opt_40f1 <- nlminb(obj_40f1$par, obj_40f1$fn, obj_40f1$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_40f2 <- MakeADFun(data = tmbdata40f,
                      parameters = list(beta1 = -5, beta2 = -5,
                                        gama1 = 5, gama2 = 5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_40f2$fn()
tictoc::tic()
opt_40f2 <- nlminb(obj_40f2$par, obj_40f2$fn, obj_40f2$gr)
tictoc::toc()
## ---------------------------------------------------------------------
obj_40f3 <- MakeADFun(data = tmbdata40f,
                      parameters = list(beta1 = 5, beta2 = 5,
                                        gama1 = -5, gama2 = -5,
                                        w1 = 1, w2 = 1),
                      DLL = "multiGLM",
                      hessian = TRUE, silent = TRUE)
obj_40f3$fn()
tictoc::tic()
opt_40f3 <- nlminb(obj_40f3$par, obj_40f3$fn, obj_40f3$gr)
tictoc::toc()
## ---------------------------------------------------------------------
cbind(c(-2, -1.5, 1.2, 1, 3, 5),
      opt_40f1$par, opt_40f2$par, opt_40f3$par)
```

### fitting the models

```{r strategy22, error=TRUE, warning=FALSE}
## var(abs(c(-2, -1.5, 1.2, 1, 3, 5) - opt_22f1$par))/4
tmbpars22.3.1 <- list(beta1 = opt_22f1$par['beta1'],
                      beta2 = opt_22f1$par['beta2'],
                      gama1 = opt_22f1$par['gama1'],
                      gama2 = opt_22f1$par['gama2'],
                      w1 = opt_22f1$par['w1'],
                      w2 = opt_22f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.1), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
obj_22.3.1 <- MakeADFun(data = tmbdata22.3,
                        parameters = tmbpars22.3.1,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.3.1$fn()
tictoc::tic()
opt_22.3.1 <- nlminb(obj_22.3.1$par, obj_22.3.1$fn, obj_22.3.1$gr)
tictoc::toc()
sdr_22.3.1 <- sdreport(obj_22.3.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.3.1$par)
```

```{r strategy36, error=TRUE, warning=FALSE}
## var(abs(c(-2, -1.5, 1.2, 1, 3, 5) - opt_36f1$par))/4
tmbpars36.3.1 <- list(beta1 = opt_36f1$par['beta1'],
                      beta2 = opt_36f1$par['beta2'],
                      gama1 = opt_36f1$par['gama1'],
                      gama2 = opt_36f1$par['gama2'],
                      w1 = opt_36f1$par['w1'],
                      w2 = opt_36f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.1), 4),
                      rhoZ = rep(atanh(0), 6))
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
obj_36.3.1 <- MakeADFun(data = tmbdata36.3,
                        parameters = tmbpars36.3.1,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.3.1$fn()
tictoc::tic()
opt_36.3.1 <- nlminb(obj_36.3.1$par, obj_36.3.1$fn, obj_36.3.1$gr)
tictoc::toc()
sdr_36.3.1 <- sdreport(obj_36.3.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.3.1$par)
```

```{r strategy38, error=TRUE, warning=FALSE}
## var(abs(c(-2, -1.5, 1.2, 1, 3, 5) - opt_38f1$par))/4
tmbpars38.3.1 <- list(beta1 = opt_38f1$par['beta1'],
                      beta2 = opt_38f1$par['beta2'],
                      gama1 = opt_38f1$par['gama1'],
                      gama2 = opt_38f1$par['gama2'],
                      w1 = opt_38f1$par['w1'],
                      w2 = opt_38f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.1), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
obj_38.3.1 <- MakeADFun(data = tmbdata38.3,
                        parameters = tmbpars38.3.1,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.3.1$fn()
tictoc::tic()
opt_38.3.1 <- nlminb(obj_38.3.1$par, obj_38.3.1$fn, obj_38.3.1$gr)
tictoc::toc()
sdr_38.3.1 <- sdreport(obj_38.3.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.3.1$par)
```

```{r strategy40, error=TRUE, warning=FALSE}
## var(abs(c(-2, -1.5, 1.2, 1, 3, 5) - opt_40f1$par))/4
tmbpars40.3.1 <- list(beta1 = opt_40f1$par['beta1'],
                      beta2 = opt_40f1$par['beta2'],
                      gama1 = opt_40f1$par['gama1'],
                      gama2 = opt_40f1$par['gama2'],
                      w1 = opt_40f1$par['w1'],
                      w2 = opt_40f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.1), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
obj_40.3.1 <- MakeADFun(data = tmbdata40.3,
                        parameters = tmbpars40.3.1,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.3.1$fn()
tictoc::tic()
opt_40.3.1 <- nlminb(obj_40.3.1$par, obj_40.3.1$fn, obj_40.3.1$gr)
tictoc::toc()
sdr_40.3.1 <- sdreport(obj_40.3.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.3.1$par)
```

```{r strategy22.2, error=TRUE, warning=FALSE}
tmbpars22.3.2 <- list(beta1 = opt_22f1$par['beta1'],
                      beta2 = opt_22f1$par['beta2'],
                      gama1 = opt_22f1$par['gama1'],
                      gama2 = opt_22f1$par['gama2'],
                      w1 = opt_22f1$par['w1'],
                      w2 = opt_22f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
obj_22.3.2 <- MakeADFun(data = tmbdata22.3,
                        parameters = tmbpars22.3.2,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.3.2$fn()
tictoc::tic()
opt_22.3.2 <- nlminb(obj_22.3.2$par, obj_22.3.2$fn, obj_22.3.2$gr)
tictoc::toc()
sdr_22.3.2 <- sdreport(obj_22.3.2)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.3.2$par)

```
```{r strategy36.2, error=TRUE, warning=FALSE}
tmbpars36.3.2 <- list(beta1 = opt_36f1$par['beta1'],
                      beta2 = opt_36f1$par['beta2'],
                      gama1 = opt_36f1$par['gama1'],
                      gama2 = opt_36f1$par['gama2'],
                      w1 = opt_36f1$par['w1'],
                      w2 = opt_36f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(0), 6))
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
obj_36.3.2 <- MakeADFun(data = tmbdata36.3,
                        parameters = tmbpars36.3.2,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.3.2$fn()
tictoc::tic()
opt_36.3.2 <- nlminb(obj_36.3.2$par, obj_36.3.2$fn, obj_36.3.2$gr)
tictoc::toc()
sdr_36.3.2 <- sdreport(obj_36.3.2)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.3.2$par)
```

```{r strategy38.2, error=TRUE, warning=FALSE}
tmbpars38.3.2 <- list(beta1 = opt_38f1$par['beta1'],
                      beta2 = opt_38f1$par['beta2'],
                      gama1 = opt_38f1$par['gama1'],
                      gama2 = opt_38f1$par['gama2'],
                      w1 = opt_38f1$par['w1'],
                      w2 = opt_38f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
obj_38.3.2 <- MakeADFun(data = tmbdata38.3,
                        parameters = tmbpars38.3.2,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.3.2$fn()
tictoc::tic()
opt_38.3.2 <- nlminb(obj_38.3.2$par, obj_38.3.2$fn, obj_38.3.2$gr)
tictoc::toc()
sdr_38.3.2 <- sdreport(obj_38.3.2)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.3.2$par)
```

```{r strategy40.2, error=TRUE, warning=FALSE}
tmbpars40.3.2 <- list(beta1 = opt_40f1$par['beta1'],
                      beta2 = opt_40f1$par['beta2'],
                      gama1 = opt_40f1$par['gama1'],
                      gama2 = opt_40f1$par['gama2'],
                      w1 = opt_40f1$par['w1'],
                      w2 = opt_40f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
obj_40.3.2 <- MakeADFun(data = tmbdata40.3,
                        parameters = tmbpars40.3.2,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.3.2$fn()
tictoc::tic()
opt_40.3.2 <- nlminb(obj_40.3.2$par, obj_40.3.2$fn, obj_40.3.2$gr)
tictoc::toc()
sdr_40.3.2 <- sdreport(obj_40.3.2)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.3.2$par)
```

```{r strategy22.3, error=TRUE, warning=FALSE}
tmbpars22.3.3 <- list(beta1 = opt_22f1$par['beta1'],
                      beta2 = opt_22f1$par['beta2'],
                      gama1 = opt_22f1$par['gama1'],
                      gama2 = opt_22f1$par['gama2'],
                      w1 = opt_22f1$par['w1'],
                      w2 = opt_22f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(1), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
obj_22.3.3 <- MakeADFun(data = tmbdata22.3,
                        parameters = tmbpars22.3.3,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.3.3$fn()
tictoc::tic()
opt_22.3.3 <- nlminb(obj_22.3.3$par, obj_22.3.3$fn, obj_22.3.3$gr)
tictoc::toc()
sdr_22.3.3 <- sdreport(obj_22.3.3)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.3.3$par)
```

```{r strategy36.3, error=TRUE, warning=FALSE}
tmbpars36.3.3 <- list(beta1 = opt_36f1$par['beta1'],
                      beta2 = opt_36f1$par['beta2'],
                      gama1 = opt_36f1$par['gama1'],
                      gama2 = opt_36f1$par['gama2'],
                      w1 = opt_36f1$par['w1'],
                      w2 = opt_36f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(1), 4),
                      rhoZ = rep(atanh(0), 6))
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
obj_36.3.3 <- MakeADFun(data = tmbdata36.3,
                        parameters = tmbpars36.3.3,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.3.3$fn()
tictoc::tic()
opt_36.3.3 <- nlminb(obj_36.3.3$par, obj_36.3.3$fn, obj_36.3.3$gr)
tictoc::toc()
sdr_36.3.3 <- sdreport(obj_36.3.3)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.3.3$par)
```

```{r strategy38.3, error=TRUE, warning=FALSE}
tmbpars38.3.3 <- list(beta1 = opt_38f1$par['beta1'],
                      beta2 = opt_38f1$par['beta2'],
                      gama1 = opt_38f1$par['gama1'],
                      gama2 = opt_38f1$par['gama2'],
                      w1 = opt_38f1$par['w1'],
                      w2 = opt_38f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(1), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
obj_38.3.3 <- MakeADFun(data = tmbdata38.3,
                        parameters = tmbpars38.3.3,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.3.3$fn()
tictoc::tic()
opt_38.3.3 <- nlminb(obj_38.3.3$par, obj_38.3.3$fn, obj_38.3.3$gr)
tictoc::toc()
sdr_38.3.3 <- sdreport(obj_38.3.3)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.3.3$par)
```

```{r strategy40.3, error=TRUE, warning=FALSE}
tmbpars40.3.3 <- list(beta1 = opt_40f1$par['beta1'],
                      beta2 = opt_40f1$par['beta2'],
                      gama1 = opt_40f1$par['gama1'],
                      gama2 = opt_40f1$par['gama2'],
                      w1 = opt_40f1$par['w1'],
                      w2 = opt_40f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(1), 4),
                      rhoZ = rep(atanh(0), 4))
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
obj_40.3.3 <- MakeADFun(data = tmbdata40.3,
                        parameters = tmbpars40.3.3,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.3.3$fn()
tictoc::tic()
opt_40.3.3 <- nlminb(obj_40.3.3$par, obj_40.3.3$fn, obj_40.3.3$gr)
tictoc::toc()
sdr_40.3.3 <- sdreport(obj_40.3.3)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.3.3$par)
```

```{r computingres}
probs22f <- datasimuF(J=3e4,
                      beta=opt_22f1$par[1:2],
                      gamma=opt_22f1$par[3:4],
                      w=opt_22f1$par[5:6])[, 3:5]
res22.3 <- rowSums(
    df22.3[, 6:8]-df22.3[, 6:8]*probs22f
)
var(res22.3)/4
##----------------------------------------------------------------------
probs36f <- datasimuF(J=3e4,
                      beta=opt_36f1$par[1:2],
                      gamma=opt_36f1$par[3:4],
                      w=opt_36f1$par[5:6])[, 3:5]
res36.3 <- rowSums(
    df36.3[, 6:8]-df36.3[, 6:8]*probs36f
)
var(res36.3)/4
##----------------------------------------------------------------------
probs38f <- datasimuF(J=3e4,
                      beta=opt_38f1$par[1:2],
                      gamma=opt_38f1$par[3:4],
                      w=opt_38f1$par[5:6])[, 3:5]
res38.3 <- rowSums(
    df38.3[, 6:8]-df38.3[, 6:8]*probs38f
)
var(res38.3)/4
##----------------------------------------------------------------------
probs40f <- datasimuF(J=3e4,
                      beta=opt_40f1$par[1:2],
                      gamma=opt_40f1$par[3:4],
                      w=opt_40f1$par[5:6])[, 3:5]
res40.3 <- rowSums(
    df40.3[, 6:8]-df40.3[, 6:8]*probs40f
)
var(res40.3)/4
```

```{r strategy22.4, error=TRUE, warning=FALSE}
tmbpars22.3.4 <- list(beta1 = opt_22f1$par['beta1'],
                      beta2 = opt_22f1$par['beta2'],
                      gama1 = opt_22f1$par['gama1'],
                      gama2 = opt_22f1$par['gama2'],
                      w1 = opt_22f1$par['w1'],
                      w2 = opt_22f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(2*0.1), 4))
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
obj_22.3.4 <- MakeADFun(data = tmbdata22.3,
                        parameters = tmbpars22.3.4,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.3.4$fn()
tictoc::tic()
opt_22.3.4 <- nlminb(obj_22.3.4$par, obj_22.3.4$fn, obj_22.3.4$gr)
tictoc::toc()
sdr_22.3.4 <- sdreport(obj_22.3.4)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.3.4$par)
```

```{r strategy36.4, error=TRUE, warning=FALSE}
tmbpars36.3.4 <- list(beta1 = opt_36f1$par['beta1'],
                      beta2 = opt_36f1$par['beta2'],
                      gama1 = opt_36f1$par['gama1'],
                      gama2 = opt_36f1$par['gama2'],
                      w1 = opt_36f1$par['w1'],
                      w2 = opt_36f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(2*0.1), 6))
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
obj_36.3.4 <- MakeADFun(data = tmbdata36.3,
                        parameters = tmbpars36.3.4,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.3.4$fn()
tictoc::tic()
opt_36.3.4 <- nlminb(obj_36.3.4$par, obj_36.3.4$fn, obj_36.3.4$gr)
tictoc::toc()
sdr_36.3.4 <- sdreport(obj_36.3.4)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.3.4$par)
```

```{r strategy38.4, error=TRUE, warning=FALSE}
tmbpars38.3.4 <- list(beta1 = opt_38f1$par['beta1'],
                      beta2 = opt_38f1$par['beta2'],
                      gama1 = opt_38f1$par['gama1'],
                      gama2 = opt_38f1$par['gama2'],
                      w1 = opt_38f1$par['w1'],
                      w2 = opt_38f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(2*0.1), 4))
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
obj_38.3.4 <- MakeADFun(data = tmbdata38.3,
                        parameters = tmbpars38.3.4,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.3.4$fn()
tictoc::tic()
opt_38.3.4 <- nlminb(obj_38.3.4$par, obj_38.3.4$fn, obj_38.3.4$gr)
tictoc::toc()
sdr_38.3.4 <- sdreport(obj_38.3.4)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.3.4$par)
```

```{r strategy40.4, error=TRUE, warning=FALSE}
tmbpars40.3.4 <- list(beta1 = opt_40f1$par['beta1'],
                      beta2 = opt_40f1$par['beta2'],
                      gama1 = opt_40f1$par['gama1'],
                      gama2 = opt_40f1$par['gama2'],
                      w1 = opt_40f1$par['w1'],
                      w2 = opt_40f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = rep(log(0.5), 4),
                      rhoZ = rep(atanh(2*0.1), 4))
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
obj_40.3.4 <- MakeADFun(data = tmbdata40.3,
                        parameters = tmbpars40.3.4,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.3.4$fn()
tictoc::tic()
opt_40.3.4 <- nlminb(obj_40.3.4$par, obj_40.3.4$fn, obj_40.3.4$gr)
tictoc::toc()
sdr_40.3.4 <- sdreport(obj_40.3.4)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.3.4$par)
```

```{r strategy22.5, error=TRUE, warning=FALSE}
tmbpars22.3.5 <- list(beta1 = opt_22f1$par['beta1'],
                      beta2 = opt_22f1$par['beta2'],
                      gama1 = opt_22f1$par['gama1'],
                      gama2 = opt_22f1$par['gama2'],
                      w1 = opt_22f1$par['w1'],
                      w2 = opt_22f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.5), log(0.6), log(0.7), log(0.8)),
                      rhoZ = c(atanh(0.3/sqrt(0.5*0.6)),
                               atanh(0.3/sqrt(0.7*0.8)),
                               atanh(0.2/sqrt(0.5*0.7)),
                               atanh(0.2/sqrt(0.6*0.8))))
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
obj_22.3.5 <- MakeADFun(data = tmbdata22.3,
                        parameters = tmbpars22.3.5,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.3.5$fn()
tictoc::tic()
opt_22.3.5 <- nlminb(obj_22.3.5$par, obj_22.3.5$fn, obj_22.3.5$gr)
tictoc::toc()
sdr_22.3.5 <- sdreport(obj_22.3.5)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5))),
      opt_22.3.5$par)
```

```{r strategy36.5, error=TRUE, warning=FALSE}
tmbpars36.3.5 <- list(beta1 = opt_36f1$par['beta1'],
                      beta2 = opt_36f1$par['beta2'],
                      gama1 = opt_36f1$par['gama1'],
                      gama2 = opt_36f1$par['gama2'],
                      w1 = opt_36f1$par['w1'],
                      w2 = opt_36f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.5), log(0.6), log(0.7), log(0.8)),
                      rhoZ = c(atanh(0.5/sqrt(0.5*0.6)),
                               atanh(0.5/sqrt(0.7*0.8)),
                               atanh(0.2/sqrt(0.5*0.7)),
                               atanh(0.2/sqrt(0.6*0.8)),
                               atanh(0.3/sqrt(0.5*0.8)),
                               atanh(0.3/sqrt(0.6*0.7))))
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
obj_36.3.5 <- MakeADFun(data = tmbdata36.3,
                        parameters = tmbpars36.3.5,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.3.5$fn()
tictoc::tic()
opt_36.3.5 <- nlminb(obj_36.3.5$par, obj_36.3.5$fn, obj_36.3.5$gr)
tictoc::toc()
sdr_36.3.5 <- sdreport(obj_36.3.5)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_36.3.5$par)
```

```{r strategy38.5, error=TRUE, warning=FALSE}
tmbpars38.3.5 <- list(beta1 = opt_38f1$par['beta1'],
                      beta2 = opt_38f1$par['beta2'],
                      gama1 = opt_38f1$par['gama1'],
                      gama2 = opt_38f1$par['gama2'],
                      w1 = opt_38f1$par['w1'],
                      w2 = opt_38f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.5), log(0.6), log(0.7), log(0.8)),
                      rhoZ = c(atanh(0.3/sqrt(0.5*0.6)),
                               atanh(0.3/sqrt(0.7*0.8)),
                               atanh(0.2/sqrt(0.5*0.8)),
                               atanh(0.2/sqrt(0.6*0.7))))
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
obj_38.3.5 <- MakeADFun(data = tmbdata38.3,
                        parameters = tmbpars38.3.5,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.3.5$fn()
tictoc::tic()
opt_38.3.5 <- nlminb(obj_38.3.5$par, obj_38.3.5$fn, obj_38.3.5$gr)
tictoc::toc()
sdr_38.3.5 <- sdreport(obj_38.3.5)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.4), atanh(2 * 0.2),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_38.3.5$par)
```

```{r strategy40.5, error=TRUE, warning=FALSE}
tmbpars40.3.5 <- list(beta1 = opt_40f1$par['beta1'],
                      beta2 = opt_40f1$par['beta2'],
                      gama1 = opt_40f1$par['gama1'],
                      gama2 = opt_40f1$par['gama2'],
                      w1 = opt_40f1$par['w1'],
                      w2 = opt_40f1$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.5), log(0.6), log(0.7), log(0.8)),
                      rhoZ = c(atanh(0.2/sqrt(0.5*0.7)),
                               atanh(0.2/sqrt(0.6*0.8)),
                               atanh(0.3/sqrt(0.5*0.8)),
                               atanh(0.3/sqrt(0.6*0.7))))
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
obj_40.3.5 <- MakeADFun(data = tmbdata40.3,
                        parameters = tmbpars40.3.5,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.3.5$fn()
tictoc::tic()
opt_40.3.5 <- nlminb(obj_40.3.5$par, obj_40.3.5$fn, obj_40.3.5$gr)
tictoc::toc()
sdr_40.3.5 <- sdreport(obj_40.3.5)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(1), log(1), log(0.5), log(0.5),
        atanh(0.2/sqrt(0.5)), atanh(0.1/sqrt(0.5)),
        atanh(0.3/sqrt(0.5)), atanh(0.2/sqrt(0.5))),
      opt_40.3.5$par)
```

### new vcov

```{r newdfs}
newvcov <- matrix(c(0.4, 0.15, 0.05, 0.2,
                    0.15, 0.4, 0.2, 0.05,
                    0.05, 0.2, 0.25, 0.1,
                    0.2, 0.05, 0.1, 0.25), 4, 4) 
set.seed(110301)
df22.4 <- datasimu22(J=3e4, S=newvcov)
set.seed(110302)
df36.4 <- datasimu36(J=3e4, S=newvcov)
set.seed(110303)
df38.4 <- datasimu38(J=3e4, S=newvcov)
set.seed(110401)
df40.4 <- datasimu40(J=3e4, S=newvcov)
```

```{r fixed.4, error=TRUE, warning=FALSE}
dyn.load(dynlib("multiGLM"))
openmp(n = 10)
##----------------------------------------------------------------------
tmbdata22.4f <- list(Y = as.matrix(df22.4 %>% select(y1:y3)),
                     T = df22.4$t,
                     delta = 80)
obj_22.4f <- MakeADFun(data = tmbdata22.4f,
                       parameters = list(beta1 = 0, beta2 = 0,
                                         gama1 = 0, gama2 = 0,
                                         w1 = 1, w2 = 1),
                       DLL = "multiGLM",
                       hessian = TRUE, silent = TRUE)
obj_22.4f$fn()
tictoc::tic()
opt_22.4f <- nlminb(obj_22.4f$par, obj_22.4f$fn, obj_22.4f$gr)
tictoc::toc()
cbind(c(-2, -1.5, 1.2, 1, 3, 5), opt_22.4f$par)
##----------------------------------------------------------------------
tmbdata36.4f <- list(Y = as.matrix(df36.4 %>% select(y1:y3)),
                     T = df36.4$t,
                     delta = 80)
obj_36.4f <- MakeADFun(data = tmbdata36.4f,
                       parameters = list(beta1 = 0, beta2 = 0,
                                         gama1 = 0, gama2 = 0,
                                         w1 = 1, w2 = 1),
                       DLL = "multiGLM",
                       hessian = TRUE, silent = TRUE)
obj_36.4f$fn()
tictoc::tic()
opt_36.4f <- nlminb(obj_36.4f$par, obj_36.4f$fn, obj_36.4f$gr)
tictoc::toc()
cbind(c(-2, -1.5, 1.2, 1, 3, 5), opt_36.4f$par)
##----------------------------------------------------------------------
tmbdata38.4f <- list(Y = as.matrix(df38.4 %>% select(y1:y3)),
                     T = df38.4$t,
                     delta = 80)
obj_38.4f <- MakeADFun(data = tmbdata38.4f,
                       parameters = list(beta1 = 0, beta2 = 0,
                                         gama1 = 0, gama2 = 0,
                                         w1 = 1, w2 = 1),
                       DLL = "multiGLM",
                       hessian = TRUE, silent = TRUE)
obj_38.4f$fn()
tictoc::tic()
opt_38.4f <- nlminb(obj_38.4f$par, obj_38.4f$fn, obj_38.4f$gr)
tictoc::toc()
cbind(c(-2, -1.5, 1.2, 1, 3, 5), opt_38.4f$par)
##----------------------------------------------------------------------
tmbdata40.4f <- list(Y = as.matrix(df40.4 %>% select(y1:y3)),
                     T = df40.4$t,
                     delta = 80)
obj_40.4f <- MakeADFun(data = tmbdata40.4f,
                       parameters = list(beta1 = 0, beta2 = 0,
                                         gama1 = 0, gama2 = 0,
                                         w1 = 1, w2 = 1),
                       DLL = "multiGLM",
                       hessian = TRUE, silent = TRUE)
obj_40.4f$fn()
tictoc::tic()
opt_40.4f <- nlminb(obj_40.4f$par, obj_40.4f$fn, obj_40.4f$gr)
tictoc::toc()
cbind(c(-2, -1.5, 1.2, 1, 3, 5), opt_40.4f$par)
```

```{r strategy22.6, error=TRUE, warning=FALSE}
tmbdata22.4 <- list(
    Y = as.matrix(df22.4 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df22.4$t,
    delta = 80)
tmbpars22.4.1 <- list(beta1 = opt_22.4f$par['beta1'],
                      beta2 = opt_22.4f$par['beta2'],
                      gama1 = opt_22.4f$par['gama1'],
                      gama2 = opt_22.4f$par['gama2'],
                      w1 = opt_22.4f$par['w1'],
                      w2 = opt_22.4f$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.2), log(0.3), log(0.4), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.2*0.3)),
                               atanh(0.2/sqrt(0.4*0.5)),
                               atanh(0.1/sqrt(0.2*0.4)),
                               atanh(0.1/sqrt(0.3*0.5))))
dyn.load(dynlib("multiGLMM_22"))
openmp(n = 10)
obj_22.4.1 <- MakeADFun(data = tmbdata22.4,
                        parameters = tmbpars22.4.1,
                        DLL = "multiGLMM_22",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_22.4.1$fn()
tictoc::tic()
opt_22.4.1 <- nlminb(obj_22.4.1$par, obj_22.4.1$fn, obj_22.4.1$gr)
tictoc::toc()
sdr_22.4.1 <- sdreport(obj_22.4.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(0.4), log(0.4), log(0.25), log(0.25),
        atanh(0.15/0.4), atanh(0.1/0.25),
        atanh(0.05/sqrt(0.4*0.25)), atanh(0.05/sqrt(0.4*0.25))),
      opt_22.4.1$par)
```

```{r strategy36.6, error=TRUE, warning=FALSE}
tmbdata36.4 <- list(
    Y = as.matrix(df36.4 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df36.4$t,
    delta = 80)
tmbpars36.4.1 <- list(beta1 = opt_36.4f$par['beta1'],
                      beta2 = opt_36.4f$par['beta2'],
                      gama1 = opt_36.4f$par['gama1'],
                      gama2 = opt_36.4f$par['gama2'],
                      w1 = opt_36.4f$par['w1'],
                      w2 = opt_36.4f$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.2), log(0.3), log(0.4), log(0.5)),
                      rhoZ = c(atanh(0.2/sqrt(0.2*0.3)),
                               atanh(0.2/sqrt(0.4*0.5)),
                               atanh(0.1/sqrt(0.2*0.4)),
                               atanh(0.1/sqrt(0.3*0.5)),
                               atanh(0.2/sqrt(0.2*0.5)),
                               atanh(0.2/sqrt(0.3*0.4))))
dyn.load(dynlib("multiGLMM_36"))
openmp(n = 10)
obj_36.4.1 <- MakeADFun(data = tmbdata36.4,
                        parameters = tmbpars36.4.1,
                        DLL = "multiGLMM_36",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_36.4.1$fn()
tictoc::tic()
opt_36.4.1 <- nlminb(obj_36.4.1$par, obj_36.4.1$fn, obj_36.4.1$gr)
tictoc::toc()
sdr_36.4.1 <- sdreport(obj_36.4.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(0.4), log(0.4), log(0.25), log(0.25),
        atanh(0.15/0.4), atanh(0.1/0.25),
        atanh(0.05/sqrt(0.4*0.25)), atanh(0.05/sqrt(0.4*0.25)),
        atanh(0.2/sqrt(0.4*0.25)), atanh(0.2/sqrt(0.4*0.25))),
      opt_36.4.1$par)
```

```{r strategy38.6, error=TRUE, warning=FALSE}
tmbdata38.4 <- list(
    Y = as.matrix(df38.4 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df38.4$t,
    delta = 80)
tmbpars38.4.1 <- list(beta1 = opt_38.4f$par['beta1'],
                      beta2 = opt_38.4f$par['beta2'],
                      gama1 = opt_38.4f$par['gama1'],
                      gama2 = opt_38.4f$par['gama2'],
                      w1 = opt_38.4f$par['w1'],
                      w2 = opt_38.4f$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.2), log(0.3), log(0.4), log(0.5)),
                      rhoZ = c(atanh(0.1/sqrt(0.2*0.3)),
                               atanh(0.1/sqrt(0.4*0.5)),
                               atanh(0.2/sqrt(0.2*0.5)),
                               atanh(0.2/sqrt(0.3*0.4))))
dyn.load(dynlib("multiGLMM_38"))
openmp(n = 10)
obj_38.4.1 <- MakeADFun(data = tmbdata38.4,
                        parameters = tmbpars38.4.1,
                        DLL = "multiGLMM_38",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_38.4.1$fn()
tictoc::tic()
opt_38.4.1 <- nlminb(obj_38.4.1$par, obj_38.4.1$fn, obj_38.4.1$gr)
tictoc::toc()
sdr_38.4.1 <- sdreport(obj_38.4.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(0.4), log(0.4), log(0.25), log(0.25),
        atanh(0.15/0.4), atanh(0.1/0.25),
        atanh(0.2/sqrt(0.4*0.25)), atanh(0.2/sqrt(0.4*0.25))),
      opt_38.4.1$par)
```

```{r strategy40.6, error=TRUE, warning=FALSE}
tmbdata40.4 <- list(
    Y = as.matrix(df40.4 %>% select(y1:y3)),
    Z = bdiag(replicate(3e4, rep(1, 2), simplify = FALSE)),
    T = df40.4$t,
    delta = 80)
tmbpars40.4.1 <- list(beta1 = opt_40.4f$par['beta1'],
                      beta2 = opt_40.4f$par['beta2'],
                      gama1 = opt_40.4f$par['gama1'],
                      gama2 = opt_40.4f$par['gama2'],
                      w1 = opt_40.4f$par['w1'],
                      w2 = opt_40.4f$par['w2'],
                      R = matrix(0, nrow = 3e4, ncol = 4),
                      logs2 = c(log(0.2), log(0.3), log(0.4), log(0.5)),
                      rhoZ = c(atanh(0.1/sqrt(0.2*0.4)),
                               atanh(0.1/sqrt(0.3*0.5)),
                               atanh(0.2/sqrt(0.2*0.5)),
                               atanh(0.2/sqrt(0.3*0.4))))
dyn.load(dynlib("multiGLMM_40"))
openmp(n = 10)
obj_40.4.1 <- MakeADFun(data = tmbdata40.4,
                        parameters = tmbpars40.4.1,
                        DLL = "multiGLMM_40",
                        random = "R",
                        hessian = TRUE, silent = TRUE)
obj_40.4.1$fn()
tictoc::tic()
opt_40.4.1 <- nlminb(obj_40.4.1$par, obj_40.4.1$fn, obj_40.4.1$gr)
tictoc::toc()
sdr_40.4.1 <- sdreport(obj_40.4.1)
cbind(c(-2, -1.5, 1.2, 1, 3, 5,
        log(0.4), log(0.4), log(0.25), log(0.25),
        atanh(0.05/sqrt(0.4*0.25)), atanh(0.05/sqrt(0.4*0.25)),
        atanh(0.2/sqrt(0.4*0.25)), atanh(0.2/sqrt(0.4*0.25))),
      opt_40.4.1$par)
```

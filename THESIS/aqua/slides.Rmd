---
title: "Modeling the cumulative incidence function of clustered competing
        risk data: \\newline
        a multinomial GLMM approach"
subtitle: master thesis defense
author: Henrique Laureano ([.github.io](https://henriquelaureano.github.io))
date: \today
institute: LEG @ UFPR
classoption: [aspectratio=169]
output:
  beamer_presentation:
    includes:
      in_header: beamerheader.txt
---

# Data

### Clustered competing risk data

Key terms:

+ \textcolor{AlertOrange}{Clustered}:
  groups with a dependence structure (e.g. families);

+ Causes \textcolor{AlertOrange}{competing} by *something*.

\bigskip
Something?

\begin{columns}
 \column{5cm}
  \begin{itemize}
  \item \textbf{Failure} of an industrial or electronic component;
 \end{itemize}
 \column{6.25cm}
  \begin{itemize}
   \item \textbf{Occurence} or \textbf{cure} of a disease or some
         biological process;
   \end{itemize}
 \column{4cm}
  \begin{itemize}
   \item \textbf{Progress} of a patient clinic state.
  \end{itemize}
\end{columns}

\bigskip
Independent of the application, always the same framework

\begin{tabular}{lc*{3}{>{\columncolor[gray]{0.8}}c}cr}
 Cluster & ID & Cause 1 & Cause 2 & Censorship & Time & Feature\\
 \hline
 1     & 1  & Yes     & No       & No        & 10   & A\\
 1     & 2  & No      & No       & Yes       &  8   & A\\
 2     & 1  & No      & No       & Yes       &  7   & B\\
 2     & 2  & No      & Yes      & No        &  5   & A\\
\end{tabular}

### Big picture: Failure time data

\bigskip
####
\begin{center}
 \scalebox{0.9}{
  \begin{tikzpicture}
   \begin{pgfonlayer}{nodelayer}
    \node [style=circle] (2) at (-17.5, 5.5) {0};
    \node [style=circle] (3) at (-13.5, 5.5) {1};
    \node [style=circle] (7) at (-7.5, 5.5) {1};
    \node [style=circle] (9) at (-7.5, 4.5) {2};
    \node [style=none] (11) at (-7.5, 3.5) {$\vdots$};
    \node [style=circle] (12) at (-7.5, 2.5) {$m$};
    \node [style=circle] (14) at (-12.25, 4) {0};
    \node [style=circle] (22) at (-6, 3.5) {0};
    \node [style=circle] (23) at (-2, 3.5) {2};
    \node [style=circle] (25) at (-4, 5.5) {1};
    \node [style=none] (27) at (-17, 5.5) {};
    \node [style=none] (28) at (-14, 5.5) {};
    \node [style=none] (29) at (-11.75, 4.25) {};
    \node [style=none] (30) at (-8, 5.5) {};
    \node [style=none] (31) at (-8, 4.5) {};
    \node [style=none] (32) at (-8, 2.5) {};
    \node [style=none] (33) at (-5.5, 3.5) {};
    \node [style=none] (34) at (-4.5, 5.25) {};
    \node [style=none] (35) at (-2.5, 3.5) {};
    \node [style=none] (36) at (-11.75, 4) {};
    \node [style=none] (37) at (-11.75, 3.75) {};
    \node [style=none] (38) at (-5.5, 3.75) {};
    \node [style=none] (39) at (-2.5, 3.75) {};
    \node [style=none] (40) at (-3.5, 5.25) {};
    \node [style=none] (44) at (-15.5, 6.75) {{\large
                                               Failure time process}};
    \node [style=none] (45) at (-10, 6.75) {{\large
                                             Competing risk process}};
    \node [style=none] (47) at (-4, 6.75) {{\large Multistate process}};
   \end{pgfonlayer}
   \begin{pgfonlayer}{edgelayer}
	\draw [style=1side] (27.center) to (28.center);
	\draw [style=1side] (37.center) to (32.center);
	\draw [style=1side] (40.center) to (39.center);
	\draw [style=1side] (33.center) to (35.center);
	\draw [style=2side] (38.center) to (34.center);
	\draw [style=1side] (36.center) to (31.center);
	\draw [style=1side] (29.center) to (30.center);
   \end{pgfonlayer}
  \end{tikzpicture}
 }
\end{center}

\bigskip
\begin{columns}
 \column{4cm}
  \textit{Same methodologies, different names.}
  \column{9cm}
   \begin{description}
    \item[Survival analysis] Industrial life testing;
    \item[Reliability analysis] Biomedical studies.
   \end{description}
\end{columns}

\bigskip
\includegraphics[height=0.3cm]{logo/twitter.png}
A comprehensive reference is

###

#### Modeling framework

We have to choose which \textcolor{UniBlue}{scale} we model the
\textbf{survival experience}.\newline
Usually, the

\bigskip
\(\text{\textcolor{UniBlue}{hazard} (failure rate)
        \textcolor{UniBlue}{scale}}: \quad
  \lambda(t \mid \text{features}) =
  \lambda_{0}(t) \times c(\text{features})\).

### In the competing risk setting \(\dots\)

a more attractive possibility is to work on the
\textcolor{UniBlue}{probability scale}, focusing on the cause-specific

```{r cif, echo=FALSE, fig.height=2, fig.width=4}
pacman::p_load(tidyverse, ## you need the pacman's package
               ggplot2)
t <- seq(30, 79.5, by = 0.5)
delta <- 80
u <- c(0, 0)
eta <- c(0, 0)
beta <- c(-2, -1.5)
gamma <- c(1.2, 1)
w <- c(3, 5)
risk1 <- exp(beta[1] + u[1])
risk2 <- exp(beta[2] + u[2])
level <- 1 +  risk1 + risk2
risklevel1 <- risk1/level
risklevel2 <- risk2/level
traj1 <- pnorm(w[1] * atanh(2 * t/delta - 1) - gamma[1] - eta[1])
traj2 <- pnorm(w[2] * atanh(2 * t/delta - 1) - gamma[2] - eta[2])
cif1 <- risklevel1 * traj1
cif2 <- risklevel2 * traj2
df <- as.data.frame(cbind(t, cif1, cif2))
df <- df %>% pivot_longer(cols = cif1:cif2,
                          names_to = "cif", values_to = "value")
ggplot(df, aes(t, value, group = cif, color = cif)) +
    geom_line(size = 1.5) +
    labs(x = "Time", y = "Incidence",
         title = 'Cumulative Incidence Function (CIF)') +
    scale_color_manual(values = c("#0096c8", "#262626"),
                       labels = c("Cause 1", "Cause 2")) +
    theme(legend.title = element_blank(),
          legend.text = element_text(size = 9),
          axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          plot.title = element_text(
              size = 10,
              margin = unit(c(t = 0, r = 0, b = 2, l = 0), 'mm')), 
          axis.title.x = element_text(
              size = 9,
              margin = unit(c(t = 2, r = 0, b = 0, l = 0), "mm")),
          axis.title.y = element_text(
              size = 9,
              margin = unit(c(t = 0, r = 2, b = 0, l = 0), "mm")))
```

i.e.

\(\text{CIF} = \mathbb{P}[~\text{failure time} \leq t,
                          ~\text{a given cause} \mid \text{features}~]\)

# Application

### Cancer incidence in twins

\begin{columns}
 \column{8.5cm}
  \centering
   \includegraphics[width=\textwidth]{figures/twins.jpg}
 \column{5.25cm}
  Clustered competing risks data\newline
  \hspace*{.5cm}\rotatebox[origin=c]{180}{$\Lsh$}
  Clusters? Families\newline
  \hspace*{1.35cm}\rotatebox[origin=c]{180}{$\Lsh$}Family studies\newline
  \hspace*{2.1cm}\rotatebox[origin=c]{180}{$\Lsh$}
  \textcolor{UniBlue}{Twins data}
\end{columns}
\[
 \text{Family studies}~\Rightarrow~
 \text{\color{UniBlue}{within-family dependence}}
\]
That may reflect

+ Disease \textbf{heritability};
  
+ The impact of shared \textbf{environmental effects};
  
  + **Parental effects**:
    continuity of the phenotype across generations.

# Model

### Our contribution: a hierarchical approach

Thinking on two competing causes\newline
\(\dots\) for the outcome \(y_{ijt}\) of a subject \(i\), family \(j\),
in the time \(t\), we have
\[
 \begin{aligned}
  y_{ijt} \mid
  \underbrace{\{u_{1j}, u_{2j}, \eta_{1j}, \eta_{2j}\}}_{
  \substack{\text{\color{UniBlue}{latent effects}}}
  } & \sim
  \text{Multinomial}(p_{1ijt}, p_{2ijt}, p_{3ijt})\\
  \begin{bmatrix} u_{1j}\\ u_{2j}\\ \eta_{1j}\\ \eta_{2j} \end{bmatrix}
  & \sim
  \parbox{2cm}{\centering Multivariate Normal}
  \left(
   \begin{bmatrix} 0\\ 0\\ 0\\ 0 \end{bmatrix},
   \begin{bmatrix}
    \sigma_{u_{1}}^{2}&
    \sigma_{u_{1}, u_{2}}&
    \sigma_{u_{1}, \eta_{1}}&
    \sigma_{u_{1}, \eta_{2}}\\
   &\sigma_{u_{2}}^{2}&
    \sigma_{u_{2}, \eta_{1}}&
    \sigma_{u_{2}, \eta_{2}}\\
  &&\sigma_{\eta_{1}}^{2}&
    \sigma_{\eta_{1}, \eta_{2}}\\
 &&&\sigma_{\eta_{2}}^{2}
   \end{bmatrix}
  \right)\\  
  p_{ {\color{UniBlue}{k}} ijt} &=
  \frac{\partial \text{CIF}}{\partial t}\\
  & = \frac{\partial}{\partial t}
  \underbrace{
   \pi_{\color{UniBlue}{k}}(X, u_{1}, u_{2} \mid \bm{\beta})}_{
   \substack{\text{\color{UniBlue}{cluster-specific}}\\
             \text{\color{UniBlue}{risk level}}}}
  \underbrace{\Phi[w_{\color{UniBlue}{k}} g(t) -
                   X^{\top}\bm{\gamma}_{\color{UniBlue}{k}} -
                   \eta_{\color{UniBlue}{k}}]}_{
   \substack{\text{\color{UniBlue}{cluster-specific}}\\
             \text{\color{UniBlue}{failure time trajectory}}}},
 \end{aligned}
\]
\({\color{UniBlue}{k}} = 1, 2\).

# Contributions \& challenges

### Contributions \& challenges

+ A clear and simpler modeling structure;

+ **There is no free lunch**\newline
  Computational challenges overcame via an\newline
  efficient implementation and estimation routines,
  the \textcolor{UniBlue}{TMB};

+ The data is very simple,\newline
  we just know the outcome (**yes** or **no**);

+ We have to be able to build the \textcolor{UniBlue}{CIF} curves;

+ And accommodate the
  \textcolor{UniBlue}{within-family dependence} properly,\newline
  that can happen in different manners;

+ \(\dots\)

# Template Model Builder

### TMB: Template Model Builder

Quickly implement complex random effect models through simple
\texttt{C++} templates.\
The \texttt{R} package combines

+ \texttt{CppAD}: \texttt{C++} automatic differentiation;

+ \texttt{Eigen}: templated matrix-vector library;

+ \texttt{CHOLMOD}: sparse matrix routines available from \texttt{R};

to obtain an efficient implementation of the applied Laplace
approximation with exact derivatives.

Also, key features are

+ automatic sparseness detection;

+ parallelism through \texttt{BLAS};

+ parallel user templates.

# Simulation study

# Results

# Final considerations

# References

### Thanks for watching and have a great day

Special thanks to

\bigskip
\begin{columns}
 \column{1.5cm}
  \centering\includegraphics{logo/ppgmne-logo.png}
 \column{13.75cm}
  {\large \textbf{PPGMNE}}\newline
  Programa de Pós-Graduação em\newline
  Métodos Numéricos em Engenharia
\end{columns}

\bigskip
\begin{columns}
 \column{2cm}
  \includegraphics[height=2cm]{logo/capes.jpg}
 \column{3cm}
  \includegraphics[height=2cm]{logo/ufpr.png}
 \column{4.5cm}
  Joint work with
  \vspace{0.2cm}\newline
  Wagner H. Bonat\newline
  \url{http://leg.ufpr.br/~wagner}
 \column{4.75cm}
  \textcolor{white}{Joint work with}
  \vspace{0.2cm}\newline
  Paulo Justiniano Ribeiro Jr.\newline
  \url{http://leg.ufpr.br/~paulojus}
\end{columns}

\vfill
\includegraphics[height=0.3cm]{logo/twitter.png}
\href{https://twitter.com/hap_laureano}{\text{@hap\_laureano}}

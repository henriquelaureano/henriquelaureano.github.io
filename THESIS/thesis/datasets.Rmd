## simulating data, my way

```{r echo=FALSE}
library(knitr)
opts_chunk$set(fig.path = "figures/")
```

```{r}
pacman::p_load(mvtnorm, ## rmvnorm()
               mc2d, ## rmultinomial()
               tidyverse,
               patchwork)
## why not library()?
## with p_load(), if the package isn't installed,
## install_packages() is automatically loaded
```

```{r datasimucif, fig.height=3.75}
cif <- function() {
    t <- seq(30, 79.5, by = 0.5)
    delta <- 80
    u <- c(0, 0)
    eta <- c(0, 0)
    beta <- c(-2, -1.5)
    gamma <- c(1.2, 1)
    w <- c(3, 5)
    risk1 <- exp(beta[1] + u[1])
    risk2 <- exp(beta[2] + u[2])
    level <- 1 +  risk1 + risk2
    risklevel1 <- risk1/level
    risklevel2 <- risk2/level
    traj1 <- pnorm(w[1] * atanh(2 * t/delta - 1) - gamma[1] - eta[1])
    traj2 <- pnorm(w[2] * atanh(2 * t/delta - 1) - gamma[2] - eta[2])
    cif1 <- risklevel1 * traj1
    cif2 <- risklevel2 * traj2
    out <- as.data.frame(cbind(t, cif1, cif2))
    out <- out %>% pivot_longer(cols = cif1:cif2,
                                names_to = "cif", values_to = "value")
    return(out)
}
dfcif <- cif()
dcif <- function() {
    t <- seq(30, 79.5, by = 0.5)
    delta <- 80
    u <- c(0, 0)
    eta <- c(0, 0)
    beta <- c(-2, -1.5)
    gamma <- c(1.2, 1)
    w <- c(3, 5)
    risk1 <- exp(beta[1] + u[1])
    risk2 <- exp(beta[2] + u[2])
    level <- 1 +  risk1 + risk2
    risklevel1 <- risk1/level
    risklevel2 <- risk2/level
    dtraj1 <- w[1] * delta/(2 * t * (delta - t)) *
        dnorm(w[1] * atanh(2 * t/delta - 1) - gamma[1] - eta[1])
    dtraj2 <- w[2] * delta/(2 * t * (delta - t)) *
        dnorm(w[2] * atanh(2 * t/delta - 1) - gamma[2] - eta[2])
    dcif1 <- risklevel1 * dtraj1
    dcif2 <- risklevel2 * dtraj2
    out <- as.data.frame(cbind(t, dcif1, dcif2))
    out <- out %>% pivot_longer(cols = dcif1:dcif2,
                                names_to = "dcif", values_to = "value")
    return(out)
}
dfdcif <- dcif()
p1 <- ggplot(dfcif, aes(t, value, group = cif)) +
    geom_line(aes(linetype = cif)) +
    labs(x = "Time", y = NULL) +
    scale_linetype_discrete(labels = c("CIF 1", "CIF 2")) +
    theme_minimal()+
    theme(legend.position = "bottom",
          legend.title = element_blank(),
          legend.text = element_text(size = 11),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.x = element_text(
              size = 11,
              margin = unit(c(t = 3, r = 0, b = 0, l = 0), "mm")))
p2 <- ggplot(dfdcif, aes(t, value, group = dcif)) +
    geom_line(aes(linetype = dcif)) +
    labs(x = "Time", y = NULL) +
    scale_linetype_discrete(labels = c("dCIF 1", "dCIF 2")) +
    theme_minimal()+
    theme(legend.position = "bottom",
          legend.title = element_blank(),
          legend.text = element_text(size = 11),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          axis.title.x = element_text(
              size = 11,
              margin = unit(c(t = 3, r = 0, b = 0, l = 0), "mm")))
p1+p2
```

```{r datasimu_cache,cache=TRUE}
datasimu <- function(J, t, Z, S,
                     delta=80,
                     beta=c(-2, -1.5), gamma=c(1.2, 1), w=c(3, 5)){
    out <- tibble(i=rep(seq(2), times=J),
                  j=rep(seq(J), each=2), p1=NA, p2=NA, p3=NA)
    K <- dim(S)[1]/2+1
    ladim <- 2*(K-1) ## latent effects dimension
    B <- mvtnorm::rmvnorm(J, mean=rep(0, ladim), sigma=S)
    R <- Z%*%B
    risk1 <- exp(beta[1]+R[, 1])
    risk2 <- exp(beta[2]+R[, 2])
    level <- 1+risk1+risk2
    out$p1 <- risk1/level*w[1]*delta/(2*t*(delta-t))*
        dnorm(w[1]*atanh(2*t/delta-1)-gamma[1]-R[, 3])
    out$p2 <- risk2/level*w[2]*delta/(2*t*(delta-t))*
        dnorm(w[2]*atanh(2*t/delta-1)-gamma[2]-R[, 4])
    out <- out%>%mutate(p3=1-p1-p2)
    y <- mc2d::rmultinomial(2*J, 1, prob=out%>%select(p1:p3))
    out <- out%>%
        bind_cols(as_tibble(y))%>%
        rename(y1=V1, y2=V2, y3=V3)
    return(out)
}

J <- 50e3
t <- rep(seq(from=30, to=79.5, by=0.5), length.out=2*J)
Z <- Matrix::bdiag(replicate(J, rep(1, 2), simplify=FALSE))
S <- matrix(c(1.0, 0.4, 0.5, 0.4,
              0.4, 1.0, 0.4, 0.3,
              0.5, 0.4, 1.0, 0.4,
              0.4, 0.3, 0.4, 1.0), nrow=4, ncol=4)
dat <- datasimu(J=J, t=t, Z=Z, S=S)
```

```{r datasimu,fig.width=7.5,fig.height=3}
dat_longp <- dat%>%
    pivot_longer(cols=p1:p3, names_to='p_label', values_to='p_value')%>%
    mutate(p_label=forcats::fct_recode(p_label,
                                       'Cause 1'='p1',
                                       'Cause 2'='p2',
                                       'Censorship'='p3'))
dat_longy <- dat%>%
    pivot_longer(cols=y1:y3, names_to='y_label', values_to='y_value')%>%
    filter(y_value==1)

ggplot(dat_longp, aes(x=p_value))+
    geom_histogram(binwidth=0.0025, color='black', fill='white')+
    facet_wrap(~p_label, scales='free')+
    labs(x='Probability')+
    geom_label(data=data.frame(
                   label=paste0(
                       "Turns out in\n",
                       round(prop.table(table(dat_longy$y_label)), 3),
                       "%'s of data"),
                   p_label=levels(dat_longp$p_label)),
               mapping=aes(x=c(0.05, 0.0465, 0.95), y=Inf, label=label),
               vjust=1.5)+
    theme_minimal()+
    theme(strip.background=element_rect(colour='black', fill='white'),
          axis.text.y=element_blank(),
          axis.title.y=element_blank(),
          axis.title.x=element_text(
              margin=unit(c(t=3, r=0, b=0, l=0), 'mm')))

## theme(strip.text.x=element_text(size=12),
##       axis.text.x=element_text(size=11),
##       axis.title.x=element_text(
##           size=12,
##           margin=unit(c(t=3, r=0, b=0, l=0), 'mm')),
##       axis.title.y=element_text(
##           size=12,
##           margin=unit(c(t=0, r=3, b=0, l=0), 'mm')))

```

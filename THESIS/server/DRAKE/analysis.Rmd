---
title: A standard multinomial GLMM with random correlated intercepts
author: Henrique Laureano (.github.io)
date: "*Last modification on* `r Sys.time()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

## source

```{r}
source('functions.R')
```

## install.packages('pacman')

```{r}
pacman::p_load(Matrix, mvtnorm, mc2d, furrr, crayon, clisymbols, TMB,
               tictoc)
```

## overall defs

```{r}
future::plan(multicore);TMB::openmp(11)

J <- 3e4
Z <- Matrix::bdiag(replicate(J, rep(1, 2), simplify=FALSE))
R <- matrix(0, nrow=J, ncol=2)

beta <- c(-4, -3.5)
Sigma <- matrix(c(1.0, 0.25,
                  0.25, 0.5), nrow=2, ncol=2)
```

## data

```{r cache=TRUE}
y <- datasimu(
    J=J, beta=beta, Sigma=Sigma
)
prop.table(colSums(y))
```

## model

```{r}
dll <- 'GLMM';TMB::compile(paste0(dll, '.cpp'))

## the true ones
tt <- c(
    beta1=-4, beta2=-3.5,
    logs2.1=log(1), logs2.2=log(0.5),
    rhoZ=atanh( 0.25/(sqrt(1)*sqrt(0.5)) )
)
```

> eval.max=1e3 (default 200) and iter.max=500 (default 150), with
> logs2=0=rhoZ resulted in very bad variance estimates -> it took 15min

```{r cache=TRUE}
checkDLL(dll)
obj <- TMB::MakeADFun(data=list(Y=y, Z=Z),
                      parameters=list(beta1=0,
                                      beta2=0,
                                      logs2=c(log(0.1), log(0.1)),
                                      rhoZ=atanh(0.1),
                                      R=R),
                      DLL=dll,
                      random='R', hessian=TRUE, silent=TRUE)
tictoc::tic()
opt <- nlminb(obj$par,
              obj$fn,
              obj$gr)
tictoc::toc()
```

```{r cache=TRUE}
tictoc::tic()
sdr <- sdreport(obj)
tictoc::toc()
```

```{r cache=TRUE}
opt
summary(sdr, select='fixed')
summary(sdr, select='report')
obj$report()
nrow(summary(sdr, select='random'))
cbind(
    1:20,
    summary(sdr, select='random')[1:20, ], 
    summary(sdr, select='random')[30001:30020, ]
)
```

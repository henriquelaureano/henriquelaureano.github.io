---
title: A standard multinomial GLMM with random common intercept
author: Henrique Laureano (.github.io)
date: "*Last modification on* `r Sys.time()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r loading}
source('functions.R')

## install.packages('pacman')
pacman::p_load(Matrix, mvtnorm, mc2d, ## rmultinomial()
               furrr, ## future + purrr
               TMB, tictoc, tidyverse ## ggplot2() + dplyr()
               )

future::plan(multicore);TMB::openmp(11)
```

## uniGLMM

> TAKE-HOME MESSAGE: 

```{r uniGLMM}
J <- 250
cs <- 10
beta.mcie <- c(beta1=0.85, beta2=1.25)
sd <- sqrt(0.25)

set.seed(0858)
y <- datasimu.l1(J=J, cs=cs, beta=beta.mcie, sd=sd)
prop.table(colSums(y))

uniDLL <- 'uniGLMM';invisible(TMB::compile(paste0(uniDLL, '.cpp')))
## dyn.load(TMB::dynlib(uniDLL))
checkDLL(uniDLL)

Z <- modelZ(J=J, cs=cs)
u <- numeric(J)

obj <- TMB::MakeADFun(data=list(Y=y, Z=Z),
                      parameters=list(beta1=beta.mcie['beta1'],
                                      beta2=beta.mcie['beta2'],
                                      logsd=log(sd),
                                      u=u),
                      DLL=uniDLL, ## ----------------------------------
                      random='u', hessia=TRUE, silent=TRUE)
opt <- with(obj,
            nlminb(par, fn, gr))

bind_cols(
    bind_rows(
        opt$par, c(beta.mcie, logsd=log(sd))
    ),
    label=c('model', 'data')
)
sdr <- sdreport(obj)
summary(sdr, select='fixed')
summary(sdr, select='report')
summary(summary(sdr, select='random'))

prof.beta1 <- TMB::tmbprofile(obj, name='beta1', trace=FALSE)
prof.beta2 <- TMB::tmbprofile(obj, name='beta2', trace=FALSE)
prof.logsd <- TMB::tmbprofile(obj, name='logsd', trace=FALSE)

par(mfrow=c(1, 3))
plot(prof.beta1);abline(v=beta.mcie['beta1'], lty=2, col='red')
plot(prof.beta2);abline(v=beta.mcie['beta2'], lty=2, col='red')
plot(prof.logsd);abline(v=log(sd), lty=2, col='red')
```

## uni2GLMM

```{r uni2GLMM}
sd <- c(sqrt(0.25), sqrt(0.15))

set.seed(0859)
y <- datasimu.l1(J=J, cs=cs, beta=beta.mcie, sd=sd)
prop.table(colSums(y))

uni2DLL <- 'uni2GLMM';invisible(TMB::compile(paste0(uni2DLL, '.cpp')))
## dyn.load(TMB::dynlib(uniDLL))
checkDLL(uni2DLL)

u1 <- numeric(J)
u2 <- numeric(J)

obj <- TMB::MakeADFun(data=list(Y=y, Z=Z),
                      parameters=list(beta1=beta.mcie['beta1'],
                                      beta2=beta.mcie['beta2'],
                                      logsd=log(sd),
                                      u=u),
                      DLL=uniDLL, ## ----------------------------------
                      random='u', hessia=TRUE, silent=TRUE)
opt <- with(obj,
            nlminb(par, fn, gr))
```
